{extend name="common/edit_table" /}
{block name="content"}
{php}echo tpl_ueditor('');{/php}
<div class="layui-form-item">
    <label class="layui-form-label">导入挚能云商品</label>
    <div class="layui-input-block">
        <button class="layui-btn layui-btn-normal" id="addZnyGoods">导入</button>
        <input type="hidden" name="upload_zny_goods_id"  class="layui-input" value="{$info.upload_zny_goods_id??''}">
    </div>
</div>
<div class="layui-form-item" style="display:none">
    <label class="layui-form-label">商品分类</label>
    <div class="layui-input-block">
        <input name="store_id" id="store_id"  value="{$info.store_id??''}"  lay-ignore></input>
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">商品分类</label>
    <div class="layui-input-block">
        <select name="cat_id" id="cat_id" class="select2" lay-ignore></select>
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">名称</label>
    <div class="layui-input-block">
        <input autocomplete="off" type="text" name="name" lay-verify="required" placeholder="请输入名称" class="layui-input" value="{$info.name??''}">
    </div>
</div>
<div class="layui-form-item">
    <div class="layui-inline">
        <label class="layui-form-label">排序</label>
        <div class="layui-input-block">
            <input autocomplete="off" type="text" name="index" placeholder="请输入排序" class="layui-input" value="{$info.index??''}">
        </div>
    </div>
</div>
<div class="layui-form-item">
    <div class="layui-inline">
        <label class="layui-form-label">销售价</label>
        <div class="layui-input-block">
            <input autocomplete="off" type="text" name="price" placeholder="请输入销售价" class="layui-input" value="{$info.price??''}">
            <div class="layui-form-mid layui-word-aux">团长抽成为：<span id="leader_money"></span></div>
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">成本价</label>
        <div class="layui-input-block">
            <input autocomplete="off" type="text" name="cost_price" placeholder="请输入成本价" class="layui-input" value="{$info.cost_price??''}">
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">原价</label>
        <div class="layui-input-block">
            <input autocomplete="off" type="text" name="original_price" placeholder="请输入原价" class="layui-input" value="{$info.original_price??''}">
        </div>
    </div>
</div>
<div class="layui-form-item">
    <div class="layui-inline">
        <label class="layui-form-label">单位</label>
        <div class="layui-input-block">
            <input autocomplete="off" type="text" name="unit" placeholder="请输入单位" class="layui-input" value="{$info.unit??''}">
        </div>
    </div>
</div>
<div class="layui-form-item">
    <div class="layui-inline">
        <label class="layui-form-label">重量</label>
        <div class="layui-input-block">
            <input autocomplete="off" type="text" name="weight" placeholder="请输入重量" class="layui-input" value="{$info.weight??''}">
            <div class="layui-form-mid layui-word-aux" style="float:left;">如1KG，4斤，5g等等</div>
        </div>
    </div>
</div>

<div class="layui-form-item">
    <div class="layui-inline">
        <label class="layui-form-label">首页标签</label>
        <div class="layui-input-block">
            <input autocomplete="off" type="text" name="customer_tag" placeholder="请输入标签" class="layui-input" value="{$info.customer_tag??''}">
        </div>
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">单独配送开关</label>
    <div class="layui-input-block">
        <input type="radio" name="delivery_single" value="0" title="关闭" {$info.delivery_single ? "" : "checked"}>
        <input type="radio" name="delivery_single" value="1" title="开启" {$info.delivery_single ? "checked" :""}>
        <div class="layui-form-mid layui-word-aux" style="clear: both;">
            <p>开启单独配送后</p>
            <p>1、用户不能将该商品加入购物车，只支持立即购买</p>
            <p>2、用户下单时不能选择团点自提，只支持商家配送</p>
            <p>注：如果所有的商品都只支持商家配送，请进入顶部菜单【基础设置】，将菜单【系统设置-基础设置】中的配送方式设置为“仅配送”，此处建议关闭</p>
        </div>
    </div>
</div>
<div class="layui-form-item">
    <div class="layui-inline">
        <label class="layui-form-label">配送费设置</label>
        <div class="layui-form-item">
            <label class="layui-form-label">类型</label>
            <div class="layui-input-block">
                <input type="radio" name="delivery_fee_type" lay-filter="delivery_fee_type" value="0" title="不单独设置" {:isset($info.delivery_fee_type) && $info.delivery_fee_type != 0 ? '':"checked"}>
                <input type="radio" name="delivery_fee_type" lay-filter="delivery_fee_type" value="1" title="单独设置" {:isset($info.delivery_fee_type) && $info.delivery_fee_type == 1 ? "checked" : ''}>
            </div>
        </div>
        <div class="layui-form-item delivery_fee_type2" style="display: none;">
            <label class="layui-form-label">配送费</label>
            <div class="layui-input-block">
                <input autocomplete="off" type="text" name="delivery_fee" placeholder="请输入金额" class="layui-input" value="{$info.delivery_fee??''}">
                <div class="layui-form-mid layui-word-aux">￥</div>
            </div>
        </div>
    </div>
</div>
<div class="layui-form-item">
    <div class="layui-inline">
        <label class="layui-form-label">库存</label>
        <div class="layui-input-block">
            <input autocomplete="off" type="text" name="stock" placeholder="请输入库存" class="layui-input" value="{$info.stock??''}">
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">虚拟销量</label>
        <div class="layui-input-block">
            <input autocomplete="off" type="text" name="virtual_num" placeholder="请输入虚拟销量" class="layui-input" value="{$info.virtual_num??''}">
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">限购</label>
        <div class="layui-input-block">
            <input autocomplete="off" type="text" name="limit" placeholder="请输入限购数量" class="layui-input" value="{$info.limit??''}">
            <div class="layui-form-mid layui-word-aux">设置为0不限购，其他值为每人限制购买数量</div>
        </div>
    </div>
</div>
<div class="layui-form-item">
    <div class="layui-inline">
        <label class="layui-form-label">活动开始时间</label>
        <div class="layui-input-block">
            <input type="text" name="begin_time" id="begin_time" value="{$info.begin_time}"  placeholder="yyyy-MM-dd" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">活动结束时间</label>
        <div class="layui-input-block">
            <input type="text" name="end_time" id="end_time" value="{$info.end_time}"  placeholder="yyyy-MM-dd" autocomplete="off" class="layui-input">
        </div>
    </div>
</div>
<div class="layui-form-item">
    <div class="layui-inline">
        <label class="layui-form-label">计划配送时间</label>
        <div class="layui-input-block">
            <input type="text" name="send_time" id="send_time" value="{$info.send_time}"  placeholder="yyyy-MM-dd" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">预计送达时间</label>
        <div class="layui-input-block">
            <input type="text" name="receive_time" id="receive_time" value="{$info.receive_time}"  placeholder="yyyy-MM-dd" autocomplete="off" class="layui-input">
        </div>
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">首页显示图</label>
    <div class="layui-input-block">
        {php}echo tpl_form_field_image('home_pic', isset($info['home_pic'])?$info['home_pic']:'','/web/resource/images/nopic.jpg');{/php}
        <div class="layui-form-mid layui-word-aux">建议尺寸：220*180</div>
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">封面图</label>
    <div class="layui-input-block">
        {php}echo tpl_form_field_image('pic', isset($info['pic'])?$info['pic']:'','/web/resource/images/nopic.jpg');{/php}
        <div class="layui-form-mid layui-word-aux">建议尺寸：690*300</div>
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">主题二封面图</label>
    <div class="layui-input-block">
        {php}echo tpl_form_field_image('style_pic', isset($info['style_pic'])?$info['style_pic']:'','/web/resource/images/nopic.jpg');{/php}
        <div class="layui-form-mid layui-word-aux">建议尺寸：240*240</div>
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">轮播图</label>
    <div class="layui-input-block">
        {php}echo tpl_form_field_multi_image('pics', isset($info['pics'])?$info['pics']:'');{/php}
        <div class="layui-form-mid layui-word-aux">建议尺寸：750*750</div>
    </div>
</div>

<div class="layui-form-item">
    <label class="layui-form-label">小程序显示顺序</label>
    <div class="layui-input-block">
        <div class="layui-form-mid layui-word-aux">视频、详情图片或富文本商品详情，按顺序展示 </div>
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">视频</label>
    <div class="layui-input-block">
        {php}echo  tpl_form_field_video('video', isset($info['video'])?$info['video']:'');{/php}
        <video src="{$info['videosrc']??0}" controls="controls"></video>
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">服务内容</label>
    <div class="layui-input-block">
        <textarea name="service" placeholder="请输入服务内容" class="layui-textarea">{$info.service??''}</textarea>
        <div class="layui-form-mid layui-word-aux">例子：正品保障,极速发货,7天退换货。多个请使用英文逗号 <span class="layui-badge layui-bg-black">,</span> 分隔</div>
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">商品详情</label>
    <div class="layui-input-block">
        <div id="details"></div>
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">商品图片详情</label>
    <div class="layui-input-block">
        {php}echo tpl_form_field_multi_image('img_details', isset($info['img_details'])?$info['img_details']:'');{/php}
        <div class="layui-form-mid layui-word-aux">建议尺寸：690*300</div>
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">多规格</label>
    <div class="layui-input-block">
        <input type="radio" name="use_attr" value="1" title="开启" {$info.use_attr == 1 ?"checked":""}>
        <input type="radio" name="use_attr" value="0" title="关闭" {$info.use_attr != 1 ?"checked":""}>
    </div>
</div>

<div class="attr-setting">
    <div class="layui-form-item">
        <label class="layui-form-label">规格</label>
        <div class="layui-input-block">
            <div class="input-group ">
                <span class="input-group-addon">
                    分组名称
                </span>
                <input type="text" id="group_name" value="" class="form-control" autocomplete="off">
                <span class="input-group-btn">
                    <button class="btn btn-default" type="button" onclick="addGroup(this);">添加分组</button>
                </span>
            </div>
        </div>
    </div>
    {volist name="attrgroup_list" id="vo"}
    <div class="layui-form-item">
        <label class="layui-form-label"></label>
        <div class="layui-input-block">
            <div class="attr-group">
                <div class="group-title">
                    <label data-name="{$vo.name}" data-id="{$vo.id}">{$vo.name}</label>
                    <span class="group-del" data-id="{$vo.id}">X</span>
                </div>
                <div class="attrs">
                    {volist name="vo.attrs" id="attr"}
                    <div class="attr-item">
                            <span class="attr-item-name" data-name="{$attr.name}" data-id="{$attr.id}">
                                {$attr.name}
                            </span>
                        <span class="attr-item-del" data-id="{$attr.id}" data-group-id="{$vo.id}">
                                X
                            </span>
                    </div>
                    {/volist}
                    <div class="input-group attr-item">
                        <span class="input-group-addon">
                            规格值
                        </span>
                        <input type="text" value="" class="form-control" autocomplete="off">
                        <span class="input-group-btn">
                            <button class="btn btn-default" type="button" data-id="{$vo.id}" onclick="addAttr(this)">添加规格</button>
                        </span>
                    </div>
                    <div style="clear: both;"></div>
                </div>
            </div>
        </div>
    </div>

    {/volist}
    <style>

        .attr-group{
            border: 1px solid #ddd;
            padding: 5px;
            background: #fff;
        }
        .attr-item{
            margin-top: 10px;
            float: left;
        }
        .attr-item:not(:last-child){
            float: left;
            margin-right: 15px;
        }
        .attr-item:not(:last-child) .attr-item-name{
            background: #ddd;
            display: inline-block;
            padding: 7px 14px;
        }
        .attr-item:not(:last-child) .attr-item-del{
            border: 1px solid #eee;
            border-left: 0px;
            height: 34px;
            display: inline-block;
            line-height: 33px;
            margin-left: -4px;
            width: 25px;
            text-align: center;
            cursor: pointer;
        }
        .attr-item:not(:last-child) .attr-item-del:hover,.group-del:hover{
            background-color: #FF4C11;
            /*border: #FF4C11;*/
        }
        .group-del{
            cursor: pointer;
            background-color: #ddd;
            display: inline-block;
            border-radius: 10px;
            height: 20px;
            width: 20px;
            padding: 0 5px;
        }
    </style>
    <script>
        var attr_data = [];
        {volist name="attrgroup_list" id="vo"}
        var attrs = [];
        {volist name="vo.attrs" id="attr"}
            attrs[{$attr.id}]= '{$attr.name}';
        {/volist}
        attr_data[{$vo.id}] = {
            'name':'{$vo.name}',
            'attrs':attrs,
        };
            {/volist}
        function addGroup(e) {
            var group_name = $("#group_name").val();
            if (!group_name){
                return false;
            }
            if($('.group-title [data-name="'+group_name+'"]').length) {
                layer.msg('该分组已经存在',{icon: 5,anim: 6});
                return false;
            }
            $.post("{:adminurl('save','Cgoodsattrgroup')}",{name:group_name,goods_id:$('input[name=id]').val()},function (res) {
                if (typeof res == 'string'){
                    res = $.parseJSON(res);
                }
                if (res.code == 0) {
                    var id = res.data;
                    var html = `
                        <div class="layui-form-item">
                            <label class="layui-form-label"></label>
                            <div class="layui-input-block">
                                <div class="attr-group">
                                    <div class="group-title">
                                        <label data-name="${group_name}" data-id="${id}">${group_name}</label>
                                        <span class="group-del" data-id="${id}">X</span>
                                    </div>
                                    <div class="attrs">
                                        <div class="input-group attr-item">
                                            <span class="input-group-addon">
                                                规格值
                                            </span>
                                            <input type="text" value="" class="form-control" autocomplete="off">
                                            <span class="input-group-btn">
                                                <button class="btn btn-default" type="button" data-id="${id}" onclick="addAttr(this)">添加规格</button>
                                            </span>
                                        </div>
                                        <div style="clear: both;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                    $(e).parents('.layui-form-item').after(html);
                    $("#group_name").val('');
                    attr_data[id] = {'name':group_name,'attrs':[]}
                }else{
                    layer.msg(res.msg,{icon: 5,anim: 6});
                }
            })
        }

        function addAttr(e) {
            var $input = $(e).parents('.attr-item').find('input');
            var attr_name = $input.val();
            if (!attr_name){
                return false;
            }
            if($('.attr-item [data-name="'+attr_name+'"]',$(e).parents('.attrs')).length) {
                layer.msg('该规格已经存在',{icon: 5,anim: 6});
                return false;
            }
            var group_id = $(e).data('id');
            $.post("{:adminurl('save','Cgoodsattr')}",{name:attr_name,goodsattrgroup_id:group_id},function (res) {
                if (typeof res == 'string') {
                    res = $.parseJSON(res);
                }
                console.log(res);
                if (res.code == 0) {
                    var id = res.data;

                    var html = `
                        <div class="attr-item">
                            <span class="attr-item-name" data-name="${attr_name}" data-id="${id}">
                                ${attr_name}
                            </span>
                            <span class="attr-item-del" data-id="${id}" data-group-id="${group_id}">
                                X
                            </span>
                        </div>
                        `;
                    $(e).parents('.attr-item').before(html);
                    $input.val('');
                    attr_data[group_id]['attrs'][id] = attr_name;
                }else{
                    layer.msg(res.msg,{icon: 5,anim: 6});
                }
            })
        }

        $(document).on('click','.attr-item-del',function () {
            var $this = $(this);
            var id = $this.data('id');
            $.post("{:adminurl('delete','Cgoodsattr')}",{ids:id},function (res) {
                if (typeof res == 'string') {
                    res = $.parseJSON(res);
                }
                if (res.code == 0) {
                    $this.parents('.attr-item').remove();
                    var group_id = $this.data('group-id');
                    delete attr_data[group_id]['attrs'][id];
                }else{
                    layer.msg(res.msg,{icon: 5,anim: 6});
                }
            })
        })
        $(document).on('click','.group-del',function () {
            var $this = $(this);
            var id = $this.data('id');
            $.post("{:adminurl('delete','Cgoodsattrgroup')}",{ids:id},function (res) {
                if (typeof res == 'string') {
                    res = $.parseJSON(res);
                }
                if (res.code == 0) {
                    $this.parents('.layui-form-item').remove();
                    delete attr_data[id];
                }else{
                    layer.msg(res.msg,{icon: 5,anim: 6});
                }
            })
        })
    </script>
    <div class="layui-form-item">
        <label class="layui-form-label">规格设置</label>
        <div class="layui-input-block">
            <!--工具栏-->
            <div class="tool-box">
                <div class="layui-btn-group">
                    <a href="javascript:;" id="btnRefresh" class="layui-btn layui-btn-primary layui-btn-sm">刷新</a>
                </div>
                <div class="layui-btn-group">
                    <a href="javascript:;" id="btnBatchPrice" class="layui-btn layui-btn-primary layui-btn-sm">修改价格</a>
                    <a href="javascript:;" id="btnBatchStock" class="layui-btn layui-btn-primary layui-btn-sm">修改库存</a>
                    <a href="javascript:;" id="btnBatchWeight" class="layui-btn layui-btn-primary layui-btn-sm">修改重量</a>
                </div>
                <div class="layui-btn-group">
                    <a href="javascript:;" id="btnChooseImg" class="layui-btn layui-btn-primary layui-btn-sm">选择图片</a>
                </div>
            </div>
            <!--数据表-操作列-->
            <script type="text/html" id="dataTool">
                <!--<a href="javascript:;" lay-event="del" class="layui-btn layui-btn-danger layui-btn-xs">删除</a>-->
                <a href="javascript:;" lay-event="edit" class="layui-btn layui-btn-xs">编辑</a>
            </script>
            <!--数据表-->
            <div class="table-box">
                <table class="layui-hide" id="laytable"></table>
            </div>
            <script type="text/html" id="dataPic">
                {{# if(d.pic){ }}
                <img style="width:50px;" src="{$_W['attachurl']}{{ d.pic }}">
                {{# } }}
            </script>
        </div>
        <script>
            $('#btnRefresh').click(function () {
                updatetable();
            });
            //检测数组包含函数
            function isContained(aa, bb) {
                if(!(aa instanceof Array) || !(bb instanceof Array) || ((aa.length < bb.length))) {
                    return false;
                }
                for (var i = 0; i < bb.length; i++) {
                    var flag = false;
                    for(var j = 0; j < aa.length; j++){
                        if(aa[j] == bb[i]){
                            flag = true;
                            break;
                        }
                    }
                    if(flag == false){
                        return flag;
                    }
                }

                return true;
            }
            function updatetable() {
                layui.use(['table'],function () {
                    var table = layui.table;
                    var origin = table.data.laytable;
                    // console.log(461+'初始数据');
                    // console.log(origin);
                    //数据
                    var data = [{
                        "stock":0,
                        "price":0,
                        "weight":0,
                        "code":'',
                        "pic":'',
                    }];
                    //列结构
                    var col_data = [
                        {type: 'numbers', fixed: 'left'},
                        {type: 'checkbox', fixed: 'left'},
                    ];
                    col_data.push({field: 'pic', width: 100, title: '封面图',toolbar: '#dataPic'});

                    for (var i in attr_data){
                        //规格分组名称作为一列
                        col_data.push({field: attr_data[i]['name'], width: 180, title: attr_data[i]['name'], sort: true,edit:false});
                        //一组规格
                        var attrs = attr_data[i]['attrs'];
                        var data_new = [];
                        var ids = [];
                        for (var j in data){
                            for(var a in attrs){
                                //新的数据行
                                var d = JSON.parse(JSON.stringify(data[j]));
                                d['ids'] = d['ids'] || [];
                                d[attr_data[i]['name']] = attrs[a];
                                d['ids'].push(a);
                                data_new.push(d);
                            }
                        }
                        data = JSON.parse(JSON.stringify(data_new));
                    }
                    if(JSON.stringify(origin) != '[]'){
                        //后台返回的数据没有 ids字段，只有attr_ids，需要先解析一遍
                        if(!origin[0].ids){
                            origin.forEach(function(cur2){
                                cur2.ids = [];
                                var ids = cur2.attr_ids.split(',');
                                ids.forEach(function (id) {
                                    if (id){
                                        cur2.ids.push(id);
                                    }
                                })
                            })
                        }
                        console.log(origin);
                        data.forEach(function(cur,index){
                            origin.every(function(cur2){
                                console.log(cur.ids,cur2.ids);
                                if(isContained(cur.ids , cur2.ids)){
                                    console.log('ininininininininin');
                                    data[index].stock = cur2.stock;
                                    data[index].price = cur2.price;
                                    data[index].weight = cur2.weight;
                                    data[index].code = cur2.code;
                                    return false;
                                }
                                return true;
                            })

                        })
                    }

                    col_data.push({field: 'stock', width: 100, title: '库存',edit:true});
                    col_data.push({field: 'price', width: 100, title: '单价',edit:true});
                    col_data.push({field: 'weight', width: 100, title: '重量',edit:true});
                    col_data.push({field: 'code', width: 100, title: '货号',edit:true});

                    table.reload('laytable', {
                        data: data,
                        cols:[col_data],
                    });
                })
            }
            layui.use(['table','form'],function () {
                var table = layui.table;
                var form = layui.form;
                table.render({
                    elem: '#laytable'
                    , data: {php}echo json_encode($attrsetting_list );{/php}
                    , cols: [[
                    {type: 'numbers', fixed: 'left'},
                    {type: 'checkbox', fixed: 'left'},
                    {field: 'pic', width: 100, title: '封面图', toolbar: '#dataPic',edit:true},
                    {volist name="attrgroup_list" id="vo"}
                    {field: '{$vo.name}', width: 180, title: '{$vo.name}', sort: true},
                    {/volist}
                    {field: 'stock', width: 100, title: '库存',edit:true},
                    {field: 'price', width: 100, title: '单价',edit:true},
                    {field: 'weight', width: 100, title: '重量',edit:true},
                    {field: 'code', width: 100, title: '货号',edit:true},
                    // {field: 'o', fixed: 'right', width: 200, title: '操作', toolbar: '#dataTool_attr'},
                ]]
                    // , page: true
                    , limit: 90
                    // , height: 'full-420',
                });

                //        批量修改单价
                $('#btnBatchPrice').click(function () {
                    var checkdata = table.checkStatus('laytable').data;
                    var data = [];
                    data = layui.table.data.laytable;
                    var cache = layui.table.cache.laytable;
                    if (checkdata.length > 0) {
                        layer.prompt({title: '价格（支持*0.8）'}, function (value, index, elem) {
                            var fun = function (value, value2) {
                                return value2
                            }

                            var patt = /^\d*\.{0,1}\d*$/;
                            if (patt.test(value)) {
                                fun = function (value, value2) {
                                    return parseFloat(value2).toFixed(2);
                                }
                            }
                            var patt2 = /^[\+\-\*\/]{1}\d*\.{0,1}\d*$/;
                            if (patt2.test(value)) {
                                fun = function (value, value2) {
                                    var v = eval(value + '' + value2);
                                    return parseFloat(v).toFixed(2);
                                }
                            }

                            for (var i in cache) {
                                if (cache[i]['LAY_CHECKED']) {
                                    data[cache[i]['LAY_TABLE_INDEX']]['price'] = fun(data[i]['price'], value);
                                }
                            }
                            table.reload('laytable', {
                                data: data,
                            });
                            layer.close(index);
                        });
                    } else {
                        layer.msg('请选择记录');
                    }
                })
                //        批量修改抢购数量
                $('#btnBatchStock').click(function () {
                    var checkdata = table.checkStatus('laytable').data;
                    var data = [];
                    data = layui.table.data.laytable;
                    var cache = layui.table.cache.laytable;
                    if (checkdata.length > 0) {
                        layer.prompt({title: '库存'}, function (value, index, elem) {
                            for (var i in cache) {
                                if (cache[i]['LAY_CHECKED']) {
                                    data[cache[i]['LAY_TABLE_INDEX']]['stock'] = value;
                                }
                            }
                            table.reload('laytable', {
                                data: data,
                            });
                            layer.close(index);
                        });
                    } else {
                        layer.msg('请选择记录');
                    }
                })
                //批量修改重量
                $('#btnBatchWeight').click(function () {
                    var checkdata = table.checkStatus('laytable').data;
                    var data = [];
                    data = layui.table.data.laytable;
                    var cache = layui.table.cache.laytable;
                    if (checkdata.length > 0) {
                        layer.prompt({title: '重量'}, function (value, index, elem) {
                            for (var i in cache) {
                                if (cache[i]['LAY_CHECKED']) {
                                    data[cache[i]['LAY_TABLE_INDEX']]['weight'] = value;
                                }
                            }
                            table.reload('laytable', {
                                data: data,
                            });
                            layer.close(index);
                        });
                    } else {
                        layer.msg('请选择记录');
                    }
                })
                //批量修改图片
                $('#btnChooseImg').click(function () {
                    var checkdata = table.checkStatus('laytable').data;
                    var data = [];
                    data = layui.table.data.laytable;
                    var cache = layui.table.cache.laytable;
                    if (checkdata.length > 0) {
                        require(["util"], function(util){
                            util.image('',function(url){
                                for (var i in cache) {
                                    if (cache[i]['LAY_CHECKED']) {
                                        data[cache[i]['LAY_TABLE_INDEX']]['pic'] = url.attachment;
                                    }
                                }
                                table.reload('laytable', {
                                    data: data,
                                });
                            },{'multiple':false});
                        });
                    } else {
                        layer.msg('请选择记录');
                    }
                })
            })
        </script>
    </div>

</div>

<script>
    function toggleSetting() {
        var use_attr = $('[name=use_attr]:checked').val();
        if (use_attr == 1) {
            $(".attr-setting").show();
        }else{
            $(".attr-setting").hide();
        }
    }
    toggleSetting();

    layui.use(['laydate'], function() {
        var laydate = layui.laydate;

        //日期
        laydate.render({
            elem: '#begin_time',
            type: 'datetime'
        });
        laydate.render({
            elem: '#end_time',
            type: 'datetime'
        });

        laydate.render({
            elem: '#send_time',
            type: 'datetime'
        });

        laydate.render({
            elem: '#receive_time',
            type: 'datetime'
        });
    });

    layui.use(['table','form'],function () {
        var table = layui.table;
        var form = layui.form;
        form.on('radio', function(data){
            if($(data.elem).is('[name=use_attr]')) {
                toggleSetting();
            }
        });
        // 新增界面、保存、取消事件
        form.on('submit', function(data){
            if(!$(data.elem).is('button')){
                return false;
            }
            var data = data.field;
            // data.attr_group = JSON.stringify(table.data.laytable_attr);
            data.attrs_data = JSON.stringify(attr_data);
            data.attr = JSON.stringify(table.data.laytable);
            data.details = data.editorValue;
            delete data.editorValue;
            if (data.price <= last_leader_money){
                layer.confirm('确认亏本销售，团长抽成['+last_leader_money+']-销售价['+data.price+']？', {
                    btn: ['确定提交','取消'] //按钮
                }, function(){
                    var url = "{:adminurl('save')}";
                    $.post(url,data,function(res){
                        if (typeof res == 'string'){
                            res = $.parseJSON(res);
                        }
                        if (res.code == 0) {
                            var index=parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                            parent.layer.msg('保存成功',{icon: 6,anim: 6});
                            parent.layui.table.reload('laytable',{});
                        }else{
                            layer.msg(res.msg,{icon: 5,anim: 6});
                        }
                    });
                });
            }else{
                var url = "{:adminurl('save')}";
                $.post(url,data,function(res){
                    if (typeof res == 'string'){
                        res = $.parseJSON(res);
                    }
                    if (res.code == 0) {
                        var index=parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                        parent.layer.msg('保存成功',{icon: 6,anim: 6});
                        parent.layui.table.reload('laytable',{});
                    }else{
                        layer.msg(res.msg,{icon: 5,anim: 6});
                    }
                });
            }
            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
        });
    });

    require(['select2'], function () {
        $('.select2').select2();
        $.get("{:adminurl('select','Ccategory')}", function (ret) {
            if (typeof ret == "string"){
                ret = JSON.parse(ret);
            }
            ret.unshift({id: '', text: '请选择分类'});
            ret.map(function (obj) {
                obj.keywords += obj.text.toPinYin() + obj.text.toPinYin(true);
                if(obj.id == "{$info.cat_id??''}"){
                    obj.selected = true;
                }
                return obj;
            });
            $('#cat_id').select2({
                data: ret,
            })
        })
    })
</script>

<blockquote class="layui-elem-quote">团长抽成设置</blockquote>
<div class="layui-form-item">
    <label class="layui-form-label">类型</label>
    <div class="layui-input-block">
        <input type="radio" name="leader_draw_type" lay-filter="leader_draw_type" value="0" title="不单独设置" {:isset($info.leader_draw_type) && $info.leader_draw_type != 0 ? '':"checked"}>
        <input type="radio" name="leader_draw_type" lay-filter="leader_draw_type" value="1" title="比率" {:isset($info.leader_draw_type) && $info.leader_draw_type == 1 ? "checked":''}>
        <input type="radio" name="leader_draw_type" lay-filter="leader_draw_type" value="2" title="固定金额" {:isset($info.leader_draw_type) && $info.leader_draw_type == 2 ? "checked" : ''}>
    </div>
</div>
<div class="layui-form-item leader_draw_type1" style="display: none;">
    <label class="layui-form-label">团长抽成比率</label>
    <div class="layui-input-block">
        <input autocomplete="off" type="text" name="leader_draw_rate" placeholder="请输入比率" class="layui-input" value="{$info.leader_draw_rate??''}">
        <div class="layui-form-mid layui-word-aux">%</div>
    </div>
</div>
<div class="layui-form-item leader_draw_type2" style="display: none;">
    <label class="layui-form-label">团长抽成金额</label>
    <div class="layui-input-block">
        <input autocomplete="off" type="text" name="leader_draw_money" placeholder="请输入金额" class="layui-input" value="{$info.leader_draw_money??''}">
        <div class="layui-form-mid layui-word-aux">￥</div>
    </div>
</div>
<style>
    .priceRed{
        color:red!important;
    }
</style>
<script>
    let ueconfig = {
        toolbars: [[
            'source', //源代码
            'preview', //预览
            'bold', //加粗
            'italic', //斜体
            'underline', //下划线
            'strikethrough', //删除线
            'forecolor', //字体颜色
            'backcolor', //背景色'
            'justifyleft', //居左对齐
            'justifyright', //居右对齐
            'justifycenter', //居中对齐
            'insertorderedlist', //有序列表
            'insertunorderedlist', //无序列表
            'blockquote', //引用
            'emotion', //表情
            'insertimage', //多图上传
            'insertvideo', //视频
            'link', //超链接
            'removeformat', //清除格式
            'rowspacingtop', //段前距
            'rowspacingbottom', //段后距
            'lineheight', //行间距
            'indent', //首行缩进
            'fontfamily', //字体
            'fontsize', //字号
            'paragraph', //段落格式
            'inserttable', //插入表格
            'deletetable', //删除表格
            'insertparagraphbeforetable', //”表格前插入行”
            'insertrow', //前插入行
            'deleterow', //删除行
            'insertcol', //前插入列
            'deletecol', //删除列
            'mergecells', //合并多个单元格
            'mergeright', //右合并单元格
            'mergedown', //下合并单元格
            'splittorows', //拆分成行
            'splittocols', //拆分成列
            'splittocells', //完全拆分单元格
            'anchor', //锚点
            'map', //Baidu地图
            'print', //打印
            'drafts', // 从草稿箱加载
            'fullscreen', //全屏
        ]]
    };
    var ue = null;
    var isEdit = {$is_edit};
    setTimeout(()=>{
        ue = UE.getEditor('details', ueconfig);
        ue.ready(function() {
            if (isEdit == 1) {
                ue.setContent(`{$info['details']}`);
            }
        });
    },2000)
    var leader_rate = {$leader_rate?:0};
    var leader_money= {$leader_money?:0};

    var goods_leader_type = 0;
    var goods_leader_rate = 0;
    var goods_leader_money= 0;

    var last_leader_money = 0;
    var last_price = 0;
    function updateLeaderMoney() {
        var price = $('input[name="price"]').val()
        var money = 0;

        last_price = price;

        if (goods_leader_type == 0){
            goods_leader_rate = leader_rate;
            goods_leader_money = leader_money;
        }else if (goods_leader_type == 1){
            goods_leader_money = 0;
            goods_leader_rate = $('input[name="leader_draw_rate"]').val();
        }else if (goods_leader_type == 2){
            goods_leader_money = $('input[name="leader_draw_money"]').val();
            goods_leader_rate = 0;
        }

        last_leader_money = money = price*goods_leader_rate/100-0 + (goods_leader_money-0);
        $('#leader_money').html(money.toFixed(2));
        if (money >= price){
            $('#leader_money').parent().addClass('priceRed')
        }else{
            $('#leader_money').parent().removeClass('priceRed')
        }
    }

    $('input[name="price"],input[name="leader_draw_rate"],input[name="leader_draw_money"]').on('change',function () {
        updateLeaderMoney();
    });
    layui.use(['element','form'], function() {
        var element = layui.element;
        var form = layui.form;
        var jq = layui.jquery;
        var type = $('input[name="leader_draw_type"]:checked').val();
        var delivery_fee_type = $('input[name="delivery_fee_type"]:checked').val();
        updateType(type);
        updateDeliveryFeeType(delivery_fee_type);

        form.on('radio(leader_draw_type)', function (data) {
            // console.log(data.elem); //得到radio原始DOM对象
            // console.log(data.value); //被点击的radio的value值
            var type = data.value;
            updateType(type)
        });
        function updateType(type) {
            if (type == 1) {
                $('.leader_draw_type2').hide();
                $('.leader_draw_type1').show();
            } else if(type == 2) {
                $('.leader_draw_type1').hide();
                $('.leader_draw_type2').show();
            }else{
                console.log(899);
                $('.leader_draw_type1').hide();
                $('.leader_draw_type2').hide();
            }

            goods_leader_type = type;
            updateLeaderMoney();
        }
        form.on('radio(delivery_fee_type)', function (data) {
            var type = data.value;
            updateDeliveryFeeType(type)
        });
        function updateDeliveryFeeType(type) {
            if (type == 0) {
                $('.delivery_fee_type2').hide();
            } else if (type == 1) {
                $('.delivery_fee_type2').show();
            }
        }
        var isAjaxIng = false;
        $('#addZnyGoods').click(function () {
            if (isAjaxIng) return false;
            layer.open({
                    type: 1,
                    content: '<div style="padding: 20px 20px 0 20px;"><input autocomplete="off" type="text" class="layui-input znygoodsid" placeholder="请输入挚能云商品id"></div>',
                    btn: ['确定','取消'],
                    yes: function(index, layero){
                        var goods_id = $('.znygoodsid',layero).val();
                        var url = "{:adminurl('downloadGoods')}";
                        var p = {
                            goods_id:goods_id
                        }
                        isAjaxIng = true;
                        var indexflag = layer.load(2);
                        $.post(url, p, function(data){
                            if (typeof data == 'string'){
                                data = $.parseJSON(data);
                            }
                            console.log(data);
                            if (data.code == 0) {
                                console.log(data.data);
                                var datas=data.data.data;
                                $('input[name="name"]').val(datas.goods_name);
                                $('input[name="price"]').val(datas.promotion_price);
                                $('input[name="cost_price"]').val(datas.cost_price);
                                $('input[name="original_price"]').val(datas.price);
                                $('input[name="stock"]').val(datas.stock);
                                $('input[name="virtual_num"]').val(datas.sales);
                                $('input[name="limit"]').val(datas.max_buy);
                                $('input[name="weight"]').val(datas.goods_weight);
                                $('input[name="upload_zny_goods_id"]').val(datas.goods_id);
                                js_tpl_form_field_image('pic',datas.img_arr[0],data.other);
                                js_tpl_form_field_multi_image('pics',datas.img_arr,data.other);
                                if (datas.description) {
                                    ue.ready(function() {
                                        ue.setContent(datas.description);
                                        layer.close(index);
                                        layer.close(indexflag);
                                        isAjaxIng = false;
                                    });
                                } else{
                                    layer.close(index);
                                    layer.close(indexflag);
                                    isAjaxIng = false;
                                }
                            }else{
                                layer.msg(data.msg,{icon: 5,anim: 6});
                                layer.close(index);
                                layer.close(indexflag);
                                isAjaxIng = false;
                            }
                        });
                    },
                    function(index){
                        layer.close(index);
                        isAjaxIng = false;
                    }
                });
        })

        function js_tpl_form_field_image (name, value = '', roots = '') {
            console.log(name + value + roots);
            var el = $(`input[name='${name}']`);
            console.log(el);
            el.parent().siblings('.input-group').remove();
            var str = `<div class="input-group">
            <input type="text" autocomplete="off" class="form-control" name="${name}" type="text" value="${value}">
                <span class="input-group-btn">
                    <button class="btn btn-default" onclick="showImageDialog(this);" type="button">
                        选择图片
                    </button>
                </span>
            </input>
        </div>
        <div class="input-group" style="margin-top:.5em;">
            <img class="img-responsive img-thumbnail" src="${roots + value}" width="150"/>
            <em class="close" onclick="deleteImage(this)" style="position:absolute; top: 0px; right: -14px;" title="删除这张图片">
                ×
            </em>
        </div>`;
            el.parent().parent().html(str);
        }
        function js_tpl_form_field_multi_image (name, value = [], roots = '') {
            console.log(name + value + roots);
            console.log(typeof value);
            var el = $(`input[value='${name}']`);
            console.log(el);
            el.parent().parent().siblings('.input-group').remove();
            var str = `
    <div class="input-group">
	<input type="text" class="form-control" readonly="readonly" value="" placeholder="批量上传图片" autocomplete="off">
	<span class="input-group-btn">
		<button class="btn btn-default" type="button" onclick="uploadMultiImage(this);">选择图片</button>
		<input type="hidden" value="${name}" />
	</span>
</div>
	<div class="input-group multi-img-details">`;

            for(let i=0; i < value.length; i++) {
                str+= `<div class="multi-item">
                    <img src="` + roots + value[i] + `" class="img-responsive img-thumbnail">
                    <input type="hidden" name="` + name + `[]" value="` + value[i] + `">
                    <em class="close" title="删除这张图片" onclick="deleteMultiImage(this)">×</em>
                </div>`;
            }
	str += `</div>`;
            el.parent().parent().parent().html(str);
        }
    });
</script>
{/block}