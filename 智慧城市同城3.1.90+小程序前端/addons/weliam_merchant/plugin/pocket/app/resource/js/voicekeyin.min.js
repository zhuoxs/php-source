var bcat;
var timmer=null;
if (!bcat) {
    bcat = {}
} (function(v) {
    var voice = {
        localId: "",
        serverId: ""
    };
    var timer;
    var recsecond = 0;
    v.voice_record_state = 0;
    v.playState = 0;
    v.canclerecord = function() {
        wx.stopRecord({
            success: function(res) {}
        });
        clearInterval(timer);
        recsecond = 0;
        v.resetrecord()
    };
    v.sumsecond = function() {
        recsecond += 1
    };
    v.showPlayUI = function(vstatus) {
        if (vstatus == 1) {
            v.voice_record_state = vstatus;
            $(".voice-record-volume-bg-p-span").addClass("voice-recording");
            $(".voice-record-bt-white-i").addClass("voice-record-bt-whitei-recording");
            $(".voice-record-bt-white").addClass("voice-record-bt-white-recording");
            $("#press-msg-tips").text("松开结束");
            $("#click-msg-tips").text("点击结束");
            $("#slide-btn-group").hide();
            $(".voice-record-button-local").hide()
        } else {
            if (vstatus == 2) {} else {
                if (vstatus == 3) {} else {
                    v.voice_record_state = vstatus;
                    $(".voice-record-volume-bg-p-span").removeClass("voice-recording");
                    $(".voice-record-bt-white-i").removeClass("voice-record-bt-whitei-recording");
                    $(".voice-record-bt-white").removeClass("voice-record-bt-white-recording");
                    $("#press-msg-tips").text("按住录音");
                    $("#click-msg-tips").text("点一下录音");
                    $("#slide-btn-group").show()
                }
            }
        }
    };
    v.startrecord = function() {
        wx.stopRecord();
        timer = setInterval("bcat.sumsecond()", 1000);
        wx.startRecord({
            success: function() {
                wx.onVoiceRecordEnd({
                    complete: function(res) {
                        clearInterval(timer);
                        voice.localId = res.localId;
                        $("#hidrecordTime").val(recsecond);
                        $("#voice-time-show").html(recsecond + '"');
                        voice.localId = res.localId;
                        recsecond = 0;
                        v.showPlayUI(2);
                        v.completevoic()
                    }
                });
                v.showPlayUI(1)
            },
            cancel: function() {
                clearInterval(timer);
                recsecond = 0
            },
            fail: function(res) {
                $(".temp-location-btn span").text("点击发送位置");
                layer.open({
                    content: "启动录音失败",
                    btn: ["好的", "取消"],
                    shadeClose: false,
                    yes: function() {
                        layer.closeAll()
                    },
                    no: function() {
                        layer.closeAll()
                    }
                })
            }
        })
    };
    v.stoprecord = function() {
        if (recsecond <= 1) {
            setTimeout("bcat.wxstop()", 500)
        } else {
            setTimeout("bcat.wxstop()", 100)
        }
    };
    v.wxstop = function() {
        wx.stopRecord({
            success: function(res) {
                clearInterval(timer);
                if (recsecond < 2) {
                    recsecond = 0;
                    $("#hidrecordTime").val("0");
                    v.showPlayUI(0);
					 alert("太短了，多说几句吧");
                    return
                }
                $("#hidrecordTime").val(recsecond);
                $("#voice-time-show").html(recsecond + '"');
                voice.localId = res.localId;
                recsecond = 0;
                v.showPlayUI(0);
                v.completevoic()
            }
        })
    };
    v.completevoic = function() {
        v.uploadrecord(voice.localId)
    };
    v.uploadrecord = function(locrecid) {
		
		wx.translateVoice({
		   localId: locrecid, // 需要识别的音频的本地Id，由录音相关接口获得
			isShowProgressTips: 1, // 默认为1，显示进度提示
			success: function (res) {
				var o=$("#hidrecordText").val();
				if(typeof(res.translateResult)!="undefined")
				{
					$("#"+o).val($("#"+o).val()+res.translateResult); // 语音识别的结果
					bcat.showPlayUI(0);
               	   layer.closeAll()
				}
			}
		});
    };
    v.resetrecord = function() {
        $("#voice-text-show").html("");
        $("#hidrecordId").val("");
        $("#hidrecordSerId").val("");
        $("#hidrecordTime").val("0");
        $("#hidrecordText").val("");
        v.showPlayUI(0)
    };
    v.playLocal = function() {
        wx.playVoice({
            localId: voice.localId,
            success: function(res) {
                v.showPlayUI(3);
                wx.onVoicePlayEnd({
                    success: function(res) {
                        v.playState = 0;
                        bcat.showPlayUI(2);
						if (null != timmer || undefined != timmer)
               			 clearInterval(timmer);
						 $('.post-voice-box-pause img').show();
                    }
                })
            }
        })
    };
    v.stopLocal = function() {
        wx.pauseVoice({
            localId: voice.localId,
            success: function(res) {
                v.showPlayUI(2)
            }
        })
    }
})(bcat);
$(document).ready(function() {
     $(document).on("touchstart", "#voice-start-button",
    function(e) {
        e.preventDefault();
        bcat.startrecord()
    }).on("touchend touchcancel", "#voice-start-button",
    function(e) {
        e.preventDefault();
        bcat.stoprecord()
    }).on("click", "#voice-start-button-click",
    function(e) {
        e.preventDefault();
        if (bcat.voice_record_state == 0) {
            bcat.startrecord()
        } else {
            bcat.stoprecord()
        }
    });
	
   $(document).on("click", "#reclist",
    function(e) {
        e.stopPropagation();
        if (bcat.playState == 0) {
			bcat.playState = 1;
            bcat.playLocal()
			timmer = setInterval(function () {
			$('.post-voice-box-pause img').toggle();
				count++;
				if (count / 4 == time) {
					clearInterval(timmer);
				}
			}, 250);
           
        } else {
			bcat.playState = 0;
            bcat.stopLocal()
			 if (null != timmer || undefined != timmer)
                clearInterval(timmer);
			$('.post-voice-box-pause img').show();
        }
    });
    $(document).on("click", "#voice-record-button",
    function(e) {
        e.stopPropagation();
        bcat.showPlayUI(0)
    });
    $(document).on("click", "#voice-complete-button",
    function(e) {
        e.stopPropagation();
        bcat.completevoic()
    });
    $(document).on("click", "#voice-record-button",
    function(e) {
        e.stopPropagation();
        bcat.resetrecord()
    });
   
    $(".icon-post-voice").click(function(e) {
        var html = $("#VoiceTemplatePost").html();
		
        wx.startRecord({
            success: function() {
                wx.stopRecord();
                layer.open({
                    shadeClose: false,
                    type: 1,
                    content: html,
                    className: "voice-record-bg",
                    style: "position:fixed;left:0;bottom:0;padding-top:0;height:300px;",
                    end: function() {},
                    success: function() {
                        $("#actionsheet_cancel").click(function() {
                            wx.stopRecord({
                                success: function(res) {}
                            });
                            $("#hidrecordId").val("");
                            $("#hidrecordSerId").val("");
                            $("#hidrecordTime").val("0");
                            $("#hidrecordText").val("");
                            bcat.showPlayUI(0);
                            layer.closeAll()
                        });
                        /*$(".voice-record-button-local").click(function(e) {
                            $("#VideoOrMusic").val("voice");
                            $("#fileUp").click();
                            e.stopPropagation
                        });*/
                        bcat.showPlayUI(0);
                       /* if ((bcatBrowser.versions.iPhone || bcatBrowser.versions.iPad)) {
                            $(".voice-record-button-local").hide()
                        } else {
                            $(".voice-record-button-local").show()
                        }*/
						$(".voice-record-button-local").hide()
                        $("#slide-to-click").click(function(e) {
                            $("#press-model-tips").hide();
                            $("#slide-to-press").show();
                            $("#voice-press-box").hide();
                            $("#voice-click-box").show();
                            $(this).hide();
                            e.stopPropagation
                        });
                        $("#slide-to-press").click(function(e) {
                            $("#press-model-tips").show();
                            $("#slide-to-click").show();
                            $("#voice-press-box").show();
                            $("#voice-click-box").hide();
                            $(this).hide();
                            e.stopPropagation
                        })
                    }
                })
            }
        })
    })
});