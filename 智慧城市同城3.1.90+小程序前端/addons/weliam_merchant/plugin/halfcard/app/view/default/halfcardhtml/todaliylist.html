{php include wl_template('common/header');}
<style type="text/css">
em {font-style: normal;}
#page-index .select-modal{position: fixed;top: 0;left: 0;width: 100%;height: 100%;background-color: rgba(0, 0, 0, .3);display: none;z-index: 888;}
/*#page-index div{border: none;}*/
#page-index .index-nav{position: relative;z-index: 999;background-color: #fff;border-bottom: 1px solid #e7e7e7;border-top: 1px solid #e7e7e7;padding: 5px 0;}
#page-index .index-navbar{height: 30px;line-height: 30px;text-align: center;display: inline-block;}
#page-index .index-navbar span{font-size: 14px;margin-top: -2px;}
#page-index .all-select{position: absolute;top: -260px;left: 0;z-index: 900;width: 100%;height: 300px;overflow: hidden;-webkit-transition: top .2s ease;transition: top .2s ease;background:url({URL_APP_IMAGE}halfcard/select_bg.png) repeat-y;}
#page-index .close-all-select{position: absolute;bottom: 0;left: 0;width: 100%;height: 38px;line-height: 36px;font-size: 22px;font-weight: 400;color: #ccc;text-align: center;background-color: rgba(255, 255, 255, .95);font-family: sans-serif;}
#page-index .all-select-li{padding-left: 50px;list-style-type: none;height: 41px;line-height: 41px;opacity: 0;border-bottom: 1px solid #fcfcfc;}
#page-index .all-select-li-disable{padding-left: 50px;list-style-type: none;height: 13px;line-height: 13px;opacity: 0;font-size: 13px;border: none;}
#page-index #all-select-left{position: relative;padding: 5px 15px;top: 2px;width: 150%;height: 300px;color: #777;overflow-y: scroll;padding-bottom: 20px;}
#page-index #all-select-right{position: relative;padding: 5px 0;top: -100%;left: 147px;width: 80%;height: 300px;color: #999;overflow-y: scroll;display: none;border-bottom: 1px solid #fff;padding-bottom: 20px;}
#page-index #all-select-left li{-webkit-transition: all .1s ease;transition: all .1s ease;}
#page-index #all-select-right li{-webkit-transition: all .1s ease;transition: all .1s ease;}
#page-index .qiang,#page-index .zhe{padding: 1px 2px;border-radius: 3px;color: #fff;font-size: 13px;background-color: red;}
#page-index .zhe{background-color: : #ff512f;}
#page-index .loading_text{height: 40px;width: 100%;display: inline-block;line-height: 40px;text-align: center;color: #fff;}
#page-index #all-type:before{content: "";position: absolute;top: 5px;left: 33.3333%;height: 30px;width: 1px;background-color: #e7e7e7;}
#page-index #all-city:before{content: "";position: absolute;top: 5px;left: 66.6666%;height: 30px;width: 1px;background-color: #e7e7e7;}
#page-index .list-block ul:after{height: 0;}
#page-index .list-block ul:before{height: 0;}
.storehead{padding-left: 20px;padding-right: 20px;background-color: rgba(72,84,96,0.2);}
.headimg img{width: 100%;position: relative;z-index: 999;}
.weeklist{background-color: white;position: relative;z-index: 999;padding-top: 5px;padding-bottom: 10px;}
.weeklist ul{margin: 0;padding: 0;overflow-x: auto;overflow-y: hidden;white-space: nowrap;height: 50px;padding-right: 10px;}
.weeklist ul::-webkit-scrollbar {display: none}
.weeklist ul li{display: inline-block;position: relative;}
.weeklist ul li .date{display: inline-block;width: 50px;height: 50px;border-radius: 100%;text-align: center;line-height: 50px;margin-left: 10px;border: 1px solid gainsboro;}
.weeklist ul li .tipnum{display: inline-block;width: 20px;height: 15px;position: absolute;left: 45px;background-color:#ff512f;border-radius: 50%;line-height: 15px;text-align: center;color: white;}
.weeklist ul li .dataweek{display: inline-block;position: absolute;bottom: -6px;left: 16px;font-size: 13px;}
.weeklist ul li .dataday{display: inline-block;position: relative;top: -12px;}
.weeklist ul li .active{background-color: #ff512f;color: white;border: 1px solid #ff512f;}
.weeklist ul li .active + span{border: 2px solid white;width: 24px;height: 19px;}
.nulltips{text-align: center;color: #ff512f;background-color: white;padding-top: 2rem;padding-bottom: 2rem;}
.tiptext{position: absolute;top: 7.5%;right: 14%;font-size: .85rem;font-weight: 700;color: #fff;z-index: 1000;}
.tohalfcardlist {
	font-size:15px;
	display:inline-block;
	width:45%;
	color:orangered;
	border-radius:5px;
	float:left;
	padding-top:5px;
	padding-bottom:4px;
	text-align:center
}
.todailylist{
	width:45%;
	background-color:orangered;
	color:white;
	float:right;
	font-size:15px;
	display:inline-block;
	border-radius:5px;
	padding-top:5px;
	padding-bottom:6px;
	text-align:center;
}
</style>
<div class="page-group">
	<div class="page page-current" id="page-index">
		{php include wl_template('common/rightnav');}
		<div class="headfix">
		<div class="row no-gutter index-nav navbar-fixed-top">
			<div class="col-33 index-navbar sherry-click" id="all-nearby" data-id="">
				<em>附近优先</em>
				<span class="icon iconfont icon-unfold icon-animate" id="all-nearby-icon"></span>
			</div>
			<div class="col-33 index-navbar sherry-click" id="all-city" data-id="">
				<em>全城</em>
				<span class="icon iconfont icon-unfold icon-animate" id="all-city-icon"></span>
			</div>
			<div class="col-33 index-navbar sherry-click" id="all-type" one-id="{$cid}" data-id="{$pid}"><em>{if $cname}{$cname}{else}商户分类{/if}</em>
				<span class="icon iconfont icon-unfold icon-animate" id="all-type-icon"></span>
			</div>
		</div>
		</div>
		<div class="select-modal"></div>

		<div class="all-select">
			<ul id="all-select-left">
			</ul>
			<ul id="all-select-right">
			</ul>
			<div class="close-all-select sherry-click">×</div>
		</div>
		<div class="bar bar-standard bar-footer" style="padding:10px;height: auto;">
		    <div style="border:1px solid orangered;" class="tohalfcardlist">特权日</div><div class="todailylist">非特权日</div>
		</div>
		<div class="content infinite-scroll-bottom infinite-scroll" data-distance="200">
			<div class="list-block media-list" id="dataBox">
				<ul class="list-container">
				</ul>
			</div>
			<div class="infinite-scroll-preloader">
				<div class="weui-loadmore">
			        <i class="weui-loading"></i>
			        <span class="weui-loadmore__tips">正在加载</span>
			    </div>
			</div>
		</div>
	</div>
</div>
<script id="storetemid" type="text/html">
{{# for(var i = 0, len = d.length; i < len; i++){ }} 
	{{# if(d[i].active){ }}
		<li class="item">
		<a href="{{d[i]['active'].href}}" class="item-link item-content">
			<div class="item-media">
				<img src="{{ d[i]['active'].logo }}" style='width: 3.5rem;'>
			</div>
			<div class="item-inner">
				<div class="item-title-row">
					<div class="item-title">{{ d[i]['active'].title }}</div>
				</div>
				<div class="item-subtitle" style="font-size: .65rem;color: #f66;">营业时间：{{d[i]['storehours'].startTime}}~{{d[i]['storehours'].endTime}}</div>
				<div  style="margin-left: 0;color: orangered;">{{d[i]['active'].discount}}折</div>
				<div class="item-after" style="position: absolute;bottom: 8px;right: 1.5rem;color: #999;"><i class="icon iconfont icon-location"></i>{{ d[i].distance }}</div>
			</div>
		</a>
		</li>
	{{# } }}
{{# } }}
</script>
<script type="text/javascript">
	var xx = 0;
	$(function(){
		xx = $('.headfix').height();
		$('#dataBox').css('margin-top',xx+'px');
	});
	
	$('.tohalfcardlist').click(function(){
		location.href="{php echo app_url('halfcard/halfcard_app/halfcardlist')}";
	});
	$('.todailylist').click(function(){
		location.href="{php echo app_url('halfcard/halfcard_app/todaliylist')}";
	});
	var loading = false,
		maxItems = 1000,
		itemsPerLoad = 10,
		nothing = false,
		lastIndex = 10,
		n = 0,
		pid = "",
		cid = "",
		distid = "",
		listData = [],
		page = 1,
		pagesize = 8,
		t = null,
		flag = $('#flag').val(),
		endmark = 1;
		tt = null;
	var map, geolocation;
	var longitude = 0,
		latitude = 0;
		
	function asd(sign){
			if(sign != 2){$(".list-container").html('');page = 1;}
			$('.infinite-scroll-preloader').show();
			flag = $('#flag').val();
			pid = $("#all-type").attr("data-id");
			cid = $("#all-type").attr("one-id");
			distid = $("#all-city").attr("data-id");
			//alert(flag+'|'+pid+'|'+distid);
			$.post("{php echo app_url('halfcard/halfcard_app/getdailystore')}"+ "&lng=" + longitude + "&lat=" + latitude+"&page="+page+"&pid="+pid+"&cid="+cid+"&distid="+distid,{},function(d){
				$('.infinite-scroll-preloader').hide();
				loading = false;
			//	alert(JSON.stringify(d).length);
				if(JSON.stringify(d).length>40){
					sessionStorage.setItem("demokey",JSON.stringify(d));
					var contentdata = d.slice(0,pagesize);
					resetLoadFn(contentdata);
				}else{
					var nothing_html = "<li><div style='background-color: white;padding-top:1px'>" +
					'<div class="weui-loadmore weui-loadmore_line"><span class="weui-loadmore__tips">暂无更多数据</span></div></div></li>';
					$(".list-container").append(nothing_html);
					endmark = 0;
				}
			}, 'json');
		}
	
	//加载地图，调用浏览器定位服务
	map = new AMap.Map('container', {
		resizeEnable: true
	});
	
	if (AMap.UA.ios) {

	    //使用远程定位，见 remogeo.js
	    var remoGeo = new RemoGeoLocation();
	
	    //替换方法
	    navigator.geolocation.getCurrentPosition = function() {
	        return remoGeo.getCurrentPosition.apply(remoGeo, arguments);
	    };
	
	    //替换方法
	    navigator.geolocation.watchPosition = function() {
	        return remoGeo.watchPosition.apply(remoGeo, arguments);
	    };
	}
	
	map.plugin('AMap.Geolocation', function() {
		geolocation = new AMap.Geolocation({
			enableHighAccuracy: true, //是否使用高精度定位，默认:true
			timeout: 10000, //超过10秒后停止定位，默认：无穷大
			buttonOffset: new AMap.Pixel(10, 20), //定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
			zoomToAccuracy: true, //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
			buttonPosition: 'RB'
		});
		map.addControl(geolocation);
		geolocation.getCurrentPosition();
		AMap.event.addListener(geolocation, 'complete', onComplete); //返回定位信息
		AMap.event.addListener(geolocation, 'error', onError); //返回定位出错信息
	});
	AMap.service('AMap.Geocoder', function() { //回调函数
			//实例化Geocoder
			geocoder = new AMap.Geocoder({
				city: "010" //城市，默认：“全国”
			});
		})
		//解析定位结果
	function onComplete(data) {
		latitude = data.position.getLat(); // 纬度，浮点数，范围为90 ~ -90
		longitude = data.position.getLng(); // 经度，浮点数，范围为180 ~ -180。
//		var posturl = "{php echo app_url('halfcard/halfcard_app/getdailystore',array('cid'=>$cid,'pid'=>$pid,'keyword'=>$keyword))} "+ "&lng=" + longitude + "&lat=" + latitude;
//		ajaxGetFn({
//			url: posturl,
//			fn: function(data) {
//				listData = data;
//				addItems(itemsPerLoad, 0, data);
//			}
//		})
		asd(1);
	}
	//解析定位错误信息
	function onError(data) {
   		$.toast('获取地理位置失败，请刷新！');
		asd(1);
	}

	function ajaxGetFn(option) {
		$.ajax({
			type: "GET",
			url: option.url,
			async: true,
			success: function(data) {
				data = eval(data);
				option.fn(data);
			},
			error: function() {
				alert("网络错误！")
			}
		});
	}

	function openSelectFn() {
		clearTimeout(t);
		$("#page-index .select-modal").css({
			"display": "block"
		})
		$("#page-index .all-select").css({
			"top": (xx-2)+"px"
		})
		$("#page-index #all-select-left li").css({
			"opacity": "0",
			"paddingLeft": "50px"
		})
		$("#page-index #all-select-right li").css({
			"opacity": "0",
			"paddingLeft": "50px"
		})
		$("#page-index #all-select-right").css({
			"display": "none"
		})
		setTimeout(function() {
			$("#page-index #all-select-left li").css({
				"opacity": "1",
				"paddingLeft": "8px"
			})
		}, 200);
	}

	function closeSelectFn() {
		resetSwitchIcon();
		$(".all-select").css({
			"top": "-260px"
		})
		$(".select-modal").css({
			"display": "none"
		})
		setTimeout(function() {
			$("#all-select-left li").css({
				"opacity": "0",
				"paddingLeft": "50px"
			})
			$("#all-select-right li").css({
				"opacity": "0",
				"paddingLeft": "50px"
			})
			$("#all-select-right").css({
				"display": "none"
			})
		}, 200)
	}

	function resetLoadFn(data) {
		//重置加载数据的最初值                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
		lastIndex = 10;
		//判断提示 “没有啦”
		nothing = false;
		$(".all-select").css({
			"top": "-260px"
		})
		$(".select-modal").css({
			"display": "none"
		})
		setTimeout(function() {
			$("#all-select-left li").css({
				"opacity": "0",
				"paddingLeft": "50px"
			})
			$("#all-select-right li").css({
				"opacity": "0",
				"paddingLeft": "50px"
			})
			$("#all-select-right").css({
				"display": "none"
			})
		}, 200)
		$("#page-index #loadingToast").css({
			"display": "block"
		});
		//$("#page-index .infinite-scroll-bottom .list-container").html("");
		addItems(itemsPerLoad, 0, data);
	}

	function clickLeftAnimate() {
		clearTimeout(tt);
		$("#page-index #all-select-right li").css({
			"opacity": "0",
			"paddingLeft": "50px"
		})
		$("#page-index #all-select-right").css({
			"display": "block"
		})
		tt = setTimeout(function() {
			$("#page-index #all-select-right li").css({
				"opacity": "1",
				"paddingLeft": "8px"
			})
		}, 200)
	}

	function addItems(number, lastIndex, data) {
		var html = '';
		//当数据库数据小于number时，改变number
			$('.infinite-scroll-preloader').css({
				"display": "none"
			});
		var gettpl = document.getElementById('storetemid').innerHTML;
		laytpl(gettpl).render(data, function(html) {
			$('.infinite-scroll-bottom .list-container').append(html);
		});
		if(data.length == 0) {
			if(!nothing) {
				var nothing_html = "<li><div style='background-color: white;padding-top:1px'>" +
					'<div class="weui-loadmore weui-loadmore_line"><span class="weui-loadmore__tips">暂无更多数据</span></div></div></li>';
					$(".list-container").append(nothing_html);
					endmark = 0;
				nothing = true;
			}
		}
		loading = false;
		page++;
	}

	/*****************/
	/*点击元素背景变暗效果*/
	$(".sherry-click").on('touchstart', function() {
		$(this).css({
			"backgroundColor": "#e6e6e6"
		});
	})
	$(".sherry-click").on('touchend', function() {
		$(this).css({
			"backgroundColor": "#fff"
		});
	})

	function repeatLi(left_html, left_data, left, all) {
		left_html += "<li class='all-select-li' data-id=''><em>" + all + "</em><li/>";
		$("#page-index " + left).html("");
		for(var i = 0; i < left_data.length; i++) {
			//查询条件左边html代码
			left_html += "<li class='all-select-li' data-id=" + left_data[i].id + "><em>" + left_data[i].name + "</em><li/>"
		}
		left_html += "<li class='all-select-li-disable'><li/>"
		$("#page-index " + left).append(left_html);
	}

	function switchIcon(id) {
		$('#' + id).css({
			"webkitTransition": "all .3s linear",
			"transition": "all .3s linear"
		})
		setTimeout(function() {
			$('#' + id).css({
				"transform": "rotate(180deg)",
				"webkitTransform": "rotate(180deg)"
			}, 50)
		})
	}

	function switchIcon2(id) {
		$('#' + id).css({
			"webkitTransition": "all .3s linear",
			"transition": "all .3s linear",
			"transform": "rotate(180deg)",
			"webkitTransform": "rotate(180deg)"
		})
		setTimeout(function() {
			$('#' + id).css({
				"transform": "rotate(0deg)",
				"webkitTransform": "rotate(0deg)"
			}, 50)
		})

	}

	function resetSwitchIcon() {
		$('#all-type-icon').css({
			"transform": "rotate(0deg)",
			"webkitTransform": "rotate(0deg)"
		})
		$('#all-nearby-icon').css({
			"transform": "rotate(0deg)",
			"webkitTransform": "rotate(0deg)"
		})
		$('#all-city-icon').css({
			"transform": "rotate(0deg)",
			"webkitTransform": "rotate(0deg)"
		})
	}
	//以上为定义的全局函数 ， 下面是操作方法	

	$("#page-index #all-type").click(function() {
		resetSwitchIcon();
		nothing = false;
		//重置页面数
		endmark = 1;
		ajaxGetFn({
			url: "{php echo app_url('store/merchant/getcategory')}",
			fn: function(left_data) {
				console.log(left_data);
				var left_html = '';
				switchIcon('all-type-icon');
				repeatLi(left_html, left_data, "#all-select-left", "全部分类");
				$("#page-index #all-select-left .all-select-li").click(function() {
						var type_name = $(this).children("em").text();
						var type_right_id = $(this).attr("data-id");
						$("#all-type").attr("one-id",type_right_id);
						//点击列表项高亮背景颜色
						$("#page-index #all-select-left .all-select-li").css({color:"#777"})
						$(this).css({color:"#ff512f"})
						cid = $(this).attr("data-id");
						ajaxGetFn({
							url: "{php echo app_url('store/merchant/getcategory')}" + "&pid=" + cid,
							fn: function(right_data) {
								var right_html = '';
								if (type_right_id=='') {
									repeatLi(right_html, [], "#all-select-right", "全部分类");
								}else{
									repeatLi(right_html, right_data, "#all-select-right", "全部 ("+type_name+")");
								}
								/*按条件加载数据*/
								$("#page-index #all-select-right .all-select-li").click(function() {
									var type_right_name = $(this).children("em").text();
									type_right_id = $(this).attr("data-id");
									$("#all-type").attr("data-id", type_right_id);
									if(type_right_name != "全部") {
										$("#all-type").attr("data-id", type_right_id);
										$("#all-type").children("em").text(type_right_name);
									} else {
										$("#all-type").attr("data-id", type_right_id);
										$("#all-type").children("em").text(type_name);
									}
									switchIcon2('all-type-icon');
									asd(1);
									closeSelectFn();
								})
								clickLeftAnimate();
							}
						})
					})
					//打开下拉选项
				openSelectFn();
			}
		})
	})
	var city_id = '';
	var city_name = '';
	//按城市查询
	$("#page-index #all-city").click(function() {
			resetSwitchIcon();
			nothing = false;
			endmark = 1;
			ajaxGetFn({
				url: "{php echo app_url('store/merchant/getarea')}",
				fn: function(left_data) {
					var left_html = '';
					switchIcon('all-city-icon');
					repeatLi(left_html, left_data, "#all-select-left", "全城")
						/*按条件加载数据*/
					$("#page-index #all-select-left .all-select-li").click(function() {
						city_name = $(this).children("em").text();
						city_id = $(this).attr("data-id");
						$("#all-city").attr("data-id", city_id);
						$("#all-city").children("em").text(city_name);
						switchIcon2('all-city-icon');
						asd(1);
						closeSelectFn();
					});
					//打开下拉选项
					openSelectFn();
				}
			})

		})
		//按距离查询
	$("#page-index #all-nearby").click(function() {
		resetSwitchIcon();
		switchIcon('all-nearby-icon');
		var left_html = '';
		var nearby_data = []
		page = 1;
		endmark = 1;
		nothing = false;
		repeatLi(left_html, nearby_data, "#all-select-left", "附近优先");
		/*按条件加载数据*/
		$("#page-index #all-select-left .all-select-li").click(function() {
			var nearby_name = $(this).children("em").text();
			var nearby_id = $(this).attr("data-id");
			$("#all-nearby").attr("data-id", nearby_id);
			$("#all-nearby").children("em").text(nearby_name);
			switchIcon2('all-nearby-icon');
			asd(1);
			closeSelectFn();
		})
		//打开下拉选项
		openSelectFn();
	})
	$(document).on('infinite', '.infinite-scroll-bottom', function() {
		if(loading) return;
		loading = true;
		if(endmark){
		$('.infinite-scroll-preloader').show();
		setTimeout(function() {
			var dt = JSON.parse(sessionStorage.getItem("demokey"));
			var xxx = dt.slice((page-1)*pagesize ,(page-1)*pagesize+pagesize);
			resetLoadFn(xxx);
		}, 800);}
	});
	//关闭条件查询
	$(".close-all-select").click(function() {
		closeSelectFn();
	})
	$(".select-modal").click(function() {
		closeSelectFn();
	})
	$.init();
</script>
{php include wl_template('common/footer');}