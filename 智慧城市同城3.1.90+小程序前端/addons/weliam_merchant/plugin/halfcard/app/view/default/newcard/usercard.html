{php include wl_template('common/header');}
<link href="{URL_MODULE}plugin/halfcard/app/resource/css/opencord.css?v={WELIAM_VERSION}" rel="stylesheet" />
{if $base['noticestatus'] == 1 && empty($halfcards)}
<link href="{URL_MODULE}plugin/halfcard/app/resource/css/barrager.css" rel="stylesheet" />
<script src="{URL_MODULE}plugin/halfcard/app/resource/js/barrager.js" type="text/javascript"></script>
{/if}
<div class="page-group usercard">
	<div class="page page-current" id="page-index">
    	{if $base['noticestatus'] == 2}
		<div class="announcement" style="font-size:14px;margin-top:5px;display: none;">
			<div style="display: flex;height: inherit;">
				<img id="headpic" src="" width="25">
			    <span id="shuoming"></span>
			</div>
		</div>
		{/if}
		<div class="blackimg" style="z-index: 9999;">
			<div class="blacktip">请让商家扫码消费</div>
			<div id="qrcodeimg">
				{loop $halfcards $cc}
				<img id="qrimg{$cc['id']}" class="qrimg" style="display: none;" src="{php echo app_url('store/merchant/qrcodeimg',array('url'=>$cc['url']))}" /> {/loop}
			</div>
		</div>
		<div class="addfriend-box" id="qrcode" style="display: none;" >
		 <div class="addfriend-content" style="overflow-y: scroll;height: 70%;top: 40% !important;position: absolute;">
			<div class="addtitle">
		 		<!--<img class="titleimg" src="{URL_APP_IMAGE}halfcard/expand.png" />-->
				<div class="storename" id="storename"></div>
				<div class="datetime"><span id="datetime" style="max-height: 125px;display: inline-block;overflow-y: scroll;"></span></div><div style="clear:both"></div>
			</div>
			<div class="addfriend-line-box">
				<div class="addfriend-line"></div>
				<div class="buttons-row addfriend-change">
		           <a href="#tab1-1" class="tab-link button  active">使用</a>
		           <a href="#tab1-2" class="tab-link button">说明</a>
		        </div>
			</div>
			<div class="tabs" style="padding-top: 1rem;padding-bottom: 0rem;background: #FFF;border-radius: 5px;max-height: 250px;overflow-y: scroll;">
	            <div class="tab active" id="tab1-1">
	            	<div  style="background-color: white;position: relative;padding: .3rem;border-radius: 0  0 5px 5px;">
					    <div class="syqrimg"><img id="syqrimg" src=""></div>
					    <div class="qrcode" id="special1">今日折扣:<span class="alltime"></span>折<span style="display: none;margin-left: 3px;color: orangered;" id="daily">(特权日)</span></div>
					    <div class="qrcode" id="special2">当前剩余:<span class="halfcardqrcode"></span>/<span class="alltime"></span>次</div>
					    <div class="shoptips" style="margin-top: .3rem;font-size: .65rem;color: #888;">该服务项目由<span id="qrstorename"></span>提供</div>
					</div>
	            </div>
	            <div class="tab tab-desc describe" id="tab1-2" style="overflow: auto;padding:.3rem 0.5rem;">

	            </div>
          	</div>

		 </div>
		 	<div class="addfriend-box-close" style="text-align:center;bottom: 10%;"><img class="addfriend-close" src="../addons/weliam_merchant/web/resource/diy/images/adv_close.png" /></div>
		</div>
		{php include wl_template('common/followbar');}
		{php include wl_template('common/menu');}
		<div class="content" style="overflow: hidden;position: relative;min-height:100%;">
			<div class="infinite-scroll infinite-scroll-bottom" style="position: absolute;top: 0;bottom: 0;left: 0;right: 0;overflow-y: scroll;padding-bottom:2.2rem;">
				{if !$base['search'] || $base['search'] == 0}{php include wl_template('dashboard/search');}{/if}
                <div style="overflow-x: hidden;overflow-y:scroll;">
				<section class="native-banner has-shadow">
					<div class="cord-box" {if !$base['search'] || $base['search'] == 0}style="padding-top: 2rem;"{/if}>
						<div class="cord-bg"></div>
						{if $halfcards}
						<div class="cord-swiper">
							<div class="swiper-container">
								<div class="swiper-wrapper">
									{loop $halfcards $ca}
									<div class="swiper-slide membercards" cardid="{$ca['id']}">
										<div class="cord-main">
											<div class="code-img-box bll" cardid="{$ca['id']}">
												<div class='code-img-rotate'>
													<svg class="icon" style="width: 2rem; height: 2rem;vertical-align: middle;fill: currentColor;overflow: hidden;color: #fff;" viewBox="0 0 1024 1024">
														<path d="M201.274096 209.080899 267.600711 209.080899 267.600711 275.407514 201.274096 275.407514 201.274096 209.080899ZM386.990868 89.692788 81.885985 89.692788l0 305.105906 119.388111 0 0 53.061496 66.326615 0 0-53.061496 119.389134 0 0-66.328661 53.061496 0 0-53.06252-53.061496 0L386.989845 89.692788 386.990868 89.692788 386.990868 89.692788zM320.66323 328.470033 148.2126 328.470033 148.2126 156.019403l172.45063 0L320.66323 328.470033 320.66323 328.470033zM201.274096 752.963027 267.600711 752.963027 267.600711 819.290665 201.274096 819.290665 201.274096 752.963027ZM745.156224 209.080899 811.483862 209.080899 811.483862 275.407514 745.156224 275.407514 745.156224 209.080899ZM506.378979 508.837984 506.378979 580.51342 572.706617 580.51342 572.706617 514.185782 625.76709 514.185782 625.76709 447.859167 572.706617 447.859167 572.706617 394.798694 506.378979 394.798694 506.378979 448.195835 506.378979 508.837984ZM506.378979 751.404532 506.378979 819.291688 572.706617 819.291688 572.706617 751.404532 572.706617 699.901531 625.76709 699.901531 625.76709 633.573893 570.660005 633.573893 506.378979 633.573893 506.378979 690.762383 506.378979 751.404532ZM572.706617 819.291688 625.76709 819.291688 625.76709 872.352161 572.706617 872.352161 572.706617 819.291688ZM440.052364 872.352161 440.052364 938.679799 510.017856 938.679799 572.706617 938.679799 572.706617 872.352161 510.017856 872.352161 440.052364 872.352161ZM692.094728 699.901531 625.76709 699.901531 625.76709 751.404532 625.76709 819.291688 691.942255 819.291688 745.156224 819.291688 745.156224 752.963027 692.094728 752.963027 692.094728 699.901531ZM745.156224 938.679799 813.227576 938.679799 873.868701 938.679799 930.872996 938.679799 930.872996 872.352161 873.868701 872.352161 811.484885 872.352161 811.484885 819.291688 745.156224 819.291688 745.156224 872.688829 745.156224 938.679799ZM930.872996 514.185782 930.872996 447.859167 873.868701 447.859167 811.484885 447.859167 811.484885 514.185782 873.868701 514.185782 930.872996 514.185782ZM864.545358 752.963027 930.872996 752.963027 930.872996 819.290665 864.545358 819.290665 864.545358 752.963027ZM440.052364 328.470033 506.378979 328.470033 506.378979 394.796648 440.052364 394.796648 440.052364 328.470033ZM745.156224 447.859167l0-53.061496 185.715749 0L930.871973 89.692788 625.76709 89.692788l0 66.326615-55.107085 0-64.281025 0 0 53.061496 64.281025 0 55.108109 0 0 66.326615-53.06252 0 0 53.06252 53.06252 0 0 66.326615 66.325591 0 0 53.061496 53.06252 0L745.156224 447.859167 745.156224 447.859167zM692.094728 156.019403 864.544335 156.019403l0 172.45063L692.094728 328.470033 692.094728 156.019403 692.094728 156.019403zM692.094728 580.51342 745.156224 580.51342 745.156224 633.573893 692.094728 633.573893 692.094728 580.51342ZM811.484885 699.901531 745.156224 699.901531 745.156224 752.963027 813.227576 752.963027 864.545358 752.963027 864.545358 690.762383 864.545358 633.573893 930.872996 633.573893 930.872996 580.51342 873.868701 580.51342 811.484885 580.51342 811.484885 630.121258 811.484885 699.901531ZM440.052364 209.080899 506.378979 209.080899 506.378979 275.407514 440.052364 275.407514 440.052364 209.080899ZM267.600711 514.185782 320.66323 514.185782 320.66323 580.51342 267.600711 580.51342 267.600711 514.185782ZM440.052364 447.859167 388.733559 447.859167 320.66323 447.859167 320.66323 514.185782 386.990868 514.185782 386.990868 580.51342 440.052364 580.51342 440.052364 508.837984 440.052364 447.859167ZM386.990868 819.291688 386.990868 699.901531l53.061496 0 0-66.326615-51.318806 0-187.459462 0 0-64.094784 0-55.293327-55.108109 0L81.885985 514.186805l0 66.326615 66.327638 0 0 53.061496L81.885985 633.574916l0 305.105906 305.105906 0 0-66.327638 53.061496 0 0-53.061496L386.990868 819.291688 386.990868 819.291688zM320.66323 872.352161 148.2126 872.352161 148.2126 699.901531l172.45063 0L320.66323 872.352161 320.66323 872.352161zM440.052364 580.51342 506.378979 580.51342 506.378979 633.573893 440.052364 633.573893 440.052364 580.51342ZM625.76709 514.185782 692.094728 514.185782 692.094728 580.51342 625.768113 580.51342 625.768113 514.185782 625.76709 514.185782ZM745.156224 514.185782 811.483862 514.185782 811.483862 580.51342 745.156224 580.51342 745.156224 514.185782Z"></path>
													</svg>
												</div>
											</div>
											<div class="cord-img">
												<div class="user-info-box">
													{if $_W['wlsetting']['halfcard']['levelstatus']}
													<div class="halflevel">{$ca['levelname']}</div>
													{/if}
													<div class="info">
														<div class="info-left">
															<div class="info-imgbox">
																<img class="user-img" src="{php echo tomedia($_W['wlmember']['avatar'])}" />
															</div>
															<div class="user-detile">
																<span id="name{$ca['id']}" style="font-size: .65rem;">{$ca['username']}</span>
																<text>{if $ca['realno']}No.{$ca['realno']}{/if}</text>
															</div>
														</div>
														<!--<i class="info-right icon iconfont icon-question"></i>-->
													</div>
													<div class="cord-info">
														<span style="font-size: 0.65rem;">{php echo date("Y-m-d",$ca['expiretime'])}到期</span>
														<a class="pay-btn ios_payclose" onclick="toopen({$ca['id']})" href="javascript:;">立即续费</a>
													</div>
												</div>
												<img {if $ca['cardimg']} src="{php echo tomedia($ca['cardimg'])}" {else} src="{URL_MODULE}plugin/halfcard/app/resource/images/cord-bg.jpg" {/if} />
											</div>
										</div>
									</div>
									{/loop}
									{if empty($base['morecard'])}
									<div class="swiper-slide" cardid="{$ca['id']}">
										<div class="cord-img">
											<img {if $base[ 'cardimg']} src="{php echo tomedia($base['cardimg'])}" {else} src="{URL_MODULE}plugin/halfcard/app/resource/images/cord-bg.jpg" {/if} />
											<div class="shadow-bg pos-center">
												<p>开通新的一卡通，享受更多特权</p>
												<a href="{php echo app_url('halfcard/halfcardopen/open')}" class="ios_payclose">开新卡</a>
											</div>
										</div>
									</div>
									{/if}
								</div>
							</div>
						</div>
						{else}
						<div class="cord-img">
							<img {if $base[ 'cardimg']} src="{php echo tomedia($base['cardimg'])}" {else} src="{URL_MODULE}plugin/halfcard/app/resource/images/cord-bg.jpg" {/if} />
							<div class="shadow-bg pos-center">
								<p>您还未开通一卡通，无法享受特权</p>
								<a href="{php echo app_url('halfcard/halfcardopen/open')}" class="ios_payclose">立即开通</a>
							</div>
						</div>
						{/if}
					</div>
				</section>
				{if $navs}
	    		<section class="banner-tab privilege">
	    			<div class="privilege-title">
	    				<span>一卡通</span>
	    				<span>尊享权益</span>
	    				<span>/PRIVILEGE</span>
	    			</div>
					<ul class="tab-list">
						{loop $navs $itme}
						<li style="width:25%;">
							<a href="{$itme['link']}" class="external" >
								<img src="{php echo tomedia($itme['thumb'])}" />
								<span {if $itme['color']}style="color: {$itme['color']};"{/if}>{$itme['name']}</span>
							</a>
						</li>
						{/loop}
					</ul>
				</section>
				{/if}
				{if !empty($advs)}
				<section class="banner-header" style="background: #FFFFFF;">
					<div class="swiper-container" id="banner_header">
						<div class="swiper-wrapper">
							{loop $advs $adv}
							<div class="swiper-slide">
								<div class="banner-img">
									<a href="{$adv['link']}"><img style="width: 100%;" src="{php echo tomedia($adv['thumb'])}"/></a>
								</div>
							</div>
							{/loop}
						</div>
						{if count($advs) > 1}
						<div class="swiper-pagination" id="banner_header_page"></div>
						{/if}
					</div>
				</section>
				<script>
				$(document).ready(function($) {
					var swiper = new Swiper('#banner_header', {
						{if count($advs) > 1}
						loop: true,
						speed:500,
					    autoplay: 3000,
					    autoplayDisableOnInteraction : false,
					    setWrapperSize:true,
					    pagination: '#banner_header_page',
					    paginationClickable: true
					    {/if}
					});
				});
				</script>
				{/if}
	    		{if $base['noticestatus'] == 1 && empty($halfcards)}
				<section class="barrager-main">
					<canvas id="canvas" style="position: absolute;top: 0;left: 0;"></canvas>
				</section>
				{/if}
				{if $halfcards && empty($base['statisticsdiv'])}
				<div class="statistics">
					<div class="count-info">
						<div class="count-name">
							{$_W['wlmember']['nickname']}，您已获得以下超级福利
						</div>
						<div class="coun-text">
							<div class="count-num">
								<div class="count-already">已消费(元)</div>
								<span>{$allorderprice}</span>
							</div>
							<div class="count-num">
								<div class="count-already">已为您节省(元)</div>
								<span>{$ellipsismoney}</span>
							</div>
						</div>
					</div>
					<div class="statistics-shadow"></div>
				</div>
				{/if}
				<div class="buttons-main">
				<div class="buttons-tab" style="z-index: 100;">
					{loop $pluginlist $plu}
					    {if $plu['status']}
					    <a href="javascript:;" type="{$plu['id']}" class="button button-card kks {if $first == $plu['id']} active {/if}">
							<text>{if $plu['newname']}{$plu['newname']}{else}{$plu['name']}{/if}</text>
							<span></span>
						</a>
					    {/if}
				    {/loop}
				</div>
				<div class="halflist">
					<section class="store-bag" id="packcate" {if $first != 2} style="display:none;" {/if}>
						{if $packcate}
						<div class="buttons-tab buttons-tab-min" style="z-index: 100;">
					      	<a href="javascript:;" packcaid = ''  class="button packtype button-card-in-min active"><em>全部</em></a>
							{loop $packcate $packtype}
						    <a href="javascript:;" packcaid = "{$packtype['id']}" class="button packtype button-card-in-min"><em>{$packtype['name']}</em></a>
					    	{/loop}
					    </div>
					    {/if}
					</section>
					<section class="store-bag" id="halfcate" {if $first != 1 && $first != 5} style="display:none;" {/if}>
					{if $halfcate}
					<div class="buttons-tab buttons-tab-min" style="z-index: 100;">
						<a href="javascript:;" halfcaid = ''  class="button halftype button-card-in-min active"><em>全部</em></a>
						{loop $halfcate $halftype}
						<a href="javascript:;" halfcaid = "{$halftype['id']}" class="button halftype button-card-in-min"><em>{$halftype['name']}</em></a>
						{/loop}
					</div>
					{/if}
					</section>
					<section id="choiceday" {if $first != 1} style="display:none;" {/if} class="native-time main-sm">
					<ul class="buttons-tab-min">
						<li class="time-item button-card-min active" dayflag = '0'>
							<span>今天</span>
							<p>{$day}</p>
						</li>
						<li class="time-item button-card-min" dayflag = '1'>
							<span>明天</span>
							<p>{$day1}</p>
						</li>
						<li class="time-item button-card-min" dayflag = '2'>
							<span>{if $week2 == 1}周一{else if $week2 == 2}周二{else if $week2 == 3}周三{else if $week2 == 4}周四{else if $week2 == 5}周五{else if $week2 == 6}周六{else if $week2 == 7}周日{/if}</span>
							<p>{$day2}</p>
						</li>
						<li class="time-item button-card-min" dayflag = '3'>
							<span>{if $week3 == 1}周一{else if $week3 == 2}周二{else if $week3 == 3}周三{else if $week3 == 4}周四{else if $week3 == 5}周五{else if $week3 == 6}周六{else if $week3 == 7}周日{/if}</span>
							<p>{$day3}</p>
						</li>
						<li class="time-item button-card-min" dayflag = '4'>
							<span>{if $week4 == 1}周一{else if $week4 == 2}周二{else if $week4 == 3}周三{else if $week4 == 4}周四{else if $week4 == 5}周五{else if $week4 == 6}周六{else if $week4 == 7}周日{/if}</span>
							<p>{$day4}</p>
						</li>
						<li class="time-item button-card-min" dayflag = '5'>
							<span>{if $week5 == 1}周一{else if $week5 == 2}周二{else if $week5 == 3}周三{else if $week5 == 4}周四{else if $week5 == 5}周五{else if $week5 == 6}周六{else if $week5 == 7}周日{/if}</span>
							<p>{$day5}</p>
						</li>
					</ul>
					</section>
					<section class="native-goodslist main-sm" style="padding-bottom: 0;">
						<div class="goods-main">
							<div class="storelist" style="position: relative;">

							</div>
						</div>
						<div class="weui-loadmore loading_more" style="display: none;">
				            <i class="weui-loading"></i>
				            <span class="weui-loadmore__tips">正在加载</span>
				        </div>
				        <div class="weui-loadmore weui-loadmore_line" style="display: none;">
				            <span class="weui-loadmore__tips" style="background-color: #EFEFF4;">暂无更多数据</span>
				        </div>
					    <input type="hidden" id="dayflag" value="0" />
					    <input type="hidden" id="cateid" value="0" />
					    <input type="hidden" id="typeid" value="{$first}" />
					</section>
				</div>
			</div>
				</div>
			</div>
        </div>
	</div>
</div>
{php include wl_template('htmltpl/rushlist');}
{php include wl_template('htmltpl/halflist');}
{php include wl_template('htmltpl/couponlist');}
{php include wl_template('htmltpl/packagelist');}
{php include wl_template('htmltpl/grouponlist');}
{php include wl_template('htmltpl/integrallist');}
<script>
	var loading = false;
	var pindex = 0;
	var i = 0;
	var pagesize = 10;
	var endmark = 0;
	var packcaid = 0;
	var halfcaid = 0;
	var his_init = 0; //history标识
    {if $base['noticestatus'] == 2 && $recode}
	var recode = {$recode};
	{else}
	var recode = 0;
	{/if}

	var hisData = 0;
	if(sessionStorage.hisData){
		var hisData = JSON.parse(sessionStorage.hisData);
		hisData.forEach(function(item, index){
			if(item.hisUrl == encodeURI(window.location.href+"&aid={$_W['aid']}")){
				hisData = 1;
				var typeIndex = 0;
				$('.storelist').html(item.data);
				$('.infinite-scroll').scrollTop(item.scrollTop);
				pindex = item.page;
				packcaid = item.packcaid;
				halfcaid = item.halfcaid;
				$('#dayflag').val(item.dayflag);
				$('#typeid').val(item.typeid);
				$('.kks').removeClass("active");
				$('.kks').each(function(){
					if($(this).attr('type') == item.typeid){
						$(this).addClass("active");
						typeIndex = $(this).index();
					}
				});
				if(typeIndex == 0){
					$('#choiceday').hide();
					$('#packcate').hide();
					$('.packtype').removeClass("active");
					$('.packtype').each(function(){
						if($(this).attr('packcaid') == item.packcaid){
							$(this).addClass("active");
						}
					});
				}else if(typeIndex == 1){
					$('#packcate').hide();
					$('#choiceday').show();
					$('#halfcate').show();
					$('.time-item').removeClass("active");
					$('.time-item').each(function(){
						if($(this).attr('dayflag') == item.dayflag){
							$(this).addClass("active");
						}
					});
					$('.halftype').removeClass("active");
					$('.halftype').each(function(){
						if($(this).attr('halfcaid') == item.halfcaid){
							$(this).addClass("active");
						}
					});
				}else if(typeIndex == 5){
					$('#packcate').hide();
					$('#choiceday').hide();
					$('#halfcate').show();
					$('.halftype').removeClass("active");
					$('.halftype').each(function(){
						if($(this).attr('halfcaid') == item.halfcaid){
							$(this).addClass("active");
						}
					});
				}else{
					$('#packcate').hide();
					$('#choiceday').hide();
					$('#halfcate').hide();
				}



			}
		});
	}
	var win_w = $(window).width();
	var kks_font_size = 15;
	change_kks_f_s();
	function change_kks_f_s(){
		var kks_sum_w = 0;
		for(var i=0; i<$('.kks').length; i++){
			kks_sum_w += $('.kks:eq('+i+')').innerWidth();
		}
		if(kks_sum_w > win_w){
			kks_font_size --;
			$('.buttons-tab .button.kks').css("font-size",kks_font_size+"px");
//			change_kks_f_s();
		}
	}
	$('.bll').click(function() {
		var cardid = $(this).attr('cardid');
		$('.qrimg').hide();
		$('#qrimg' + cardid).show();
		$('.blackimg').show();
	});
	$('.blackimg').click(function() {
		$('.blackimg').hide();
	});
	function tostore(id){
		location.href = "{php echo app_url('store/merchant/detail')}&id=" + id;
	}
	function toopen(id) {
		location.href = "{php echo app_url('halfcard/halfcardopen/open')}&id=" + id;
	}
	function touserecord() {
		var cardid = $('.swiper-slide-active').attr('cardid');
		location.href = "{php echo app_url('halfcard/halfcard_app/userecord')}&id=" + cardid;
	}
	function todetail(id){
		var cardid = $('.swiper-slide-active').attr('cardid');
		if(!cardid){
			cardid = $('.membercards:first').attr('cardid');
		}
		location.href = "{php echo app_url('halfcard/halfcard_app/halfcarddetail')}&id="+id+'&cardid='+cardid;
	}
	function topackdetail(id){
		var cardid = $('.swiper-slide-active').attr('cardid');
		if(!cardid){
			cardid = $('.membercards:first').attr('cardid');
		}
		location.href = "{php echo app_url('halfcard/halfcard_app/packagedetail')}&id="+id+'&cardid='+cardid;
	}
	$(document).on('click', '.changename', function() {
		$.prompt('请输入持卡人姓名', function(value) {
			if(value == '') {
				$.toast("请输入持卡人姓名");
			} else {
				var cardid = $('.swiper-slide-active').attr('cardid');
				$.post("{php echo app_url('halfcard/halfcardopen/changename')}", {
					newname: value,
					cardid: cardid
				}, function(d) {
					if(!d.errno) {
						$('#name' + cardid).text(value);
						$.toast('修改成功');
					} else {
						$.toast(d.msg);
					}
				}, "json");
			}
		});
	});
	function torushgoods(id) {
		location.href = "{php echo app_url('rush/home/detail')}&id=" + id;
	}
	function getlink(id,flag){
		if(window.__wxjs_environment === 'miniprogram'){
			$.toast('该礼包只能在公众号内适用');
		}else{
			$.post("{php echo app_url('halfcard/halfcard_app/getlink')}",{id:id,flag:flag},function(d){
				if(!d.errno){
					location.href = d.msg;
				}else if(d.errno == 2){
					location.href = "{php echo app_url('member/user/signin')}&backurl="+d.msg;
				}else{
					$.toast(d.msg);
				}
			},"json");
		}
		
	}
	function getpacks(id,type,sid){
		var cardid = $('.swiper-slide-active').attr('cardid');
		$.post("{php echo app_url('halfcard/halfcard_app/showqrimg')}",{id:id,cardid:cardid,type:type},function(d){
			if(!d.errno){
				if(sid>0){
					location.href = "{php echo app_url('order/paybill/paycheck')}&id="+sid+"&cardid="+cardid;
				}else{
					$('#storename').text(d.activename);
					$('#datetime').text(d.limit);
					$('#syqrimg').attr('src',d.qrsrc);
					$('.halfcardqrcode').text(d.surplustimes);
					$('#qrstorename').text(d.storename);
					$('.describe').html(d.describe);
					if(type == 1){
						$('#special1').show();
						$('#special2').hide();
						$('.alltime').text(d.discount);
					}else{
						$('#special1').hide();
						$('#special2').show();
						$('.alltime').text(d.alltime);
					}
					if(d.halfflag){
						$('#daily').show();
					}else{
						$('#daily').hide();
					}
					$('#qrcode').show();
				}
			}else if(d.errno == 2){
				location.href = "{php echo app_url('member/user/signin')}&backurl="+d.msg;
			}else if(d.errno == 3){
				location.href = d.msg;
			}else{
				$.toast(d.msg);
			}
		},"json");
	}

    $(function(){
    	{if $base['noticestatus'] == 1}
    	$.post("{php echo app_url('halfcard/halfcard_app/getopenrecodes')}",{},function(d){
//  		alert(JSON.stringify(d));
			if(!d.errno) {
				$('#canvas').barrager(d.data,$(document.body).outerWidth(true),100);
			}
		}, "json");
		{/if}

    	{if $base['noticestatus'] == 2 && $recode}
			function funcTest(){
        	//每隔5秒执行一次timelyFun方法
		        window.setInterval(function(){
		        	if(i>9){i = 0;}
					$("#shuoming").text(recode[i].msg);
			        $("#headpic").attr("src",recode[i].imgurl);
					$(".announcement").show();
			        setTimeout("$('.announcement').hide()",3000);
			        i++;
		        },5000);
		    }
		    window.onload = funcTest;
		{/if}

		$(document).on("pageInit", "#page-index", function(e,id,page){
			var latitude, longitude ,addflag = 1;
			common.Geolocation(function(data){
				latitude = data.lat; // 纬度，浮点数，范围为90 ~ -90
			    longitude = data.lng; // 经度，浮点数，范围为180 ~ -180。
				addItems();
			},function(){
				$.toast('获取地理位置失败，请刷新！');
				if($('.storelist div').length == 0){
					addItems();
				}
			});
			
			setInterval(function(){
				if(addflag){
					addItems();
				}else{
					clearInterval();
				};
			},3000);


			var swiper = new Swiper('.swiper-container', {
				autoplay: false, //可选选项，自动滑动
				onSlideChangeEnd:function(swiper){
					var typeid = $('#typeid').val();
					if(typeid == 2 || typeid == 1 || typeid == 5){
						$('.storelist').html('');
						$(".loading_more").show();
						$('.weui-loadmore_line').hide();
						pindex = 0;
						addItems();
					}
				}
			});

			  function inputtpl(contentdata){
				loading = false;
		    	if(contentdata.length){
					var typeid = $('#typeid').val();
			    	if(typeid == 1 || typeid == 5){
						var gettpl1 = document.getElementById('halflist_tpl').innerHTML;
					}else if(typeid == 2){
						var gettpl1 = document.getElementById('packagelist_tpl').innerHTML;
					}else if(typeid == 3){
						var gettpl1 = document.getElementById('rushlist_tpl').innerHTML;
					}else if(typeid == 4){
						var gettpl1 = document.getElementById('couponlist_tpl').innerHTML;
					}else if(typeid == 6){
						var gettpl1 = document.getElementById('rushlist_tpl').innerHTML;
					}else if(typeid == 7){
						var gettpl1 = document.getElementById('integrallist_tpl').innerHTML;
					}
					laytpl(gettpl1).render(contentdata, function(html){
						if(hisData == 1){
							if(his_init == 1){
								$(".storelist").append(html);
							}
							his_init = 1;
						}else{
							$(".storelist").append(html);
						}
					});
					pindex++;
					setTimeout(function() {
						$(".loading_more").hide();
					}, 100);
		    	}else{
					$(".weui-loadmore_line").show();
					$(".loading_more").hide();
					endmark = 1;
				}
		    }

			function addItems() {
				if (loading) return;
				loading = true;
				addflag = 0;
				var dayflag = $('#dayflag').val();
				var cateid = $('#cateid').val();
				var typeid = $('#typeid').val();
				var cardid = $('.swiper-slide-active').attr('cardid');
				if(!cardid){
					cardid = $('.membercards:first').attr('cardid');
				}
				$.post("{php echo app_url('halfcard/halfcard_app/getstore')}",
					{pindex:pindex,dayflag:dayflag,cateid:cateid,typeid:typeid,cardid:cardid,lng:longitude,lat:latitude,packcaid:packcaid,halfcaid:halfcaid},
					function(d){
				    loading = false;
					if(d.length){
						sessionStorage.setItem("demokey",JSON.stringify(d));
						var contentdata = d.slice(0,pagesize);
						inputtpl(contentdata);
					}else{
						$(".weui-loadmore_line").show();
						$(".loading_more").hide();
						endmark = 1;
					}
				}, 'json');
				setTimeout(function() {
					$(".loading_more").hide();
				}, 100);
			}
			$(page).on('infinite', '.infinite-scroll-bottom',function() {
				if(loading || endmark){
					return;
				}else{
					loading = true;
					$(".loading_more").show();
					setTimeout(function() {
						loading = false;
						var dt = JSON.parse(sessionStorage.getItem("demokey"));
						var xxx = dt.slice(pindex*pagesize,pindex*pagesize+pagesize);
						inputtpl(xxx);
					}, 500);
				}
			});

			$('.time-item').click(function(){
				$('.time-item').each(function(){
					$(this).removeClass('active');
				});
				$(this).addClass('active');
				var dayflag = $(this).attr('dayflag');
				$('#dayflag').val(dayflag);
				pindex = 0;
				endmark = 0;
				$('.storelist').html('');
				$(".loading_more").show();
				$('.weui-loadmore_line').hide();
				addItems();
			});

			$('.packtype').click(function() {
				$('.packtype').each(function() {
					$(this).removeClass('active');
				});
				$(this).addClass('active');
				packcaid = $(this).attr('packcaid');
				pindex = 0;
				endmark = 0;
				$('.storelist').html('');
				$(".loading_more").show();
				$('.weui-loadmore_line').hide();
				addItems();
			});

			$('.halftype').click(function() {
				$('.halftype').each(function() {
					$(this).removeClass('active');
				});
				$(this).addClass('active');
				halfcaid = $(this).attr('halfcaid');
				pindex = 0;
				endmark = 0;
				$('.storelist').html('');
				$(".loading_more").show();
				$('.weui-loadmore_line').hide();
				addItems();
			});

			$('.kks').click(function(){
				if(loading){
					return;
				}
				$('.kks').each(function(){
					$(this).removeClass('active');
				});
				$(this).addClass('active');
				var type = $(this).attr('type');
				$("#typeid").val(type);
				if(type == 1){
					$('#choiceday').show();
					$('#packcate').hide();
					$('#halfcate').show();
				}else if(type == 2){
					$('#choiceday').hide();
					$('#packcate').show();
					$('#halfcate').hide();
				}else if(type == 5){
					$('#choiceday').hide();
					$('#packcate').hide();
					$('#halfcate').show();
				}else{
					$('#choiceday').hide();
					$('#packcate').hide();
					$('#halfcate').hide();
				}
				pindex = 0;
				endmark = 0;
				$('.storelist').html('');
				$(".loading_more").show();
				$('.weui-loadmore_line').hide();
				addItems();
			});

			$('.addfriend-close').click(function(){
				$('#qrcode').hide();
			});
			var useflag = "{$useflag}";
			if(useflag>0){
				var actid = "{$actid}";
				var type = "{$type}";
				var sid = "{$_GPC['tosid']}"
				getpacks(actid,type,sid);
			}

		});
		$.init();

		window.onunload = function(){
			var hisDataItem = {};
			hisDataItem.hisUrl = encodeURI(window.location.href+"&aid={$_W['aid']}");
			hisDataItem.data = $('.storelist').html();
			hisDataItem.scrollTop = $('.infinite-scroll').scrollTop();
			hisDataItem.page = pindex;
			hisDataItem.packcaid = packcaid;
			hisDataItem.halfcaid = halfcaid;
			hisDataItem.dayflag = $('#dayflag').val();
			hisDataItem.typeid = $('#typeid').val();
			common.History_pag(hisDataItem);
		}
   });
</script>
{php include wl_template('common/footer');}