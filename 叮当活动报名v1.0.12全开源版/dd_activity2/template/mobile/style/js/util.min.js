function loadFont(font) {
	var width_now, span = document.createElement("span");
	span.innerHTML = "gW@i#Q!T";
	span.style.visibility = "hidden";
	span.style.fontSize = "50px";
	document.body.appendChild(span);
	width_now = span.offsetWidth;
	span.style.fontFamily = font;
	setTimeout(function(){document.body.removeChild(span);span = null;});
};
window.onload = function() {
	loadFont("Muiext");
	loadFont("FontAwesome")
};
(function(window) {
	'use strict';
	var console = window.console || {log: function() {}};
	util.decode = function(a) {
		return unescape(a.replace(/\\(u[0-9a-fA-F]{4})/gm, "%$1"))
	};
	util.tips = function(msg, speed) {
		speed || (speed = 1500);
		var modalobj = $("#tips-container");
		0 == modalobj.length && ($(document.body).append('<div id="tips-container" class="text-center"><span></span></div>'), modalobj = $("#tips-container"));
		var reg = /^\".*\"$/;
		msg = reg.test(msg) ? eval(msg) : util.decode(msg), modalobj.hide().find("span").html(msg), $("#tips-container").fadeIn(), $("#tips-container").fadeOut(speed)
	};
	util.randomChar = function(l){
		var  x="0123456789qwertyuioplkjhgfdsazxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM";
		var  tmp="";
		//var timestamp = new Date().getTime();
		for(var i=0;i < l;i++)  {
			tmp  +=  x.charAt(Math.ceil(Math.random()*100000000)%x.length);
		}
		return tmp;
	};
	util.img = function(a, b, c) {
		require(["webuploader", "cropper", "previewer"]);
		var Rndid = util.randomChar(32);
		var templates=new Array();
		templates["image.html"]='<div class="webuploader-pick"></div><div id="rt_'+Rndid+'" style="position: absolute; top: 0px; width:100%; height:100%; overflow: hidden; bottom: auto; right: auto;"><input type="file" name="file" class="webuploader-element-invisible avatar-input"><label style="opacity: 0; width: 100%; height: 100%; display: block; cursor: pointer; background: rgb(255, 255, 255);"></label></div>';
		a = $(a), a.html(templates["image.html"]).addClass('webuploader-container');
		var r = a.find('#rt_'+Rndid);
		r.find('label').on('click',function(e){
			r.find('.avatar-input').click();
		}),r.find('.avatar-input').on('change',function(e){
			CropAvatar.change($(this));
		});
		var o, imageName, imageType = 'image/jpeg', i = util.querystring("i"), j = util.querystring("j"),
			CropAvatar = {
				change: function(f) {
					var files,file;
					files = f.prop('files');
					if (files.length > 0) {
						file = files[0];
						imageType = file.type;
						imageName = file.name;
						if (this.isImageFile(file)) {
							if (this.url) {
								URL.revokeObjectURL(this.url); // Revoke the old one
							}
							this.url = URL.createObjectURL(file);
							this.renderCrop();//渲染裁切窗口
							this.startCropper();
							
						}else{
							util.tips('请选择图片类型');
						}
					}
				},
				isImageFile: function(file) {
					if (file.type) {
						return /^image\/\w+$/.test(file.type);
					} else {
						return /\.(jpg|jpeg|png|gif)$/.test(file);
					}
				},
				startCropper: function() {
					var _this = this, a;
					o = $(document.body).find('.avatar-wrapper');
					a = o.find("img");
					//console.log(this.url);
					if (this.active) {
						a.cropper('replace', this.url);
					} else {
						a.cropper({
							aspectRatio: c.aspectRatio?c.aspectRatio:NaN,
							preview: c.preview?c.preview:'',
							viewMode: 1,
							dragMode: 'move',
							autoCropArea: 0.75,
							restore:!1,
							cropBoxMovable:1,
							cropBoxResizable:c.resizable
						}),
						o.find(".js-submit").on("click",function() {
							util.loading();
							setTimeout(function(){
								var _width, _height,pxSize=c.pxSize?c.pxSize:750;
								if (_this.getImageSize().width > pxSize){
									_width = _height = pxSize;
								}else{
									_width =_this.getImageSize().width, _height= _this.getImageSize().height;
								}
								console.log(_width+','+_height);
								var result = a.cropper('getCroppedCanvas', {width: _width, height: _height}, imageType);
								var Base64Url = result.toDataURL(imageType, 0.85);
								_this.ajaxUpload(Base64Url);
							},100);
							return false;
						}),
						o.find(".js-cancel").one("click",function() {
							_this.stopCropper();
                            o.remove();
                        });
						this.active = true;
					}
				},
				getImageSize: function() {
					var img = new Image();
					img.src = o.find("img").attr("src");
					return {width: img.width, height: img.height};
				},
				stopCropper: function() {
					if (this.active) {
						o.find("img").cropper('destroy');
						o.find("img").remove();
						this.active = false;
					}
					r.find('.avatar-input').val('');
				},
				 readBlobAsDataURL: function (blob, callback) {
					var a = new FileReader();
					a.onload = function(e) {callback(e.target.result);};
					a.readAsDataURL(blob);
				}
				,
				ajaxUpload: function(Base64Url) {
					var _this = this;
					//var file = new File([this.Base64UrlToBlob(Base64Url, imageType)], imageName,{type: imageType});
					//console.log(file);
					var formData = new FormData();
					//formData.append("file", file);
					formData.append("file", this.Base64UrlToBlob(Base64Url, imageType));
					formData.append("name", imageName);
					//console.log(formData.get('name'));
					//url: '../app/index.php?i=' + i + '&c=entry&m=fx_activity&do=utility&ac=file&op=upload',自定义
					//url: './index.php?i='+i+'&j='+j+'&c=utility&a=file&do=upload&type=image',
					$.ajax({
						url: '../app/index.php?i=' + i + '&c=entry&m=fx_activity&do=utility&ac=file&op=upload',
						type: 'post',
						data: formData,
						timeout: 4194304,
						//超时时间设置，单位毫秒  
						async: false,
						cache: false,
						contentType: false,
						processData: false,
						success: function(data) {
							//console.log(data);
							util.loading().close();
							_this.submitDone(data);
						},
						error: function(XMLHttpRequest, textStatus, errorThrown) {
							_this.submitFail(textStatus || errorThrown);
						}
					});
				},
				submitDone: function(data) {
					var _this = this,json = JSON.parse(data),message = '上传成功';
					if($.isFunction(b)) b(json);
					if(json.error.code==1) message = json.error.message;
					setTimeout(function(){o.css({'opacity':0,'transform':'translate3d(0,-100%,0)','-webkit-transform':'translate3d(0,-100%,0)'});});
					setTimeout(function(){util.tips(message);_this.cropDone();},1200);
					//修复微擎附件uniacid、uid为0问题
					$.post('../app/index.php?i=' + i + '&c=entry&m=fx_activity&do=utility&ac=file&op=update',{id:json.id});
				},
				submitFail: function(msg) {
					this.alert(msg);
				},
				cropDone: function() {
					o.remove();
					this.stopCropper();
				},
				alert: function(msg) {
					var $alert = ['<div class="alert alert-danger avatar-alert alert-dismissable">', '<button type="button" class="close" data-dismiss="alert">&times;</button>', msg, '</div>'].join('');
				},
				Base64UrlToBlob: function(urlData, filetype) {
					//去掉url的头，并转换为byte
					var bytes = window.atob(urlData.split(',')[1]);
		
					//处理异常,将ascii码小于0的转换为大于0
					var ab = new ArrayBuffer(bytes.length);
					var ia = new Uint8Array(ab);
					for (var i = 0; i < bytes.length; i++) {
						ia[i] = bytes.charCodeAt(i);
					}
					// 类型
					if (filetype === '' || !filetype) {
						filetype = 'image/png';
					}
					return new Blob([ab], {type: filetype});
				},
				renderCrop: function() {
					// 渲染Crop
					var _wh = $(window).height();
					var cropElement = '<div class="avatar-wrapper fadeInDownBig animated js-avatar-preview avatar-preview""><img id="imageData" src="' + this.url + '"><div class="bar-action mui-clearfix"><a href="javascript:;" class="mui-pull-left js-cancel">取消</a> <a href="javascript:;" class="mui-pull-right mui-text-right js-submit">选取</a></div></div>'
					//this.$__E.children(':first').before(cropElement);
					$(document.body).prepend(cropElement);
					$(document.body).find('.avatar-wrapper').css({position:"relative",'z-index':"9999",height: _wh + "px",'-webkit-transition':'-webkit-transform .5s,opacity .3s','transition':'transform .5s,opacity .3s'}).removeClass('animated');
				}
		}
	};
	util.location = function(callback) {
		//navigator.userAgent.match(/wechatdevtools/i)
		var api_url = "//3gimg.qq.com/lightmap/components/geolocation/geolocation.min.js";
		require([api_url], function (){
			var geolocation = new qq.maps.Geolocation("OB4BZ-D4W3U-B7VVO-4PJWW-6TKDJ-WPB77", "myapp");
			var options = {timeout: 9000};
			function showPosition(position) {
				position.ucity = '';
				$.setCookie("position", JSON.stringify(position), 'd1');
				if($.isFunction(callback)) {
					callback(position);
				}
			};
			function showErr() {
				alert('获取位置信息失败，请检查位置功能是否开启');
			};
			geolocation.getLocation(showPosition, showErr, options);
		});
	};
	util.ios = function() {
		var u = navigator.userAgent;
		var isIOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);
		if (isIOS) return true;
	};
	util.pad = function(num, n) {  
		var len = num.toString().length;  
		while(len < n) {  
			num = "0" + num;  
			len++;  
		}  
		return num;  
	};
})(window);