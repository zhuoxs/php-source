define(['jquery.ui', '../../../../static/js/web/goods_selector.js'], function (ui, gSelector) {
    var modal = {initnav: [], selected: 'page',};
    modal.init = function (params) {
        modal.attachurl = params.attachurl;
        modal.type = params.type;
        modal.data = params.data;
        modal.diyadvs = params.diyadvs;
        modal.id = params.id;
        if (modal.data) {
            modal.page = modal.data.page;
            modal.items = modal.data.items
        } else {
            if(modal.type==2){
                modal.items = modal.defaultItems();
            };
            if(modal.type==3){
                modal.items = modal.defaultItems3();
            };
            if(modal.type==4){
                modal.items = modal.defaultItems4();
            };
            if(modal.type==5){
                modal.items = modal.defaultItems5();
            };
        }
        modal.initTpl();
        modal.initPage();
        modal.initItems();
        modal.initNavs();
        modal.initSortable();
        modal.initClick();
        modal.initWindow();

        //复制组件
        $(".diy-toolbar .btn-copy").unbind('click').click(function (e) {
            var itemid = modal.selected;
            var id = modal.items[itemid].id;
            var item = JSON.parse(JSON.stringify(modal.items[itemid]));
            delete item.name;
            if (!item) {
                tip.msgbox.err("未找到此元素！");
                return
            }
            var itemTplShow = $("#tpl_show_" + id).length;
            var itemTplEdit = $("#tpl_edit_" + id).length;
            if (itemTplShow == 0 || itemTplEdit == 0) {
                tip.msgbox.err("添加失败！模板错误，请刷新页面重试");
                return
            }
            if (id === 'diymod') {
                modal.initMod(item);
                return
            }
            var itemid = modal.getId("M", 0);
            if (item.data) {
                var itemData = JSON.parse(JSON.stringify(item.data));
                var newData = {};
                var index = 0;
                $.each(itemData, function (id, data) {
                    var childid = modal.getId("C", index);
                    newData[childid] = data;
                    delete childid;
                    index++
                });
                item.data = newData
            }
            if (item.max && item.max > 0) {
                var itemNum = modal.getItemNum(id);
                if (itemNum > 0 && itemNum >= item.max) {
                    tip.msgbox.err("此元素最多允许添加 " + item.max + " 个");
                    return
                }
            }
            if(item.only && item.only == 'toptab'){
                var itemNum = modal.getItemOnlyNum(item.only);
                if (itemNum > 0) {
                    tip.msgbox.err("已有顶部固定元素，请删除后再添加");
                    return;
                }
            }
            var append = true;
            if (modal.selected && modal.selected != 'page') {
                var thisitem = modal.items[modal.selected];
                if (thisitem.id == 'detail_navbar' || thisitem.id == 'detail_pullup' || id == 'detail_navbar' || id == 'detail_pullup') {
                    append = false
                }
            }

            if (item.istop) {
                var newItems = {};
                newItems[itemid] = item;
                $.each(modal.items, function (id, eachitem) {
                    newItems[id] = eachitem
                });
                modal.items = newItems
            } else if (modal.selected && modal.selected != 'page' && append) {
                var newItems = {};
                $.each(modal.items, function (id, eachitem) {
                    newItems[id] = eachitem;
                    if (id == modal.selected) {
                        newItems[itemid] = item
                    }
                });
                modal.items = newItems
            }

            modal.initItems();
            $(".drag[data-itemid='" + itemid + "']").trigger('mousedown').trigger('click');
            modal.selected = itemid
        });

        //右边-删除
        $(".diy-toolbar .btn-del").unbind('click').click(function (e) {
            var itemid = modal.selected;
            console.log(itemid);
            var nodelete = $(this).closest(".drag").hasClass("nodelete");
            if (nodelete) {
                tip.alert("此元素禁止删除");
                return
            }
            tip.confirm("确定删除吗", function () {
                var nearid = modal.getNear(itemid);
                delete modal.items[itemid];
                modal.initItems();
                if (nearid) {
                    $(document).find(".drag[data-itemid='" + nearid + "']").trigger('mousedown')
                } else {
                    $("#page").trigger('click')
                }
            })
        });
    };
    modal.initTpl = function () {
        tpl.helper("imgsrc", function (src) {
            if (typeof src != 'string') {
                return ''
            }
            if (src.indexOf('http://') == 0 || src.indexOf('https://') == 0 || src.indexOf('../addons/ewei_shopv2/') == 0) {
                return src
            } else if (src.indexOf('images/') == 0 || src.indexOf('audios/') == 0 || src.indexOf('videos/') == 0) {
                return modal.attachurl + src
            }
        });
        tpl.helper("decode", function (content) {
            return $.base64.decode(content)
        });
        tpl.helper("toArray", function (data) {
            var oldArray = $.makeArray(data);
            var newArray = [];
            $.each(data, function (itemid, item) {
                newArray.push(item)
            });
            return newArray
        });
        tpl.helper("count", function (data) {
            return modal.length(data)
        });
        tpl.helper("define", function (str) {
            var str
        });
    };
    modal.initPage = function (initE) {
        if (typeof(initE) === 'undefined') {
            initE = true
        }
        if (!modal.page) {
            modal.page = {
                type: modal.type,
                title: '请输入页面标题',
                name: '未命名页面',
                desc: '',
                icon: '',
                background: '#f3f3f3',
                titlebarbg: '#ffffff',
                titlebarcolor: '#000000',
            }
            if(modal.type=='5'){
                modal.page.seckill = {
                    style:'style1',
                    color:'red'
                }
            }
        }else{
            if(modal.type=='5' && !modal.page.seckill){
                modal.page.seckill = {
                    style: 'style1',
                    color: 'red'
                }
            }
        }
        $("#page").text(modal.page.title).css({
            color: modal.page.titlebarcolor,
            backgroundColor: modal.page.titlebarbg
        });
        $("#phone").css({'background-color': modal.page.background});
        $("#phone").find(".drag").removeClass("selected");
        if(modal.page.seckill){
            if(modal.page.seckill.style=='style1'){
                $("#phone").addClass(modal.page.seckill.style).removeClass('style2')
            }else{
                $("#phone").addClass(modal.page.seckill.style).removeClass('style1')
            }
            $("#phone").closest('.phone-body').removeClass().addClass('phone-body').addClass(modal.page.seckill.color)
        }
        if (initE) {
            modal.initEditor()
        }
        modal.initTilteBg()
    };
    modal.defaultItems = function () {
        return {
            "M1506332563879": {
                "params": {"placeholder": "请输入关键字进行搜索"},
                "style": {
                    "inputbackground": "#ffffff",
                    "background": "#f1f1f2",
                    "iconcolor": "#b4b4b4",
                    "color": "#999999",
                    "paddingtop": "10",
                    "paddingleft": "10",
                    "textalign": "left",
                    "searchstyle": ""
                },
                "id": "search"
            },
            "M1506332568231": {
                "style": {
                    "dotstyle": "round",
                    "dotalign": "center",
                    "background": "#ffffff",
                    "opacity": "0.8"
                },
                "data": {
                    "C1506332568231": {
                        "imgurl": "../addons/ewei_shopv2/plugin/app/static/images/default/banner-1.jpg",
                        "linkurl": ""
                    },
                    "C1506332568232": {
                        "imgurl": "../addons/ewei_shopv2/plugin/app/static/images/default/banner-2.jpg",
                        "linkurl": ""
                    }
                },
                "id": "banner"
            },
            "M1506332575975": {
                "params": {
                    "iconurl": "../addons/ewei_shopv2/static/images/hotdot.jpg",
                    "noticedata": "0",
                    "speed": "4",
                    "noticenum": "5"
                },
                "style": {
                    "background": "#ffffff",
                    "iconcolor": "#fd5454",
                    "color": "#666666",
                    "bordercolor": "#e2e2e2"
                },
                "data": {
                    "C1506332575975": {"title": "这里是第一条自定义公告的标题", "linkurl": ""},
                    "C1506332575976": {"title": "这里是第二条自定义公告的标题", "linkurl": ""}
                },
                "id": "notice"
            },
            "M1506332584255": {
                "style": {
                    "navstyle": "",
                    "background": "#ffffff",
                    "rownum": "4",
                    "showtype": "0",
                    "pagenum": "8",
                    "showdot": "1"
                },
                "data": {
                    "C1506332584255": {
                        "imgurl": "../addons/ewei_shopv2/plugin/app/static/images/default/icon-1.png",
                        "linkurl": "",
                        "text": "按钮文字1",
                        "color": "#666666"
                    },
                    "C1506332584256": {
                        "imgurl": "../addons/ewei_shopv2/plugin/app/static/images/default/icon-2.png",
                        "linkurl": "",
                        "text": "按钮文字2",
                        "color": "#666666"
                    },
                    "C1506332584257": {
                        "imgurl": "../addons/ewei_shopv2/plugin/app/static/images/default/icon-3.png",
                        "linkurl": "",
                        "text": "按钮文字3",
                        "color": "#666666"
                    },
                    "C1506332584258": {
                        "imgurl": "../addons/ewei_shopv2/plugin/app/static/images/default/icon-4.png",
                        "linkurl": "",
                        "text": "按钮文字4",
                        "color": "#666666"
                    }
                },
                "id": "menu"
            },
            "M1506332586927": {
                "style": {
                    "navstyle": "",
                    "background": "#ffffff",
                    "rownum": "4",
                    "showtype": "0",
                    "pagenum": "8",
                    "showdot": "1"
                },
                "data": {
                    "C1506332586927": {
                        "imgurl": "../addons/ewei_shopv2/plugin/app/static/images/default/icon-1.png",
                        "linkurl": "",
                        "text": "按钮文字1",
                        "color": "#666666"
                    },
                    "C1506332586928": {
                        "imgurl": "../addons/ewei_shopv2/plugin/app/static/images/default/icon-2.png",
                        "linkurl": "",
                        "text": "按钮文字2",
                        "color": "#666666"
                    },
                    "C1506332586929": {
                        "imgurl": "../addons/ewei_shopv2/plugin/app/static/images/default/icon-3.png",
                        "linkurl": "",
                        "text": "按钮文字3",
                        "color": "#666666"
                    },
                    "C1506332586930": {
                        "imgurl": "../addons/ewei_shopv2/plugin/app/static/images/default/icon-4.png",
                        "linkurl": "",
                        "text": "按钮文字4",
                        "color": "#666666"
                    }
                },
                "id": "menu"
            },
            "M1506332594040": {
                "params": {
                    "showtitle": "1",
                    "showprice": "1",
                    "goodsdata": "0",
                    "cateid": "",
                    "catename": "",
                    "groupid": "",
                    "groupname": "",
                    "goodssort": "0",
                    "goodsscroll": "0",
                    "goodsnum": "6",
                    "showicon": "1",
                    "iconposition": "left top",
                    "productprice": "1",
                    "showproductprice": "0",
                    "showsales": "0",
                    "productpricetext": "原价",
                    "salestext": "销量",
                    "productpriceline": "0",
                    "saleout": "0"
                },
                "style": {
                    "background": "#f3f3f3",
                    "liststyle": "block",
                    "buystyle": "buybtn-1",
                    "goodsicon": "recommand",
                    "iconstyle": "triangle",
                    "pricecolor": "#ff5555",
                    "productpricecolor": "#999999",
                    "iconpaddingtop": "0",
                    "iconpaddingleft": "0",
                    "buybtncolor": "#ff5555",
                    "iconzoom": "100",
                    "titlecolor": "#000000",
                    "tagbackground": "#fe5455",
                    "salescolor": "#999999"
                },
                "data": {
                    "C1506332594040": {
                        "thumb": "../addons/ewei_shopv2/plugin/app/static/images/default/goods-1.jpg",
                        "price": "20.00",
                        "productprice": "99.00",
                        "title": "这里是商品标题",
                        "sales": "0",
                        "gid": "",
                        "ctype": "1"
                    },
                    "C1506332594041": {
                        "thumb": "../addons/ewei_shopv2/plugin/app/static/images/default/goods-2.jpg",
                        "price": "20.00",
                        "productprice": "99.00",
                        "title": "这里是商品标题",
                        "sales": "0",
                        "gid": "",
                        "ctype": "1"
                    },
                    "C1506332594042": {
                        "thumb": "../addons/ewei_shopv2/plugin/app/static/images/default/goods-3.jpg",
                        "price": "20.00",
                        "productprice": "99.00",
                        "sales": "0",
                        "title": "这里是商品标题",
                        "gid": "",
                        "ctype": "0"
                    },
                    "C1506332594043": {
                        "thumb": "../addons/ewei_shopv2/plugin/app/static/images/default/goods-4.jpg",
                        "price": "20.00",
                        "productprice": "99.00",
                        "sales": "0",
                        "title": "这里是商品标题",
                        "gid": "",
                        "ctype": "0"
                    }
                },
                "id": "goods"
            }
        }
    };
    modal.defaultItems3 = function () {
        return {
            "M1519884909408": {
                "type": "3",
                "params": {
                    "style": "default1",
                    "leftnav": "充值",
                    "rightnav": "兑换",
                    /*"seticon": 'icon-edit'*/                },
                "style": {
                    "background": "#fe5455",
                    "textcolor": "#ffffff",
                    "textlight": "#fef31f",
                    "headstyle": ""
                },
                "id": "member"
            },
            "M1519884912926": {
                "style": {
                    "margintop": "9",
                    "titlecolor": "#ff0011",
                    "textcolor": "#999999",
                    "iconcolor": "#999999"
                },
                "params": {
                    "title": "绑定手机号",
                    "text": "如果您用手机号注册过会员或您想通过微信外购物请绑定您的手机号码",
                    "iconclass": "icon-shouji"
                },
                "id": "bindmobile"
            },
            "M1519884989438": {
                "style": {
                    "margintop": "10",
                    "background": "#ffffff",
                    "iconcolor": "#999999",
                    "textcolor": "#000000",
                    "remarkcolor": "#888888"
                },
                "data": {
                    "C1519884989438": {
                        "text": "我的订单",
                        "linkurl": "\/pages\/order\/index",
                        "iconclass": "icox-shop",
                        "remark": "查看",
                        "dotnum": ""
                    }
                },
                "id": "listmenu"
            },
            "M1519884959829": {
                "params": {
                    "rownum": "4",
                    "border": "1",
                    "bordertop": "1",
                    "borderbottom": "1"
                },
                "style": {
                    "background": "#ffffff",
                    "bordercolor": "#ffffff",
                    "textcolor": "#000000",
                    "iconcolor": "#666666",
                    "dotcolor": "#ff0011"
                },
                "data": {
                    "C1519884959829": {
                        "iconclass": "icox-daifukuan1",
                        "text": "待付款",
                        "linkurl": "",
                        "dotnum": "0"
                    },
                    "C1519884959830": {
                        "iconclass": "icox-daifahuo1",
                        "text": "待发货",
                        "linkurl": "",
                        "dotnum": "0"
                    },
                    "C1519884959831": {
                        "iconclass": "icox-daishouhuo1",
                        "text": "待收货",
                        "linkurl": "",
                        "dotnum": "0"
                    },
                    "C1519884959832": {
                        "iconclass": "icox-daituikuan2",
                        "text": "退换货",
                        "linkurl": "",
                        "dotnum": "0"
                    }
                },
                "id": "icongroup"
            },
            "M1519885061238": {
                "style": {
                    "margintop": "10",
                    "background": "#ffffff",
                    "iconcolor": "#999999",
                    "textcolor": "#000000",
                    "remarkcolor": "#888888"
                },
                "data": {
                    "C1519885061238": {
                        "text": "我的购物车",
                        "linkurl": "",
                        "iconclass": "icox-shop",
                        "remark": "查看",
                        "dotnum": ""
                    },
                    "C1519885061239": {
                        "text": "我的关注",
                        "linkurl": "",
                        "iconclass": "icox-shop",
                        "remark": "查看",
                        "dotnum": ""
                    },
                    "C1519885061240": {
                        "text": "我的足迹",
                        "linkurl": "",
                        "iconclass": "icox-shop",
                        "remark": "查看",
                        "dotnum": ""
                    }
                },
                "id": "listmenu"
            },
            "M1520230074322": {
                "isbottom": "1",
                "max": "1",
                "style": {
                    "showtype": "0"
                },
                "params": {
                    "showimg": "1",
                    "copyright": "版权所有 XXX商城",
                    "imgurl": "..\/addons\/ewei_shopv2\/plugin\/app\/static\/images\/default\/copyright.png"
                },
                "id": "copyright"
            }
        }
    };
    modal.defaultItems4 = function () {
        return {
            "M1519886070303": {
                "type": "4",
                "max": "1",
                "style": {
                    "dotstyle": "rectangle",
                    "dotalign": "left",
                    "background": "#ffffff",
                    "leftright": "5",
                    "bottom": "5",
                    "opacity": "0.8"
                },
                "id": "detail_swipe"
            },
            "M1519886077750": {
                "type": "4",
                "max": "1",
                "params": {
                },
                "style": {
                    "theme":"red"
                },
                "id": "detail_seckill"
            },
            "M1519886077751": {
                "type": "4",
                "max": "1",
                "params": {
                    "hideshare": "0",
                    "share": "分享",
                    "share_link": "",
                    "share_icon": "icon-share"
                },
                "style": {
                    "margintop": "0",
                    "marginbottom": "0",
                    "background": "#ffffff",
                    "titlecolor": "#000000",
                    "subtitlecolor": "#999999",
                    "pricecolor": "#ff5555",
                    "textcolor": "#cccccc",
                    "timecolor": "#fff2e2",
                    "timetextcolor": "#ef4f4f"
                },
                "id": "detail_info"
            },
            "M1519886083903": {
                "type": "4",
                "max": "1",
                "style": {
                    "margintop": "0",
                    "marginbottom": "0",
                    "background": "#ffffff",
                    "textcolor": "#666666",
                    "textcolorhigh": "#ef4f4f"
                },
                "data": {
                    "C1519886083903": {
                        "name": "商品预售",
                        "type": "yushou"
                    },
                    "C1519886083904": {
                        "name": "二次购买",
                        "type": "erci"
                    },
                    "C1519886083905": {
                        "name": "会员价",
                        "type": "huiyuan"
                    },
                    "C1519886083906": {
                        "name": "优惠",
                        "type": "youhui"
                    },
                    "C1519886083907": {
                        "name": "积分",
                        "type": "jifen"
                    },
                    "C1519886083908": {
                        "name": "不配送区域",
                        "type": "bupeisong"
                    },
                    "C1519886083909": {
                        "name": "商品标签",
                        "type": "biaoqian"
                    },
                    "C1519886083910": {
                        "name": "可用优惠券",
                        "type": "coupon"
                    },
                    "C1519886083911": {
                        "name": "全返",
                        "type": "fullback"
                    }
                },
                "id": "detail_sale"
            },
            "M1519886090456": {
                "type": "4",
                "max": "1",
                "style": {
                    "background": "#ffffff",
                    "textcolor": "#333333",
                    "margintop": "10",
                    "marginbottom": "0"
                },
                "id": "detail_spec"
            },
            "M1519886113758": {
                "type": "4",
                "max": "1",
                "params": {
                    "shoplogo": "..\/addons\/ewei_shopv2\/static\/images\/designer.jpg",
                    "shopname": "",
                    "shopdesc": "",
                    "hidenum": "0",
                    "leftnavtext": "全部商品",
                    "leftnavlink": "",
                    "rightnavtext": "进店逛逛",
                    "rightnavlink": ""
                },
                "style": {
                    "margintop": "10",
                    "marginbottom": "0",
                    "background": "#ffffff",
                    "goodsnumcolor": "#333333",
                    "goodstextcolor": "#7c7c7c",
                    "rightnavcolor": "#ff5555",
                    "shopnamecolor": "#333333",
                    "shopdesccolor": "#444444"
                },
                "id": "detail_shop"
            },
            // "M1519886119920": {
            //     "type": "4",
            //     "max": "1",
            //     "style": {
            //         "margintop": "10",
            //         "marginbottom": "10",
            //         "background": "#ffffff",
            //         "maincolor": "#fd5454",
            //         "subcolor": "#000",
            //         "textcolor": "#333333"
            //     },
            //     "id": "detail_comment"
            // },
            "M1519886128767": {
                "type": "4",
                "max": "1",
                "params": {
                    "hidelike": "0",
                    "hideshop": "0",
                    "hidecart": "0",
                    "hidecartbtn": "0",
                    "textbuy": "立刻购买",
                    "goodstext": "商品",
                    "liketext": "关注",
                    "likeiconclass": "icox-like",
                    "likelink": "icox-like",
                    "shoptext": "店铺",
                    "shopiconclass": "icox-shop",
                    "carttext": "购物车",
                    "carticonclass": "icox-cart"
                },
                "style": {
                    "background": "#ffffff",
                    "textcolor": "#999999",
                    "iconcolor": "#999999",
                    "cartcolor": "#fe9402",
                    "buycolor": "#fd5555",
                    "dotcolor": "#ff0011"
                },
                "id": "detail_navbar"
            }
        }
    };
    modal.defaultItems5 = function () {
        return {
            "M1519886070302": {
                "type": "5",
                "max": "1",
                "noEdit":true,
                "style": {
                },
                "id": "seckill_times"
            },
            "M1519886077750": {
                "type": "5",
                "max": "1",
                "noEdit":true,
                "params": {
                },
                "style": {
                },
                "id": "seckill_rooms"
            },
            "M1519886083902": {
                "type": "5",
                "max": "1",
                "style": {
                },
                "data": {
                    "C1506342568231": {
                        "imgurl": "../addons/ewei_shopv2/plugin/app/static/images/default/goods-1.jpg",
                        "linkurl": ""
                    },
                    "C1506342568232": {
                        "imgurl": "../addons/ewei_shopv2/plugin/app/static/images/default/goods-2.jpg",
                        "linkurl": ""
                    },
                    "C1506342568233": {
                        "imgurl": "../addons/ewei_shopv2/plugin/app/static/images/default/goods-3.jpg",
                        "linkurl": ""
                    }
                },
                "id": "seckill_advs"
            },
            "M1519886090455": {
                "type": "5",
                "max": "1",
                "noEdit":true,
                "style": {
                },
                "id": "seckill_list"
            },
        }
    };
    modal.initTilteBg = function () {
        var RgbValue = $('#page')[0].style.backgroundColor.replace("rgb(", "").replace(")", "");
        var RgbValueArry = RgbValue.split(",");
        var grayLevel = RgbValueArry[0] * 0.299 + RgbValueArry[1] * 0.587 + RgbValueArry[2] * 0.114;
        var imgsrc = grayLevel > 192 ? 'wx-top2' : 'wx-top';
        $('#page').css('background-image', 'url("../addons/ewei_shopv2/plugin/app/static/images/' + imgsrc + '.png")')
    };
    modal.initItems = function (selected) {
        var phone = $("#phone");
        if (!modal.items) {
            modal.items = {};
            return
        }
        phone.empty();
        $.each(modal.items, function (itemid, item) {
            if (typeof(item.id) !== 'undefined') {
                var newItem = $.extend(true, {}, item);
                newItem.itemid = itemid;
                var html = tpl("tpl_show_" + item.id, newItem);
                $("#phone").append(html)
            }
        });
        var btnhtml = $("#edit-del").html();
        $("#phone .drag").append(btnhtml);
        $("#phone .drag .btn-edit-del .btn-del").unbind('click').click(function (e) {
            e.stopPropagation();
            var drag = $(this).closest(".drag");
            var itemid = drag.data('itemid');
            var nodelete = $(this).closest(".drag").hasClass("nodelete");
            if (nodelete) {
                tip.alert("此元素禁止删除");
                return
            }
            tip.confirm("确定删除吗", function () {
                var nearid = modal.getNear(itemid);
                delete modal.items[itemid];
                modal.initItems();
                if (nearid) {
                    $(document).find(".drag[data-itemid='" + nearid + "']").trigger('mousedown')
                } else {
                    $("#page").trigger('click')
                }
            })
        });
        if (selected) {
            modal.selectedItem(selected)
        }
    };
    modal.initNavs = function () {
        modal.setNavs();
        var navgroup = {
            0: ['listmenu', 'richtext', 'title', 'line', 'blank', 'menu', 'menu2', 'picture', 'banner', 'picturew', 'coupon','tabbar','topmenu'],
            2: ['notice', 'goods', 'search', 'fixedsearch','seckillgroup', 'copyright', 'video'],
            20:['notice', 'goods', 'search', 'fixedsearch', 'pictures','icongroup', 'audio', 'copyright', 'video'],
            /*会员中心 @author 青椒 @date 2018/2/10*/
            3: ['member' ,'bindmobile' ,  'notice','verify','pictures','icongroup','audio','copyright'],
            /*商品详情 @author 青椒 @date 2018/2/26*/
            4: ['detail_swipe','detail_seckill','detail_info','detail_sale','detail_spec','detail_package','detail_shop','detail_buyshow','detail_navbar','pictures','icongroup','audio','goods','copyright'],
            /*整点秒杀 @author 牟俊羽 @date 2018/4/09*/
            5: ['seckill_times','seckill_rooms','seckill_advs','seckill_list','audio','icongroup','pictures'],
        };
        var navpage = navgroup[modal.type], globalNavs = [];
        var navpageType = modal.type;
        if (navpage) {
            navpage = $.merge(navpage, navgroup[0])
        } else {
            navpage = navgroup[0]
        }
        $.each(navpage, function (index, val) {
            var params = modal.navs[val];
            if (params) {
                if(navpageType == 4 && val == 'tabbar'){
                    return
                }
                params.id = val;
                if(params.global) {
                    globalNavs.push(params);
                    return;
                }
                modal.initnav.push(params)
            }
        });
        var html = tpl("tpl_navs", {
            basic: modal.initnav,
            global: globalNavs,
            navpageType:navpageType
        });

        $("#navs").html(html).show();
        $("#navs nav").unbind('click').click(function () {
            var id = $(this).data('id');
            if (id === 'page') {
                $("#page").trigger("click");
                return
            }
            var inArray = $.inArray(id, navpage);
            if (inArray < 0) {
                tip.msgbox.err("此页面类型禁止添加此元素！");
                return
            }
            var item = $.extend(true, {}, modal.navs[id]);
            if (!item) {
                tip.msgbox.err("未找到此元素！");
                return
            }
            delete item.name;
            var itemTplShow = $("#tpl_show_" + id).length;
            var itemTplEdit = $("#tpl_edit_" + id).length;
            if (itemTplShow == 0 || itemTplEdit == 0) {
                tip.msgbox.err("添加失败！模板错误，请刷新页面重试");
                return
            }
            var itemid = modal.getId("M", 0);
            if (item.data) {
                var itemData = $.extend(true, {}, item.data);
                var newData = {};
                var index = 0;
                $.each(itemData, function (id, data) {
                    var childid = modal.getId("C", index);
                    newData[childid] = data;
                    delete childid;
                    index++
                });
                item.data = newData
            }

            if (item.max && item.max > 0) {
                var itemNum = modal.getItemNum(id);
                if (itemNum > 0 && itemNum >= item.max) {
                    tip.msgbox.err("此元素最多允许添加 " + item.max + " 个");
                    return
                }
            }

            if(item.only && item.only == 'toptab'){
                var itemNum = modal.getItemOnlyNum(item.only);
                if (itemNum > 0) {
                    tip.msgbox.err("已有顶部固定元素，请删除后再添加");
                    return;
                }
            }

            var append = true;
            if (modal.selected && modal.selected != 'page') {
                var thisitem = modal.items[modal.selected];
                if (thisitem.id == 'detail_navbar' || thisitem.id == 'detail_pullup' || id == 'detail_navbar' || id == 'detail_pullup') {
                    append = false
                }
            }

            if (item.istop) {
                var newItems = {};
                newItems[itemid] = item;
                $.each(modal.items, function (id, eachitem) {
                    newItems[id] = eachitem
                });
                modal.items = newItems
            } else if (modal.selected && modal.selected != 'page' && append) {
                var newItems = {};
                $.each(modal.items, function (id, eachitem) {
                    newItems[id] = eachitem;
                    if (id == modal.selected) {
                        newItems[itemid] = item
                    }
                });
                modal.items = newItems
            } else {
                if (modal.page.type == 4 && modal.items && id != 'detail_navbar') {
                    var navbar = null;
                    var pullup = null;
                    $.each(modal.items, function (newitemid, newitem) {
                        if (newitem.id == 'detail_navbar') {
                            navbar = {itemid: newitemid, item: newitem};
                            delete modal.items[newitemid]
                        } else if (newitem.id == 'detail_pullup') {
                            pullup = {itemid: newitemid, item: newitem};
                            delete modal.items[newitemid]
                        }
                    });
                    modal.items[itemid] = item;
                    if (pullup) {
                        modal.items[pullup.itemid] = pullup.item
                    }
                    if (navbar) {
                        modal.items[navbar.itemid] = navbar.item
                    }
                } else {
                    modal.items[itemid] = item
                }
            }

            modal.initItems();
            $(".drag[data-itemid='" + itemid + "']").trigger('mousedown').trigger('click');
            modal.selected = itemid
        })
    };
    modal.setNavs = function () {
        modal.navs = {
            notice: {
                name: '公告',
                params: {
                    iconurl: '../addons/ewei_shopv2/static/images/hotdot.jpg',
                    noticedata: '0',
                    speed: '4',
                    noticenum: '5'
                },
                style: {background: '#ffffff', iconcolor: '#fd5454', color: '#666666', bordercolor: '#e2e2e2'},
                data: {
                    C0123456789101: {title: '这里是第一条自定义公告的标题', linkurl: ''},
                    C0123456789102: {title: '这里是第二条自定义公告的标题', linkurl: ''}
                }
            },
            title: {
                name: '标题栏',
                params: {title: '', icon: ''},
                style: {
                    background: '#ffffff',
                    color: '#666666',
                    textalign: 'left',
                    fontsize: '12',
                    paddingtop: '5',
                    paddingleft: '5'
                }
            },
            search: {
                name: '搜索框',
                params: {placeholder: '请输入关键字进行搜索'},
                style: {
                    inputbackground: '#ffffff',
                    background: '#f1f1f2',
                    iconcolor: '#b4b4b4',
                    color: '#999999',
                    paddingtop: '10',
                    paddingleft: '10',
                    textalign: 'left',
                    searchstyle: ''
                }
            },
            fixedsearch: {
                name: '固定搜索框',
                istop: 2,
                max: 1,
                only:'toptab',
                params: {
                    leftnav: 1,
                    rightnav: 1,
                    rightnavclick: 0,
                    leftnavicon: 'icox-shop',
                    rightnavicon: 'icox-cart',
                    searchstyle: 'round',
                    placeholder: '输入关键字进行搜索'
                },
                style: {
                    background: '#000000',
                    opacity: 0.8,
                    opacityinput: 0.8,
                    leftnavcolor: '#ffffff',
                    rightnavcolor: '#ffffff',
                    searchbackground: '#ffffff',
                    searchtextcolor: '#666666'
                }
            },
            line: {
                name: '辅助线',
                params: {},
                style: {height: 2, background: '#ffffff', border: "#000000", padding: 10, linestyle: 'solid'}
            },
            blank: {name: '辅助空白', params: {}, style: {height: 20, background: '#ffffff'}},
            menu: {
                name: '按钮组',
                params: {},
                style: {navstyle: '', background: '#ffffff', rownum: 4, showtype: 0, pagenum: 8, showdot: 1,},
                data: {
                    C0123456789101: {
                        imgurl: '../addons/ewei_shopv2/plugin/app/static/images/default/icon-1.png',
                        linkurl: '',
                        text: '按钮文字1',
                        color: '#666666'
                    },
                    C0123456789102: {
                        imgurl: '../addons/ewei_shopv2/plugin/app/static/images/default/icon-2.png',
                        linkurl: '',
                        text: '按钮文字2',
                        color: '#666666'
                    },
                    C0123456789103: {
                        imgurl: '../addons/ewei_shopv2/plugin/app/static/images/default/icon-3.png',
                        linkurl: '',
                        text: '按钮文字3',
                        color: '#666666'
                    },
                    C0123456789104: {
                        imgurl: '../addons/ewei_shopv2/plugin/app/static/images/default/icon-4.png',
                        linkurl: '',
                        text: '按钮文字4',
                        color: '#666666'
                    }
                }
            },
            menu2: {
                name: '按钮组2',
                params: {},
                style: {margintop: 10, background: '#ffffff'},
                data: {
                    C0123456789101: {
                        text: '我的积分',
                        iconclass: '',
                        textcolor: '#666666',
                        iconcolor: '#666666',
                        linkurl: ''
                    },
                    C0123456789102: {
                        text: '兑换记录',
                        iconclass: '',
                        textcolor: '#666666',
                        iconcolor: '#666666',
                        linkurl: ''
                    }
                }
            },
            listmenu: {
                name: '列表导航',
                params: {},
                style: {
                    margintop: 10,
                    background: '#ffffff',
                    iconcolor: '#999999',
                    textcolor: '#000000',
                    remarkcolor: '#888888'
                },
                data: {
                    C0123456789101: {text: '文字1', linkurl: '', iconclass: 'icox-shop', remark: '查看', dotnum: ''},
                    C0123456789102: {text: '文字2', linkurl: '', iconclass: 'icox-shop', remark: '查看', dotnum: ''},
                    C0123456789103: {text: '文字3', linkurl: '', iconclass: 'icox-shop', remark: '查看', dotnum: ''}
                }
            },
            picture: {
                name: '单图组',
                params: {},
                style: {paddingtop: 0, paddingleft: 0, background: '#ffffff'},
                data: {
                    C0123456789101: {
                        imgurl: '../addons/ewei_shopv2/plugin/app/static/images/default/banner-1.jpg',
                        linkurl: '',
                    },
                    C0123456789102: {
                        imgurl: '../addons/ewei_shopv2/plugin/app/static/images/default/banner-2.jpg',
                        linkurl: '',
                    }
                }
            },
            picturew: {
                name: '图片橱窗',
                params: {row: 4, showtype: 0, pagenum: 2},
                style: {background: '#ffffff', paddingtop: 0, paddingleft: 0, showdot: 0, showbtn: 0},
                data: {
                    C0123456789101: {
                        imgurl: '../addons/ewei_shopv2/plugin/app/static/images/default/cube-1.jpg',
                        linkurl: ''
                    },
                    C0123456789102: {
                        imgurl: '../addons/ewei_shopv2/plugin/app/static/images/default/cube-2.jpg',
                        linkurl: ''
                    },
                    C0123456789103: {
                        imgurl: '../addons/ewei_shopv2/plugin/app/static/images/default/cube-3.jpg',
                        linkurl: ''
                    },
                    C0123456789104: {
                        imgurl: '../addons/ewei_shopv2/plugin/app/static/images/default/cube-4.jpg',
                        linkurl: ''
                    }
                }
            },
            pictures: {
                name: '图片展播',
                params: {hidetext: 0, showtype: 0, rownum: 3, showbtn: 0},
                style: {
                    background: "#ffffff",
                    paddingtop: "3",
                    paddingleft: "5",
                    titlealign: 'left',
                    textalign: 'left',
                    titlecolor: '#ffffff',
                    textcolor: '#666666'
                },
                data: {
                    C0123456789101: {
                        imgurl: '../addons/ewei_shopv2/plugin/diypage/static/images/default/goods-1.jpg',
                        linkurl: '',
                        title: '这里是上标题',
                        text: '这里是下标题'
                    },
                    C0123456789102: {
                        imgurl: '../addons/ewei_shopv2/plugin/diypage/static/images/default/goods-2.jpg',
                        linkurl: '',
                        title: '这里是上标题',
                        text: '这里是下标题'
                    },
                    C0123456789103: {
                        imgurl: '../addons/ewei_shopv2/plugin/diypage/static/images/default/goods-4.jpg',
                        linkurl: '',
                        title: '这里是上标题',
                        text: '这里是下标题'
                    }
                }
            },
            banner: {
                name: '图片轮播',
                params: {},
                style: {dotstyle: 'round', dotalign: 'center', background: '#ffffff', opacity: '0.8'},
                data: {
                    C0123456789101: {
                        imgurl: '../addons/ewei_shopv2/plugin/app/static/images/default/banner-1.jpg',
                        linkurl: '',
                    },
                    C0123456789102: {
                        imgurl: '../addons/ewei_shopv2/plugin/app/static/images/default/banner-2.jpg',
                        linkurl: '',
                    }
                }
            },
            icongroup: {
                name: '图标组',
                params: {rownum: '4', border: '1', bordertop: '1', borderbottom: '1',},
                style: {
                    background: '#ffffff',
                    bordercolor: '#ffffff',
                    textcolor: '#000000',
                    iconcolor: '#666666',
                    dotcolor: '#ff0011'
                },
                data: {
                    C0123456789101: {iconclass: 'icox-daifukuan1', text: '待付款', linkurl: '', dotnum: 0},
                    C0123456789102: {iconclass: 'icox-daifahuo1', text: '待发货', linkurl: '', dotnum: 0},
                    C0123456789103: {iconclass: 'icox-daishouhuo1', text: '待收货', linkurl: '', dotnum: 0},
                    C0123456789104: {iconclass: 'icox-daituikuan2', text: '退换货', linkurl: '', dotnum: 0}
                }
            },
            audio: {
                name: "音频播放",
                params: {
                    title: "未定义音频信息",
                    subtitle: "副标题",
                    playerstyle: 0,
                    autoplay: 0,
                    loopplay: 0,
                    pausestop: 0,
                    headalign: "left",
                    headtype: "",
                    headurl: "",
                    audiodefaultimg:"../addons/ewei_shopv2/plugin/app/static/images/audio.png",
                },
                style: {
                    background: "#f1f1f1",
                    bordercolor: "#ededed",
                    textcolor: "#333333",
                    subtitlecolor: "#666666",
                    timecolor: "#666666",
                    paddingtop: "0",
                    paddingleft: "0",
                    width: "0"
                }
            },
            coupon: {
                name: '优惠券组',
                params: {couponstyle: '3'},
                style: {background: '#ffffff', margintop: 10, marginleft: 5},
                data: {
                    C0123456789101: {
                        name: "优惠券名称",
                        desc: "满100元可用",
                        price: "89.90",
                        couponid: "",
                        couponcolor: '#55b5ff'
                    },
                    C0123456789102: {
                        name: "优惠券名称",
                        desc: "满100元可用",
                        price: "89.90",
                        couponid: "",
                        couponcolor: '#ff5555'
                    },
                    C0123456789103: {
                        name: "优惠券名称",
                        desc: "满100元可用",
                        price: "89.90",
                        couponid: "",
                        couponcolor: '#ff913f'
                    }
                }
            },
            richtext: {name: '富文本', params: {content: ''}, style: {background: '#ffffff', padding: 0}},
            goods: {
                name: '商品组',
                params: {
                    showtitle: 1,
                    showprice: 1,
                    goodsdata: 0,
                    cateid: '',
                    catename: '',
                    groupid: '',
                    groupname: '',
                    goodssort: 0,
                    goodsscroll: 0,
                    goodsnum: 6,
                    showicon: 1,
                    iconposition: 'left top',
                    productprice: 1,
                    showproductprice: 0,
                    showsales: 0,
                    productpricetext: '原价',
                    salestext: '销量',
                    productpriceline: 0,
                    saleout: 0,
                    seecommission:0,
                    cansee : 0,
                    seetitle: '',
                    pagetype: modal.page.type,
                },
                style: {
                    background: '#f3f3f3',
                    liststyle: 'block',
                    buystyle: 'buybtn-1',
                    goodsicon: 'recommand',
                    iconstyle: 'triangle',
                    pricecolor: '#ff5555',
                    productpricecolor: '#666666',
                    iconpaddingtop: '0',
                    iconpaddingleft: '0',
                    buybtncolor: '#ff5555',
                    iconzoom: '100',
                    titlecolor: '#000000',
                    tagbackground: '#fe5455',
                    productpricecolor: '#999999',
                    salescolor: '#999999'
                },
                data: {
                    C0123456789101: {
                        thumb: '../addons/ewei_shopv2/plugin/app/static/images/default/goods-1.jpg',
                        price: '20.00',
                        productprice: '99.00',
                        title: '这里是商品标题',
                        sales: 0,
                        gid: '',
                        ctype: 1
                    },
                    C0123456789102: {
                        thumb: '../addons/ewei_shopv2/plugin/app/static/images/default/goods-2.jpg',
                        price: '20.00',
                        productprice: '99.00',
                        title: '这里是商品标题',
                        sales: 0,
                        gid: '',
                        ctype: 1
                    },
                    C0123456789103: {
                        thumb: '../addons/ewei_shopv2/plugin/app/static/images/default/goods-3.jpg',
                        price: '20.00',
                        productprice: '99.00',
                        sales: 0,
                        title: '这里是商品标题',
                        gid: '',
                        ctype: 0
                    },
                    C0123456789104: {
                        thumb: '../addons/ewei_shopv2/plugin/app/static/images/default/goods-4.jpg',
                        price: '20.00',
                        productprice: '99.00',
                        sales: 0,
                        title: '这里是商品标题',
                        gid: '',
                        ctype: 0
                    }
                }
            },
            video: {
                name: '视频组',
                style: {
                    ratio: 0
                },
                params: {
                    videourl: '',
                    poster: ''
                }
            },
            copyright: {
                name: '版权',
                isbottom: 1,
                max: 1,
                style: {
                    showtype: 0
                },
                params: {
                    showimg: '1',
                    copyright: '请填写版权说明',
                    imgurl: '../addons/ewei_shopv2/plugin/app/static/images/default/copyright.png'
                }
            },
            tabbar: {
                name: '选项卡',
                style: {
                    background: '#ffffff',
                    color: '#666666',
                    activebackground: '#ffffff',
                    activecolor: '#ef4f4f',
                    scrollnum: 5,
                    showtype: 1
                },
                data: {
                    C0123456789101: {
                        text: '选项',
                        linkurl: ''
                    },
                    C0123456789102: {
                        text: '选项',
                        linkurl: ''
                    },
                    C0123456789103: {
                        text: '选项',
                        linkurl: ''
                    },
                    C0123456789104: {
                        text: '选项',
                        linkurl: ''
                    },
                    C0123456789105: {
                        text: '选项',
                        linkurl: ''
                    }
                }
            },
            topmenu:{
                name: '顶部菜单',
                istop: 1,
                max: 1,
                only:'toptab',
                global: true,
                style: {
                    background: '#ffffff',
                    color: '#666666',
                    activebackground: '#ffffff',
                    activecolor: '#ef4f4f',
                    scrollnum: 5,
                    showtype: 1
                },
                params: {
                    datatype: null
                },
                data: {
                    C0123456789101: {
                        text: '选项',
                        linkurl: '',
                    },
                    C0123456789102: {
                        text: '选项',
                        linkurl: '',
                    },
                    C0123456789103: {
                        text: '选项',
                        linkurl: '',
                    },
                    C0123456789104: {
                        text: '选项',
                        linkurl: '',
                    },
                    C0123456789105: {
                        text: '选项',
                        linkurl: '',
                    }
                }
            },
            member:{
                type: 3,
                name:'会员信息',
                params:{
                    style:'default1',
                    leftnav : '充值',
                    rightnav : '兑换',
                    /*seticon : 'icon-edit'*/
                },
                style:{
                    background : '#fe5455',
                    textcolor : '#ffffff',
                    textlight : '#fef31f',
                    headstyle : '',
                }


            },
            bindmobile:{
                type: 3,
                name:'绑定手机',
                style:{
                    margintop:'9',
                    titlecolor:'#ff0011',
                    textcolor:'#999999',
                    iconcolor:'#999999'
                },
                params:{
                    title:'绑定手机号',
                    text:'如果您用手机号注册过会员或您想通过微信外购物请绑定您的手机号码',
                    iconclass:'icon-shouji',
                }
            },
            logout:{
                type: 3,
                name:'退出登录',
                style:{
                    margintop:'10',
                    subcolor:'#ffffff',
                    maincolor:'#ff5555'
                },
                params:{

                }
            },
            verify:{
                type: 3,
                name:'待使用商品',
                style:{
                    titlebg:'#ffffff',
                    titlecolor:'#333333',
                    remarkcolor:'#888888',
                    background:'#ffffff'
                },
                params:{
                    iconclass:'icon-list',
                    style:'',
                    title:'待使用商品',
                    remark:''
                }
            },
            detail_swipe:{
                name: "商品图",
                type: 4,
                max: 1,
                params: {},
                style: {
                    dotstyle: 'rectangle',
                    dotalign: 'left',
                    background: '#ffffff',
                    leftright: '5',
                    bottom: '5',
                    opacity: '0.8'
                },
            },
            detail_seckill:{
                name: "秒杀条",
                type: 4,
                max: 1,
                params: {},
                style: {
                    theme: 'red'
                },
            },
            detail_info: {
                name: "商品信息",
                type: 4,
                max: 1,
                params: {hideshare: '0', share: "分享", share_link: "", share_icon: "icon-share",},
                style: {
                    margintop: 0,
                    marginbottom: 0,
                    background: "#ffffff",
                    titlecolor: "#000000",
                    subtitlecolor: "#999999",
                    pricecolor: "#ff5555",
                    textcolor: "#cccccc",
                    timecolor: "#fff2e2",
                    timetextcolor: "#ef4f4f",

                }
            },
            detail_sale: {
                name: "营销信息",
                type: 4,
                max: 1,
                params: {},
                style: {
                    margintop: 0,
                    marginbottom: 0,
                    background: "#ffffff",
                    textcolor: "#666666",
                    textcolorhigh: "#ef4f4f"
                },
                data: {
                    C0123456789100: {name: "商品预售", type: "yushou"},
                    C0123456789101: {name: "二次购买", type: "erci"},
                    C0123456789102: {name: "会员价", type: "huiyuan"},
                    C0123456789103: {name: "优惠", type: "youhui"},
                    C0123456789104: {name: "积分", type: "jifen"},
                    C0123456789105: {name: "不配送区域", type: "bupeisong"},
                    C0123456789106: {name: "商品标签", type: "biaoqian"},
                    C0123456789107: {name: "可用优惠券", type: "coupon"},
                    C0123456789108: {name: "赠品", type: "zengpin"},
                    C0123456789108: {name: "全返", type: "fullback"}
                }
            },
            detail_spec: {
                name: "商品规格",
                type: 4,
                max: 1,
                params: {},
                style: {background: "#ffffff", textcolor: "#333333", margintop: 10, marginbottom: 0}
            },
            detail_shop: {
                name: "店铺信息",
                type: 4,
                max: 1,
                params: {
                    shoplogo: "../addons/ewei_shopv2/static/images/designer.jpg",
                    shopname: "",
                    shopdesc: "",
                    hidenum: 0,
                    leftnavtext: "全部商品",
                    leftnavlink: "",
                    rightnavtext: "进店逛逛",
                    rightnavlink: "",
                },
                style: {
                    margintop: 10,
                    marginbottom: 0,
                    background: "#ffffff",
                    goodsnumcolor: "#333333",
                    goodstextcolor: "#7c7c7c",
                    rightnavcolor: "#ff5555",
                    shopnamecolor: "#333333",
                    shopdesccolor: "#444444"
                }
            },
            detail_comment: {
                name: "商品评价",
                type: 4,
                max: 0,
                params: {},
                style: {
                    margintop: 10,
                    marginbottom: 10,
                    background: "#ffffff",
                    maincolor: "#fd5454",
                    subcolor: "#000",
                    textcolor: "#333333",
                }
            },
            detail_buyshow: {
                name: "购买可见",
                type: 4,
                max: 1,
                params: {},
                style: {background: "#ffffff", margintop: 10, marginbottom: 0}
            },
            detail_package: {
                name: "相关套餐",
                type: 4,
                max: 1,
                params: {},
                style: {background: "#ffffff", margintop: 10, marginbottom: 0, textcolor: "#000000"}
            },
            detail_navbar: {
                name: "底部导航",
                type: 4,
                max: 1,
                params: {
                    hidelike: 0,
                    hideshop: 0,
                    hidecart: 0,
                    hidecartbtn: 0,
                    textbuy: "立刻购买",
                    goodstext: "商品",
                    liketext: "关注",
                    likeiconclass: "icon-like",
                    likelink: "icon-like",
                    shoptext: "店铺",
                    shopiconclass: "icon-shop",
                    carttext: "购物车",
                    carticonclass: "icon-cart"
                },
                style: {
                    background: "#ffffff",
                    textcolor: "#999999",
                    iconcolor: "#999999",
                    cartcolor: "#fe9402",
                    buycolor: "#fd5555",
                    dotcolor: "#ff0011"
                }
            },
            seckillgroup: {
                max: 1,
                name: "秒杀组",
                params: {
                    iconurl: '../addons/ewei_shopv2/plugin/diypage/static/images/default/seckill.png',
                    hideborder: 0,
                    tag: ''
                },
                style: {
                    margintop: '10',
                    titlecolor: '#ff3300',
                    marketpricecolor: '#ef4f4f',
                    productpricecolor: '#999999',
                }
            },
            seckill_times: {
                name: "秒杀时间段",
                noEdit: true,
                max: 1,
                type: 5
            },
            seckill_rooms: {
                name: "秒杀会场",
                noEdit: true,
                max: 1,
                type: 5
            },
            seckill_advs: {
                name: "秒杀广告",
                data: {
                    C0123456789101: {
                        imgurl: '../addons/ewei_shopv2/plugin/app/static/images/default/goods-1.jpg',
                        linkurl: '',
                    },
                    C0123456789102: {
                        imgurl: '../addons/ewei_shopv2/plugin/app/static/images/default/goods-2.jpg',
                        linkurl: '',
                    },
                    C0123456789103: {
                        imgurl: '../addons/ewei_shopv2/plugin/app/static/images/default/goods-3.jpg',
                        linkurl: '',
                    }
                },
                max: 1,
                type: 5
            },
            seckill_list: {
                name: "秒杀商品",
                noEdit: true,
                max: 1,
                type: 5
            },
        }
    };


    modal.initClick = function () {
        $(".btn-save").unbind('click').click(function () {
            var type = $(this).data('type');
            var id = $(this).data('id');
            if ($(this).attr('stop')) {
                tip.msgbox.err("正在保存，请稍候...");
                return
            }
            if (type == 'isdefault') {
                if( id == 2 ){
                    var name = '首页';
                }else if(id == 3){
                    var name = '会员中心';
                }else{
                    var name = '商品详情';
                }
                tip.confirm('确定要保存并设为默认'+name+'吗?', function () {
                    modal.save(true , id)
                })
            } else if (type == 'save') {
                modal.save()
            }else if(type == 'cancel_default'){
                modal.cancel_default();
            }
        });
        $("#page").unbind('click').click(function () {
            if (modal.selected == 'page') {
                return
            }
            ;
            modal.selected = 'page';
            modal.initPage()
        })
    };
    modal.initSortable = function () {
        $("#phone").sortable({
            opacity: 0.8,
            placeholder: "highlight",
            items: '.drag:not(.fixed)',
            revert: 100,
            scroll: false,
            start: function (event, ui) {
                var height = ui.item.height();
                $(".highlight").css({"height": height + "px"});
                $(".highlight").html('<div><i class="fa fa-plus"></i> 放置此处</div>');
                $(".highlight div").css({"line-height": height - 4 + "px"})
            },
            stop: function (event, ui) {
                modal.initEditor()
            },
            update: function (event, ui) {
                modal.sortItems()
            }
        });
        $("#phone").disableSelection();
        $(document).on('mousedown', "#phone .drag", function () {
            if ($(this).hasClass("selected")) {
                return
            }
            modal.selected = $(this).data('itemid');
            $("#phone").find(".drag").removeClass("selected");
            $(this).addClass("selected");
            modal.selected = $(this).data('itemid');
            modal.initEditor()
        })
    };
    modal.initSortableChild = function () {
        $("#diy-editor .inner").sortable({
            opacity: 0.8,
            placeholder: "highlight",
            items: '.item',
            revert: 100,
            scroll: false,
            cancel: '.goods-selector,input,select,.btn,btn-del',
            start: function (event, ui) {
                var height = ui.item.height();
                $(".highlight").css({"height": height + 22 + "px"});
                $(".highlight").html('<div><i class="fa fa-plus"></i> 放置此处</div>');
                $(".highlight div").css({"line-height": height + 16 + "px"})
            },
            update: function (event, ui) {
                modal.sortChildItems()
            }
        })
    };
    modal.sortItems = function () {
        var newItems = {};
        $("#phone .drag").each(function () {
            var thisid = $(this).data('itemid');
            newItems[thisid] = modal.items[thisid]
        });
        modal.items = newItems
    };
    modal.sortChildItems = function () {
        var newChild = {};
        var itemid = modal.selected;
        $("#diy-editor .form-items .item").each(function () {
            var thisid = $(this).data('id');
            newChild[thisid] = modal.items[itemid].data[thisid]
        });
        modal.items[itemid].data = newChild;
        modal.initItems(itemid)
    };
    modal.initEditor = function (scroll, activetab) {
        if (typeof(scroll) === 'undefined') {
            scroll = true
        }
        var itemid = modal.selected;
        var top = 180;
        if (modal.selected != 'page') {
            var stop = $(".phone-main").children(".selected").position().top;
            top = stop ? stop : 0;
            if ($('.wb-header').length > 0) {
                top += 210
            } else {
                top -= 30
            }
        }
        if (scroll) {
            console.log(scroll);
            console.log(top - 130 );
            $("#diy-editor").unbind('animate').animate({"margin-top": top - 130 + "px"});
            setTimeout(function () {
                $("body").unbind('animate').animate({scrollTop: top - 130 + "px"}, 1000)
            }, 1000)
        }
        if (modal.selected) {
            if (modal.selected == 'page') {
                var html = tpl("tpl_edit_page", modal);
                $("#diy-editor .inner").html(html);
                $("#diy-editor").attr("data-editid", modal.selected).show()
                $("#diy-editor").css('opacity',1);
            } else {
                var item = $.extend(true, {}, modal.items[modal.selected]);
                item.itemid = modal.selected;
                item.merch = modal.merch;
                item.plugins = modal.plugins;
                if(!item.noEdit){
                    var html = tpl("tpl_edit_" + item.id, item);
                    $("#diy-editor .inner").html(html);
                    $("#diy-editor").attr("data-editid", modal.selected).show();
                    $("#diy-editor").css('opacity',1);
                }else{
                    $("#diy-editor").css('opacity',0);
                }
            }
        }
        if ($("#diy-editor .slider").length > 0) {
            $("#diy-editor .slider").each(function () {
                var decimal = $(this).data('decimal');
                var multiply = $(this).data('multiply');
                var defaultValue = $(this).data("value");
                if (decimal) {
                    defaultValue = defaultValue * decimal
                }
                $(this).slider({
                    slide: function (event, ui) {
                        var sliderValue = ui.value;
                        if (decimal) {
                            sliderValue = sliderValue / decimal
                        }
                        $(this).siblings(".input").val(sliderValue).trigger("propertychange");
                        $(this).siblings(".count").find("span").text(sliderValue)
                    }, value: defaultValue, min: $(this).data("min"), max: $(this).data("max")
                })
            })
        }
        if ($("#diy-editor .coupon-selector").length > 0) {
            var _this = $("#diy-editor .coupon-selector");
            var url = biz.url('sale/coupon/query', {diy: 1}, modal.merch);
            _this.attr({'id': 'coupon_selector', 'data-url': url, 'data-callback': 'callbackCoupon'});
            _this.unbind('click').click(function () {
                biz.selector.select({name: 'coupon', autosearch: 1, url: url});
                modal.childid = $(this).closest('.item').data('id')
            })
        }
        if ($("#diy-editor .goods-selector").length > 0) {
            var _this = $("#diy-editor .goods-selector");
            var pType = _this.data('pagetype') == 2 ? 2: 0;
            var platform = 'wxapp';
            _this.unbind('click').click(function () {
                modal.childid = $(this).closest('.item').data('id');
                gSelector.open('callbackGoods', pType, modal.merch,'','','','',platform);
            });
            /*
             _this.attr({'id': 'goods_selector', 'data-url': url, 'data-callback': 'callbackGoods'});
             _this.unbind('click').click(function () {
             biz.selector.select({name: 'goods', autosearch: 1, url: url});
             modal.childid = $(this).closest('.item').data('id')
             })*/
        }
        if ($("#diy-editor .category-selector").length > 0) {
            var _this = $("#diy-editor .category-selector");
            var url = biz.url('goods/category/query', null, modal.merch);
            _this.attr({'id': 'category_selector', 'data-url': url, 'data-callback': 'callbackCategory'});
            _this.unbind('click').click(function () {
                biz.selector.select({name: 'category', autosearch: 1, url: url})
            })
        }
        if ($("#diy-editor .group-selector").length > 0) {
            var _this = $("#diy-editor .group-selector");
            var url = biz.url('goods/group/query', null, modal.merch);
            _this.attr({'id': 'group_selector', 'data-url': url, 'data-callback': 'callbackGroup'});
            _this.unbind('click').click(function () {
                biz.selector.select({name: 'group', autosearch: 1, url: url})
            })
        }
        if ($("#diy-editor .form-items").length > 0) {
            modal.initSortableChild();
            $("#addChild").unbind('click').click(function () {
                var itemid = modal.selected;
                var type = modal.items[itemid].id;
                var temp = modal.navs[type].data;
                var max = $(this).closest(".form-items").data('max');
                if (max) {
                    var length = modal.length(modal.items[itemid].data);
                    if (length >= max) {
                        tip.msgbox.err("最大添加 " + max + " 个！");
                        return
                    }
                }
                var newChild = {};
                var index = 0;
                $.each(temp, function (i, t) {
                    if (index == 0) {
                        newChild = t;
                        index++
                    }
                });
                if (newChild) {
                    var childName = modal.getId("M", 0);
                    if (typeof(modal.items[itemid].data) === 'undefined') {
                        modal.items[itemid].data = {}
                    }
                    newChild = $.extend(true, {}, newChild);
                    modal.items[itemid].data[childName] = newChild
                }
                modal.initItems(itemid);
                modal.initEditor(false)
            });
            $("#diy-editor .form-items .item .btn-del").unbind('click').click(function () {
                var childid = $(this).closest(".item").data('id');
                var itemid = modal.selected;
                var min = $(this).closest(".form-items").data("min");
                if (min) {
                    var length = modal.length(modal.items[itemid].data);
                    if (length <= min) {
                        tip.msgbox.err("至少保留 " + min + " 个！");
                        return
                    }
                }
                tip.confirm("确定删除吗", function () {
                    delete modal.items[itemid].data[childid];
                    modal.initItems(itemid);
                    modal.initEditor(false)
                })
            })
        }
        if ($('#diy-editor .nav-tabs').length > 0) {
            if (activetab) {
                $('#diy-editor .nav-tabs a[data-tab=' + activetab + ']').closest('li').addClass('active').siblings().removeClass('active');
                $('#diy-editor .tab-content').hide();
                $('#diy-editor .tab-content[data-tab=' + activetab + ']').show()
            }
            $('#diy-editor .nav-tabs a').click(function () {
                $(this).closest('li').addClass('active').siblings().removeClass('active');
                var tab = $(this).data('tab');
                $('#diy-editor .tab-content').hide();
                $('#diy-editor .tab-content[data-tab=' + tab + ']').show()
            });
            var navtabs = true
        } else {
            var navtabs = false
        }
        modal.initRichtext(itemid);
        $("#diy-editor").find(".diy-bind").bind('input propertychange change', function () {
            var _this = $(this);
            var bind = _this.data("bind");
            var bindchild = _this.data('bind-child');
            var bindparent = _this.data('bind-parent');
            var initEditor = _this.data('bind-init');
            var value = '';
            var tag = this.tagName;
            if (!itemid) {
                modal.selectedItem('page')
            }
            if (tag == 'INPUT') {
                var type = _this.attr('type');
                if (type == 'checkbox') {
                    value = [];
                    _this.closest('.form-group').find('input[type=checkbox]').each(function () {
                        var checked = this.checked;
                        var valname = $(this).val();
                        if (checked) {
                            value.push(valname)
                        }
                    })
                } else {
                    var placeholder = _this.data('placeholder');
                    value = _this.val();
                    value = value == '' ? placeholder : value
                }
            } else if (tag == 'SELECT') {
                value = _this.find('option:selected').val()
            } else if (tag == 'TEXTAREA') {
                value = _this.val()
            }
            value = $.trim(value);
            if(bindchild=='seckill'){
                if(bind=='style'){
                    if(value =='style2'){
                        modal.page.titlebarbg = $('.swiper-slide.room-slide.selected').css('color')
                    }else{
                        modal.page.titlebarbg = '#ffffff'
                    }
                }
                if(bind=='color'){
                    if(modal.page.seckill.style =='style2'){
                        var color ='';
                        switch(value)
                        {
                            case 'blue':
                                color = '#4e87ee'
                                break;
                            case 'purple':
                                color = '#a839fa'
                                break;
                            case 'orange':
                                color = '#ff8c1e'
                                break;
                            case 'pink':
                                color = '#ff7e95'
                                break;
                            case 'red':
                                color = '#ff5555'
                                break;
                            default:
                                color = '#ffffff'
                        }
                        modal.page.titlebarbg = color;
                    }else{
                    }
                }
            }
            if (itemid == 'page') {
                if (bindchild) {
                    if (!modal.page[bindchild]) {
                        modal.page[bindchild] = {}
                    }
                    modal.page[bindchild][bind] = value
                } else {
                    modal.page[bind] = value
                }
                modal.initPage(false)
            } else {
                if (bindchild) {
                    if (bindparent) {
                        modal.items[itemid][bindparent][bindchild][bind] = value
                    } else {
                        modal.items[itemid][bindchild][bind] = value
                    }
                } else {
                    modal.items[itemid][bind] = value
                }
                modal.initItems(itemid)
            }
            if (initEditor) {
                var activetab = false;
                if (navtabs) {
                    activetab = $('#diy-editor .nav-tabs li.active a').data('tab') || false
                }
                modal.initEditor(false, activetab)
            }
        });
        $("#diy-editor").find('[data-toggle="resetColor"]').bind('click', function () {
            var color = $(this).data('color') || '#000000';
            $(this).prev().val(color).trigger('propertychange')
        });
        $("#diy-editor").find('[data-toggle="setNull"]').bind('click', function () {
            var element = $(this).data('element');
            $(element).val('').trigger('propertychange')
        });
        $("#diy-editor").find('[data-toggle="selectIcon3"]').unbind('click').bind('click', function () {
            var _element = $(this).data('element');
            var _input = $(this).data('input');
            if (!_input && !_element) {
                return
            }
            var url = biz.url('app/page/selecticon3');
            $.ajax(url, {type: "get", dataType: "html", cache: false}).done(function (html) {
                var modal3 = $("#selectIcon3");
                if(modal3.length){
                    modal3.modal('show')
                }else{
                    console.log(modal3);
                    $(document.body).append($('<div class="modal fade" id="selectIcon3"></div>')), modal3.modal('show');
                }
                modal3.append2(html, function () {
                    $(document).off("click", '#selectIcon3 nav').on("click", '#selectIcon3 nav', function () {
                        var _class = $.trim($(this).data("class"));
                        if (_input) {
                            $(_input).val(_class).trigger('change')
                        }
                        if (_element) {
                            $(_element).removeAttr("class").addClass("icox " + _class)
                        }
                        modal3.find(".close").click()
                    })
                })
            })
        })
    };
    modal.initRichtext = function (itemid) {
        if ($("#diy-editor .form-richtext").length > 0 && itemid) {
            var ueditoroption = {
                'autoClearinitialContent': false,
                'toolbars': [['fullscreen', 'source', 'preview', '|', 'bold', 'italic', 'underline', 'strikethrough', 'forecolor', 'backcolor', '|', 'justifyleft', 'justifycenter', 'justifyright', '|', 'insertorderedlist', 'insertunorderedlist', 'blockquote', 'emotion', 'removeformat', '|', 'rowspacingtop', 'rowspacingbottom', 'lineheight', 'indent', 'paragraph', 'fontsize', '|', 'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol', 'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols', '|', 'drafts', '|']],
                'elementPathEnabled': false,
                'initialFrameHeight': 300,
                'focus': false,
                'maximumWords': 9999999999999
            };
            console.log(ueditoroption)
            var opts = {
                type: 'image',
                direct: false,
                multiple: true,
                tabs: {'upload': 'active', 'browser': '', 'crawler': ''},
                path: '',
                dest_dir: '',
                global: false,
                thumb: false,
                width: 0
            };
            UE.registerUI('myinsertimage', function (editor, uiName) {
                editor.registerCommand(uiName, {
                    execCommand: function () {
                        require(['fileUploader'], function (uploader) {
                            uploader.show(function (imgs) {
                                if (imgs.length == 0) {
                                    return
                                } else if (imgs.length == 1) {
                                    editor.execCommand('insertimage', {
                                        'src': imgs[0]['url'],
                                        '_src': imgs[0]['url'],
                                        'width': '100%',
                                        'alt': imgs[0].filename
                                    })
                                } else {
                                    var imglist = [];
                                    for (i in imgs) {
                                        imglist.push({
                                            'src': imgs[i]['url'],
                                            '_src': imgs[i]['url'],
                                            'width': '100%',
                                            'alt': imgs[i].filename
                                        })
                                    }
                                    editor.execCommand('insertimage', imglist)
                                }
                            }, opts)
                        })
                    }
                });
                var btn = new UE.ui.Button({
                    name: '插入图片',
                    title: '插入图片',
                    cssRules: 'background-position: -726px -77px',
                    onclick: function () {
                        editor.execCommand(uiName)
                    }
                });
                editor.addListener('selectionchange', function () {
                    var state = editor.queryCommandState(uiName);
                    if (state == -1) {
                        btn.setDisabled(true);
                        btn.setChecked(false)
                    } else {
                        btn.setDisabled(false);
                        btn.setChecked(state)
                    }
                });
                return btn
            }, 48);
            UE.registerUI('myinsertvideo', function (editor, uiName) {
                editor.registerCommand(uiName, {
                    execCommand: function () {
                        require(['fileUploader'], function (uploader) {
                            uploader.show(function (video) {
                                if (!video) {
                                    return
                                } else {
                                    var videoType = video.isRemote ? 'iframe' : 'video';
                                    editor.execCommand('insertvideo', {
                                        'url': video.url,
                                        'width': 300,
                                        'height': 200
                                    }, videoType)
                                }
                            }, {fileSizeLimit: 5120000, type: 'video', allowUploadVideo: true})
                        })
                    }
                });
                var btn = new UE.ui.Button({
                    // name: '插入视频',
                    // title: '插入视频',
                    // cssRules: 'background-position: -320px -20px',
                    // onclick: function () {
                    //     editor.execCommand(uiName)
                    // }
                });
                editor.addListener('selectionchange', function () {
                    var state = editor.queryCommandState(uiName);
                    if (state == -1) {
                        btn.setDisabled(true);
                        btn.setChecked(false)
                    } else {
                        btn.setDisabled(false);
                        btn.setChecked(state)
                    }
                });
                return btn
            }, 20);
            if (typeof(UE) != 'undefined') {
                UE.delEditor('rich')
            }
            var ue = UE.getEditor('rich', ueditoroption);
            ue.ready(function () {
                var thisitem = modal.items[itemid];
                var richContent = thisitem.params.content;
                richContent = $.base64.decode(richContent);
                ue.setContent(richContent);
                ue.addListener('contentChange', function () {
                    var newContent = ue.getContent();
                    newContent = $.base64.encode(newContent);
                    $("#richtext").html(newContent).trigger('change')
                })
            })
        }
    };
    modal.selectedItem = function (itemid) {
        if (!itemid) {
            return
        }
        modal.selected = itemid;
        if (itemid == 'page') {
            $("#page").trigger('click')
        } else {
            $(".drag[data-itemid='" + itemid + "']").addClass('selected')
        }
    };
    modal.initWindow = function () {
        $(window).bind('scroll resize', function () {
            var scrolltop = $(window).scrollTop();
            if (scrolltop > 300) {
                $("#gotop").show()
            } else {
                $("#gotop").hide()
            }
            $("#gotop").unbind('click').click(function () {
                $('body').animate({scrollTop: "0px"}, 1000)
            })
        })
    };
    modal.getNear = function (itemid) {
        var newarr = [];
        var index = 0;
        var prev = 0;
        var next = 0;
        $.each(modal.items, function (id, obj) {
            newarr[index] = id;
            if (id == itemid) {
                prev = index - 1;
                next = index + 1
            }
            index++
        });
        var pervid = newarr[prev];
        var nextid = newarr[next];
        if (nextid) {
            return nextid
        }
        if (pervid) {
            return pervid
        }
        return false
    };
    modal.getItemNum = function (id) {
        if (!id || !modal.items) {
            return -1
        }
        var itemNum = 0;
        $.each(modal.items, function (itemid, eachitem) {
            if (eachitem.id == id) {
                itemNum++
            }
        });
        return itemNum
    };
    modal.getItemOnlyNum = function (only) {
        if (!only || !modal.items) {
            return -1
        }
        var itemNum = 0;
        $.each(modal.items, function (itemid, eachitem) {
            if (eachitem.only == only) {
                itemNum++
            }
        });
        return itemNum
    };
    modal.callbackGoods = function (data) {
        if (!data) {
            tip.msgbox.err("回调数据错误，请重试！");
            return
        }
        var itemid = modal.selected;
        var childid = modal.childid;
        modal.items[itemid].data[childid] = {
            'title': data.title,
            'thumb': data.thumb,
            'price': data.minprice,
            'gid': data.id,
            'bargain': data.bargain,
            'credit': data.credit,
            'seecommission':data.seecommission,
            'cansee' : data.cansee,
            'seetitle': data.seetitle,
        };
        modal.initItems(itemid);
        modal.initEditor(false);
        modal.childid = null
    };
    modal.callbackCategory = function (data) {
        if (!data) {
            tip.msgbox.err("回调数据错误，请重试！");
            return
        }
        var itemid = modal.selected;
        modal.items[itemid].params.catename = data.name;
        modal.items[itemid].params.cateid = data.id;
        modal.items[itemid].params.groupname = '';
        modal.items[itemid].params.groupid = '';
        modal.initItems(itemid);
        modal.initEditor(false)
    };
    modal.callbackGroup = function (data) {
        if (!data) {
            tip.msgbox.err("回调数据错误，请重试！");
            return
        }
        var itemid = modal.selected;
        modal.items[itemid].params.groupname = data.name;
        modal.items[itemid].params.groupid = data.id;
        modal.items[itemid].params.catename = '';
        modal.items[itemid].params.cateid = '';
        modal.initItems(itemid);
        modal.initEditor()
    };
    modal.callbackCoupon = function (data) {
        if (!data) {
            tip.msgbox.err("回调数据错误，请重试！");
            return
        }
        var itemid = modal.selected;
        var childid = modal.childid;
        modal.items[itemid].data[childid].price = data.values;
        modal.items[itemid].data[childid].desc = data.uselimit;
        modal.items[itemid].data[childid].couponid = data.id;
        modal.items[itemid].data[childid].name = data.couponname;
        modal.initItems(itemid);
        modal.initEditor(false);
        modal.childid = null
    };
    modal.callbackData = function(data){
        if (!data) {
            tip.msgbox.err("回调数据错误，请重试！");
            return
        }
        var itemid = modal.selected;
        var childid = modal.childid;

        var item = modal.items[itemid];
        if(item.id == 'topmenu') {
            modal.items[itemid].params.datatype=data;
        }
        modal.initItems(itemid);
        modal.initEditor(false);
    }
    modal.getId = function (S, N) {
        var date = +new Date();
        var id = S + (date + N);
        return id
    };
    modal.length = function (json) {
        if (typeof(json) === 'undefined') {
            return 0
        }
        var jsonlen = 0;
        for (var item in json) {
            jsonlen++
        }
        return jsonlen
    };
    modal.save = function (isdefault , id) {
        if (typeof(isdefault) === 'undefined') {
            isdefault = false
        }
        modal.data = {page: modal.page, items: modal.items};
        if (!modal.page.title) {
            tip.msgbox.err("页面标题是必填项");
            $("#page").trigger("click");
            return
        }
        $(".btn-save").attr('stop', 1).text("保存中...");
        $.post(biz.url(modal.id > 0 ? 'app/page/edit' : 'app/page/add'), {
            id: modal.id,
            data: modal.data,
            isdefault: isdefault ? 1 : 0
        }, function (ret) {
            if( id == 2 ){
                var name = '首页';
            }else if(id == 3){
                var name = '会员中心';
            }else{
                var name = '商品详情';
            }

            $(".btn-save[data-type='save']").text("仅保存页面").removeAttr('stop');
            $(".btn-save[data-type='isdefault']").text("保存并设为默认"+name+"").removeAttr('stop');
            if (ret.status != 1) {
                tip.msgbox.err(ret.result.message);
                return
            }

            tip.msgbox.suc(isdefault ? '保存成功并设为默认'+name+'！' : '保存成功！');
            if (ret.result.id != modal.id) {
                setTimeout(function () {
                    location.href = biz.url('app/page/edit', {id: ret.result.id})
                }, 500)
            }
            location.reload();
            /*$(".btn-save[data-type='cancel_default']").show();*/
        }, 'json')
    };
    modal.cancel_default = function(){
        $.post(biz.url('app/page/cancel_default'), {
            id: modal.id,
        },function(ret){
            if(ret.status == 1){
                location.reload();
                /*$(".btn-save[data-type='cancel_default']").hide();
                 $(".btn-save[data-type='isdefault']").show();*/
            }
        },'json')
    };
    jQuery.base64 = (function ($) {
        var _PADCHAR = "=", _ALPHA = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/", _VERSION = "1.1";

        function _getbyte64(s, i) {
            var idx = _ALPHA.indexOf(s.charAt(i));
            if (idx === -1) {
                throw"Cannot decode base64"
            }
            return idx
        }

        function _decode_chars(y, x) {
            while (y.length > 0) {
                var ch = y[0];
                if (ch < 0x80) {
                    y.shift();
                    x.push(String.fromCharCode(ch))
                } else if ((ch & 0x80) == 0xc0) {
                    if (y.length < 2)break;
                    ch = y.shift();
                    var ch1 = y.shift();
                    x.push(String.fromCharCode(((ch & 0x1f) << 6) + (ch1 & 0x3f)))
                } else {
                    if (y.length < 3)break;
                    ch = y.shift();
                    var ch1 = y.shift();
                    var ch2 = y.shift();
                    x.push(String.fromCharCode(((ch & 0x0f) << 12) + ((ch1 & 0x3f) << 6) + (ch2 & 0x3f)))
                }
            }
        }

        function _decode(s) {
            var pads = 0, i, b10, imax = s.length, x = [], y = [];
            s = String(s);
            if (imax === 0) {
                return s
            }
            if (imax % 4 !== 0) {
                throw"Cannot decode base64"
            }
            if (s.charAt(imax - 1) === _PADCHAR) {
                pads = 1;
                if (s.charAt(imax - 2) === _PADCHAR) {
                    pads = 2
                }
                imax -= 4
            }
            for (i = 0; i < imax; i += 4) {
                var ch1 = _getbyte64(s, i);
                var ch2 = _getbyte64(s, i + 1);
                var ch3 = _getbyte64(s, i + 2);
                var ch4 = _getbyte64(s, i + 3);
                b10 = (_getbyte64(s, i) << 18) | (_getbyte64(s, i + 1) << 12) | (_getbyte64(s, i + 2) << 6) | _getbyte64(s, i + 3);
                y.push(b10 >> 16);
                y.push((b10 >> 8) & 0xff);
                y.push(b10 & 0xff);
                _decode_chars(y, x)
            }
            switch (pads) {
                case 1:
                    b10 = (_getbyte64(s, i) << 18) | (_getbyte64(s, i + 1) << 12) | (_getbyte64(s, i + 2) << 6);
                    y.push(b10 >> 16);
                    y.push((b10 >> 8) & 0xff);
                    break;
                case 2:
                    b10 = (_getbyte64(s, i) << 18) | (_getbyte64(s, i + 1) << 12);
                    y.push(b10 >> 16);
                    break
            }
            _decode_chars(y, x);
            if (y.length > 0)throw"Cannot decode base64";
            return x.join("")
        }

        function _get_chars(ch, y) {
            if (ch < 0x80)y.push(ch); else if (ch < 0x800) {
                y.push(0xc0 + ((ch >> 6) & 0x1f));
                y.push(0x80 + (ch & 0x3f))
            } else {
                y.push(0xe0 + ((ch >> 12) & 0xf));
                y.push(0x80 + ((ch >> 6) & 0x3f));
                y.push(0x80 + (ch & 0x3f))
            }
        }

        function _encode(s) {
            if (arguments.length !== 1) {
                throw"SyntaxError: exactly one argument required"
            }
            s = String(s);
            if (s.length === 0) {
                return s
            }
            var i, b10, y = [], x = [], len = s.length;
            i = 0;
            while (i < len) {
                _get_chars(s.charCodeAt(i), y);
                while (y.length >= 3) {
                    var ch1 = y.shift();
                    var ch2 = y.shift();
                    var ch3 = y.shift();
                    b10 = (ch1 << 16) | (ch2 << 8) | ch3;
                    x.push(_ALPHA.charAt(b10 >> 18));
                    x.push(_ALPHA.charAt((b10 >> 12) & 0x3F));
                    x.push(_ALPHA.charAt((b10 >> 6) & 0x3f));
                    x.push(_ALPHA.charAt(b10 & 0x3f))
                }
                i++
            }
            switch (y.length) {
                case 1:
                    var ch = y.shift();
                    b10 = ch << 16;
                    x.push(_ALPHA.charAt(b10 >> 18) + _ALPHA.charAt((b10 >> 12) & 0x3F) + _PADCHAR + _PADCHAR);
                    break;
                case 2:
                    var ch1 = y.shift();
                    var ch2 = y.shift();
                    b10 = (ch1 << 16) | (ch2 << 8);
                    x.push(_ALPHA.charAt(b10 >> 18) + _ALPHA.charAt((b10 >> 12) & 0x3F) + _ALPHA.charAt((b10 >> 6) & 0x3f) + _PADCHAR);
                    break
            }
            return x.join("")
        }

        return {decode: _decode, encode: _encode, VERSION: _VERSION}
    }(jQuery));
    return modal
});