<title>套餐配置</title>

<div class="layui-card layadmin-header">
    <div class="layui-breadcrumb" lay-filter="breadcrumb">
        <a lay-href="">主页</a>
        <a><cite>套餐配置</cite></a>
    </div>
</div>

<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-header">套餐配置</div>
        <div class="layui-card-body" style="padding: 15px;">

            <form class="layui-form" action="" lay-filter="component-form-group">

                <!--多图上传-->


                <div class="layui-form-item">
                    <label class="layui-form-label">开通详情图</label>
                    <div class="layui-upload">
                        <button type="button" class="layui-btn" id="test-upload-more-detail">上传图片</button>
                        <blockquote style="margin-left: 110px" class="layui-elem-quote" style="margin-top: 10px;">
                            开通页面详情图片, 尺寸 750 * 500px
                        </blockquote>
                        <div class="layui-upload-list del-image" id="test-upload-normal-intro-detail">
                            <ul></ul>
                        </div>
                    </div>
                </div>

                <div class="layui-form-item" style="margin-bottom: 0">
                    <div class="layui-inline">
                        <label class="layui-form-label">付费套餐</label>
                        <div class="layui-input-inline" style="width: 100px;margin-right: 20px">
                            <input type="text" name="title1" placeholder="套餐名称" autocomplete="off" class="layui-input">
                        </div>
                        <div class="layui-input-inline" style="width: 100px;">
                            <input type="text" name="day1" placeholder="填写天数" autocomplete="off" class="layui-input"
                                   onkeyup="checkNumber(this)">
                        </div>
                        <div class="layui-form-mid">*</div>
                        <div class="layui-input-inline" style="width: 100px;">
                            <input type="text" name="money1" placeholder="填写费用" autocomplete="off" class="layui-input"
                                   onkeyup="checkNumber(this)">
                        </div>
                        <div class="layui-input-inline">
                            = <span class="span_total_1">0</span>元/每人 试用版<br/>(每个公司仅限一次)
                        </div>
                    </div>
                </div>

                <div class="layui-form-item" style="margin-bottom: 0">
                    <div class="layui-inline">
                        <label class="layui-form-label"></label>
                        <div class="layui-input-inline" style="width: 100px;margin-right: 20px">
                            <input type="text" name="title2" placeholder="套餐名称" autocomplete="off" class="layui-input">
                        </div>
                        <div class="layui-input-inline" style="width: 100px;">
                            <input type="text" name="day2" placeholder="填写天数" autocomplete="off" class="layui-input"
                                   onkeyup="checkNumber(this)">
                        </div>
                        <div class="layui-form-mid">*</div>
                        <div class="layui-input-inline" style="width: 100px;">
                            <input type="text" name="money2" placeholder="填写费用" autocomplete="off" class="layui-input"
                                   onkeyup="checkNumber(this)">
                        </div>
                        <div class="layui-input-inline">
                            <span style="display: inline-block;line-height: 38px">= <span class="span_total_2">0</span>元/每人</span>
                        </div>
                    </div>
                </div>

                <div class="layui-form-item" style="margin-bottom: 0">
                    <div class="layui-inline">
                        <label class="layui-form-label"></label>
                        <div class="layui-input-inline" style="width: 100px;margin-right: 20px">
                            <input type="text" name="title3" placeholder="套餐名称" autocomplete="off" class="layui-input">
                        </div>
                        <div class="layui-input-inline" style="width: 100px;">
                            <input type="text" name="day3" placeholder="填写天数" autocomplete="off" class="layui-input"
                                   onkeyup="checkNumber(this)">
                        </div>
                        <div class="layui-form-mid">*</div>
                        <div class="layui-input-inline" style="width: 100px;">
                            <input type="text" name="money3" placeholder="填写费用" autocomplete="off" class="layui-input"
                                   onkeyup="checkNumber(this)">
                        </div>
                        <div class="layui-input-inline">
                            <span style="display: inline-block;line-height: 38px">= <span class="span_total_3">0</span>元/每人</span>
                        </div>
                    </div>
                </div>

                <div class="layui-form-item" style="margin-bottom: 0">
                    <div class="layui-inline">
                        <label class="layui-form-label"></label>
                        <div class="layui-input-inline" style="width: 100px;margin-right: 20px">
                            <input type="text" name="title4" placeholder="套餐名称" autocomplete="off" class="layui-input">
                        </div>
                        <div class="layui-input-inline" style="width: 100px;">
                            <input type="text" name="day4" placeholder="填写天数" autocomplete="off" class="layui-input"
                                   onkeyup="checkNumber(this)">
                        </div>
                        <div class="layui-form-mid">*</div>
                        <div class="layui-input-inline" style="width: 100px;">
                            <input type="text" name="money4" placeholder="填写费用" autocomplete="off" class="layui-input"
                                   onkeyup="checkNumber(this)">
                        </div>
                        <div class="layui-input-inline">
                            <span style="display: inline-block;line-height: 38px">= <span class="span_total_4">0</span>元/每人</span>
                        </div>
                    </div>
                </div>

                <div class="layui-form-item" style="margin-bottom: 0">
                    <div class="layui-inline">
                        <label class="layui-form-label"></label>
                        <div class="layui-input-inline" style="width: 100px;margin-right: 20px">
                            <input type="text" name="title5" placeholder="套餐名称" autocomplete="off" class="layui-input">
                        </div>
                        <div class="layui-input-inline" style="width: 100px;">
                            <input type="text" name="day5" placeholder="填写天数" autocomplete="off" class="layui-input"
                                   onkeyup="checkNumber(this)">
                        </div>
                        <div class="layui-form-mid">*</div>
                        <div class="layui-input-inline" style="width: 100px;">
                            <input type="text" name="money5" placeholder="填写费用" autocomplete="off" class="layui-input"
                                   onkeyup="checkNumber(this)">
                        </div>
                        <div class="layui-input-inline">
                            <span style="display: inline-block;line-height: 38px">= <span class="span_total_5">0</span>元/每人</span>
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label"></label>
                    <div class="layui-input-block">
                        <blockquote class="layui-elem-quote">套餐名称用户小程序端展示给用户看, 天数为购买了此套餐后可以使用的天数, 费用填写此套餐每人每天的费用
                        </blockquote>
                        <blockquote class="layui-elem-quote">如: 套餐名称: 一年, 天数: 365, 费用: 1, 客户购买此套餐, 选择开通5人, 收费为: 天数 * 费用
                            * 人数 ( 365 * 1 * 5 ), 即客户需要支付1825元
                        </blockquote>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">试用开关</label>
                    <div class="layui-input-block">
                        <input type="radio" name="trial_switch" value='1' title="开启">
                        <input type="radio" name="trial_switch" value='0' title="关闭">
                        <blockquote class="layui-elem-quote">关闭该功能, 用户不能在购买页面购买试用套餐</blockquote>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">最小数量</label>
                    <div class="layui-input-block">
                        <input type="number" min="1" name="min_number" required lay-verify="required" autocomplete="off"
                               class="layui-input">
                        <blockquote class="layui-elem-quote">最小开通数量, 填了此项参数后, 开通套餐时最小人数将使用此项设置, 最小值为1</blockquote>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">付费介绍</label>
                    <div class="layui-input-block">
                        <textarea id="introduce" style="display: none;" name="introduce" lay-verify="introduce"></textarea>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">服务协议</label>
                    <div class="layui-input-block">
                        <textarea id="service" style="display: none;" name="service" lay-verify="service"></textarea>
                    </div>
                </div>


                <!--提交数-->

                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button class="layui-btn" lay-submit lay-filter="LAY-filter-demo-form">立即提交</button>
                        <button id="backlist" class="layui-btn layui-btn-primary">返回</button>
                    </div>
                </div>

            </form>

        </div>
    </div>
</div>
<script>
    layui.use(['layer', 'form', 'layedit'], function () {
        //定义表单
        var $ = layui.$
            , admin = layui.admin
            , element = layui.element
            , layer = layui.layer
            , layedit = layui.layedit
            , form = layui.form;

        layer.load();


        layedit.set({
            uploadImage: {
                url: config.url + 'manage_base/base_admin/upload'//上传地址
                , type: 'post' //默认post
            }
        });

        $('.del-image').on('click', '.layui-icon', function () {
            $(this).parents('dd').remove();
        });

        // layui.use('layedit', function () {
        //     layedit = layui.layedit;
        //     var url = config.url + 'base_admin/upload?type=picture';//图片上传路径
        //     index = layedit.build('demo', {
        //         height: 600,
        //         tool: ['left', 'center', 'right'],
        //         uploadImage: {url: url, type: 'post'},
        //     }); //建立编辑器
        // });

        //查询配置
        admin.req({
            type: 'POST',
            url: config.url + 'manage_base/package/index',//数据接口
            done: function (res) {
                if (res.data) {
                    layer.closeAll();
                    //预设元素
                    form.val("component-form-group", {
                        "min_number": res.data.config.min_number,// "name": "value"
                        "title1": res.data.package.title1,// "name": "value"
                        "title2": res.data.package.title2,// "name": "value"
                        "title3": res.data.package.title3,// "name": "value"
                        "title4": res.data.package.title4,// "name": "value"
                        "title5": res.data.package.title5,// "name": "value"
                        "day1": res.data.package.day1,// "name": "value"
                        "day2": res.data.package.day2,// "name": "value"
                        "day3": res.data.package.day3,// "name": "value"
                        "day4": res.data.package.day4,// "name": "value"
                        "day5": res.data.package.day5,// "name": "value"
                        "money1": res.data.package.money1,// "name": "value"
                        "money2": res.data.package.money2,// "name": "value"
                        "money3": res.data.package.money3,// "name": "value"
                        "money4": res.data.package.money4,// "name": "value"
                        "money5": res.data.package.money5,// "name": "value"
                        "service": res.data.config.service,// "name": "value"
                        "introduce": res.data.config.introduce,// "name": "value"
                        "trial_switch": res.data.config.trial_switch,// "name": "value"
                    });

                    $('#service').html(res.data.config.service);
                    $('#introduce').html(res.data.config.introduce);

                    var service_index = layedit.build('service', {
                        height: 400,
                        tool: [  'strong' //加粗
                            ,'italic' //斜体
                            ,'underline' //下划线
                            ,'del' //删除线

                            ,'|' //分割线

                            ,'left' //左对齐
                            ,'center' //居中对齐
                            ,'right' //右对齐
                            // ,'link' //超链接
                            // ,'unlink' //清除链接
                            // ,'face' //表情
                            ,'image' //插入图片
                            // ,'help' //帮助
                        ],
                        // uploadImage: {url: url, type: 'post'},
                    });

                    var introduce_index = layedit.build('introduce', {
                        height: 400,
                        tool: [  'strong' //加粗
                            ,'italic' //斜体
                            ,'underline' //下划线
                            ,'del' //删除线

                            ,'|' //分割线

                            ,'left' //左对齐
                            ,'center' //居中对齐
                            ,'right' //右对齐
                            // ,'link' //超链接
                            // ,'unlink' //清除链接
                            // ,'face' //表情
                            ,'image' //插入图片
                            // ,'help' //帮助
                        ],
                        // uploadImage: {url: url, type: 'post'},
                    });
                    layedit.sync(service_index);
                    layedit.sync(introduce_index);

                    //  计算金额
                    if (res.data.package.title1 != '' && res.data.package.day1 > 0 && res.data.package.money1 > 0) {
                        var total_default = res.data.package.day1 * res.data.package.money1;
                        total_default = total_default.toFixed(2);
                        layui.$('.span_total_1').html(total_default);
                    }
                    if (res.data.package.title2 != '' && res.data.package.day2 > 0 && res.data.package.money2 > 0) {
                        var total_default = res.data.package.day2 * res.data.package.money2;
                        total_default = total_default.toFixed(2);
                        layui.$('.span_total_2').html(total_default);
                    }
                    if (res.data.package.title3 != '' && res.data.package.day3 > 0 && res.data.package.money3 > 0) {
                        var total_default = res.data.package.day3 * res.data.package.money3;
                        total_default = total_default.toFixed(2);
                        layui.$('.span_total_3').html(total_default);
                    }
                    if (res.data.package.title4 != '' && res.data.package.day4 > 0 && res.data.package.money4 > 0) {
                        var total_default = res.data.package.day4 * res.data.package.money4;
                        total_default = total_default.toFixed(2);
                        layui.$('.span_total_4').html(total_default);
                    }
                    if (res.data.package.title5 != '' && res.data.package.day5 > 0 && res.data.package.money5 > 0) {
                        var total_default = res.data.package.day5 * res.data.package.money5;
                        total_default = total_default.toFixed(2);
                        layui.$('.span_total_5').html(total_default);
                    }
                    //自定义验证规则
                    form.verify({
                        service: function(value){
                            layedit.sync(service_index);
                        },
                        introduce: function(value){
                            layedit.sync(introduce_index);
                        }
                    });

                    //图片的回显
                    //多张图片
                    if (res.data.config.upgrade_imgs) {
                        //循环
                        var strs = '';
                        layui.each(res.data.config.upgrade_imgs, function (index, item) {
                            strs += '<dd><i class="layui-icon">&#x1007;</i> ' +
                                '<img  width="100px" src="' + item.path + '"> ' +
                                '<p id="test-upload-demoText-detail"></p>' +
                                '<input type="hidden" name="upgrade_imgs[]" value="' + item.id + '"></dd>';
                        })
                        $('#test-upload-normal-intro-detail ul').append(strs);
                    }


                } else {//没有数据的时候默认值
                    form.val("component-form-group", {});
                }
            }
        });


        //监听提交
        form.on('submit', function (data) {
            layedit.sync('service');
            layedit.sync('introduce');
            //发送请求
            layer.load();
            admin.req({
                type: 'POST',
                url: config.url + 'manage_base/package/edit'//数据接口
                , data: data.field,
                done: function (res) {
                    layer.closeAll();
                    layer.msg('修改成功', {
                        offset: '15px'
                        , icon: 1
                        , time: 1000
                    }, function () {
                        window.location.href = config.html_url + 'manage_base/package/';
                    });
                }
            });
            return false;
        });
    });


    /*上传图片*/
    layui.use(['admin', 'upload'], function () {
        var $ = layui.jquery
            , upload = layui.upload;

        // var sign = 0;

        upload.render({
            elem: '#test-upload-more-detail'
            , url: config.url + 'manage_base/base_admin/upload'//上传地址
            // , multiple: true
            , before: function (obj, obj2) {
                //预读本地文件示例，不支持ie8
                layer.load(0, {
                    offset: 'auto'
                });
                // sign = obj.resetFile.length;
                // console.log(this);
            }
            , done: function (res) {
                //上传完毕
                if (res.code > 0) {
                    return layer.msg('上传失败');
                }
                $('#test-upload-normal-intro-detail ul').empty();
                var str = '<dd><i class="layui-icon">&#x1007;</i> <img  width="100px" src="' + res.data.src + '"> <p id="test-upload-demoText"></p>' +
                    '<input type="hidden" name="upgrade_imgs[]" value="' + res.data.id + '" id="upgrade_imgs"></dd>';
                $('#test-upload-normal-intro-detail ul').append(str);
                layer.closeAll('loading');
            }
        });

        // var createSign = 0;

    });

    //  检查input是不是填写的数字
    function checkNumber(obj) {
        var value = layui.$(obj).val();

        if (isNaN(value)) {
            layer.msg('请填写数字!!!', {
                time: 2000,
            });
            layui.$(obj).val('');
            return false;
        }

        var name = layui.$(obj).context.name;

        var total = 0;
        var tmp = 0;

        switch (name) {
            case 'day1':
                tmp = layui.$("input[name='money1']").val();
                if (tmp != '' && tmp > 0) {
                    total = value * tmp;
                }

                total = total.toFixed(2);
                layui.$('.span_total_1').html(total);
                break;
            case 'day2':
                tmp = layui.$("input[name='money2']").val();
                if (tmp != '' && tmp > 0) {
                    total = value * tmp;
                }

                total = total.toFixed(2);
                layui.$('.span_total_2').html(total);
                break;
            case 'day3':
                tmp = layui.$("input[name='money3']").val();
                if (tmp != '' && tmp > 0) {
                    total = value * tmp;
                }

                total = total.toFixed(2);
                layui.$('.span_total_3').html(total);
                break;
            case 'day4':
                tmp = layui.$("input[name='money4']").val();
                if (tmp != '' && tmp > 0) {
                    total = value * tmp;
                }

                total = total.toFixed(2);
                layui.$('.span_total_4').html(total);
                break;
            case 'day5':
                tmp = layui.$("input[name='money5']").val();
                if (tmp != '' && tmp > 0) {
                    total = value * tmp;
                }

                total = total.toFixed(2);
                layui.$('.span_total_5').html(total);
                break;
            case 'money1':
                tmp = layui.$("input[name='day1']").val();
                if (tmp != '' && tmp > 0) {
                    total = value * 1 * (tmp*1);
                }
                total = total.toFixed(2);
                layui.$('.span_total_1').html(total);
                break;
            case 'money2':
                tmp = layui.$("input[name='day2']").val();
                if (tmp != '' && tmp > 0) {
                    total = value * tmp;
                }

                total = total.toFixed(2);
                layui.$('.span_total_2').html(total);
                break;
            case 'money3':
                tmp = layui.$("input[name='day3']").val();
                if (tmp != '' && tmp > 0) {
                    total = value * tmp;
                }

                total = total.toFixed(2);
                layui.$('.span_total_3').html(total);
                break;
            case 'money4':
                tmp = layui.$("input[name='day4']").val();
                if (tmp != '' && tmp > 0) {
                    total = value * tmp;
                }

                total = total.toFixed(2);
                layui.$('.span_total_4').html(total);
                break;
            case 'money5':
                tmp = layui.$("input[name='day5']").val();
                if (tmp != '' && tmp > 0) {
                    total = value * tmp;
                }

                total = total.toFixed(2);
                layui.$('.span_total_5').html(total);
                break;
        }
    }

</script>