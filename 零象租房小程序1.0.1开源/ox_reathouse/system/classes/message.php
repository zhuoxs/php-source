<?php/** * 模板消息发送 */class Message{    public static  $instance;    public static  function Instance(){        if(!self::$instance) {            self::$instance = new self();        }        return self::$instance;    }    /**     * 发送消息模板     * @param     * array(     *  "touser" => $params['touser'],     *  "template_id" => '', 模板id     *  "page"=>  '',       跳转路径     *  "form_id"=>  '',     * "emphasis_keyword"=>  '',     *  "keyword" => array(     *       "顺丰，     *       "sdhkjhk"，     *   )     * )     * @return array AT0007     */    public function send($params){        $url = "https://api.weixin.qq.com/cgi-bin/message/wxopen/template/send?access_token=".$this->getToken();        $data = array(              "touser" => $params['touser'],              "template_id" => $params['template_id'],              "page"=>  $params['page'],              "form_id"=>  $params['form_id'],              "data"=>  array(              ),              "emphasis_keyword"=>  $params['emphasis_keyword'] ?: '',        );        if(is_array($params['keyword'])){            foreach ($params['keyword'] as $k => $v){                $data['data']['keyword'.($k+1)] = array("value" => $v);            }        }        $result = ihttp_post($url,json_encode($data));        return $result;    }    /**     * 获取token     * @return mixed     * @throws     */    private function getToken()    {        global $_W, $_GPC;        $url = 'https://api.weixin.qq.com/cgi-bin/token';        $result = cache_load("{$_W['uniacid']}_repair_token");        if(is_array($result) && $result['end_time'] > TIMESTAMP){            return $result['access_token'];        }        $query = [            'grant_type' => "client_credential",            'appid' => $_W['uniaccount']['key'],            'secret' => $_W['uniaccount']['secret'],        ];        $result = ihttp_request($url,$query);        $result = json_decode($result['content'],1);        if (isset($result['access_token'])) {            $access_token = $result['access_token'];            $data = [            'access_token' =>    $result['access_token'],            'end_time' => TIMESTAMP +  $result['expires_in'] - 600,            ];            cache_write("{$_W['uniacid']}_repair_token", $data);        }        return $access_token;    }}